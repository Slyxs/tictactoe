(()=>{"use strict";var e={365:(e,t,n)=>{n.d(t,{A:()=>o});var s=n(601),r=n.n(s),i=n(314),a=n.n(i)()(r());a.push([e.id,'/* Remove all Tic-Tac-Toe specific styles */\n\n/* General flex utilities (can be kept if used by ST or other extensions, or removed if not) */\n.flex-container {\n    display: flex;\n}\n.flexFlowColumn {\n    flex-flow: column;\n}\n.flexGap5 { /* Updated from flexGap10 if 5px is preferred for the button */\n    gap: 5px;\n}\n.flexGap10 {\n    gap: 10px;\n}\n.alignItemsCenter {\n    align-items: center;\n}\n/* justifyContentFlexStart, justifyContentFlexEnd, expander, margin0 can be removed if not used elsewhere */\n\n/* Button styling consistency (can be kept for the launch button) */\n.menu_button_icon {\n    padding: 5px 8px;\n}\n\n/* Add any new global styles for Kaplay canvas if necessary, */\n/* but most styling is handled inline in JS for the root element. */\n/* For example, if you want all Kaplay roots to have a specific border: */\n/*\ndiv[id^="kaplay-root-"] {\n    border: 1px solid #444;\n}\n*/\n',""]);const o=a},314:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n="",s=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),s&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),s&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n})).join("")},t.i=function(e,n,s,r,i){"string"==typeof e&&(e=[[null,e,void 0]]);var a={};if(s)for(var o=0;o<this.length;o++){var l=this[o][0];null!=l&&(a[l]=!0)}for(var h=0;h<e.length;h++){var u=[].concat(e[h]);s&&a[u[0]]||(void 0!==i&&(void 0===u[5]||(u[1]="@layer".concat(u[5].length>0?" ".concat(u[5]):""," {").concat(u[1],"}")),u[5]=i),n&&(u[2]?(u[1]="@media ".concat(u[2]," {").concat(u[1],"}"),u[2]=n):u[2]=n),r&&(u[4]?(u[1]="@supports (".concat(u[4],") {").concat(u[1],"}"),u[4]=r):u[4]="".concat(r)),t.push(u))}},t}},601:e=>{e.exports=function(e){return e[1]}},72:e=>{var t=[];function n(e){for(var n=-1,s=0;s<t.length;s++)if(t[s].identifier===e){n=s;break}return n}function s(e,s){for(var i={},a=[],o=0;o<e.length;o++){var l=e[o],h=s.base?l[0]+s.base:l[0],u=i[h]||0,d="".concat(h," ").concat(u);i[h]=u+1;var c=n(d),f={css:l[1],media:l[2],sourceMap:l[3],supports:l[4],layer:l[5]};if(-1!==c)t[c].references++,t[c].updater(f);else{var p=r(f,s);s.byIndex=o,t.splice(o,0,{identifier:d,updater:p,references:1})}a.push(d)}return a}function r(e,t){var n=t.domAPI(t);n.update(e);return function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,r){var i=s(e=e||[],r=r||{});return function(e){e=e||[];for(var a=0;a<i.length;a++){var o=n(i[a]);t[o].references--}for(var l=s(e,r),h=0;h<i.length;h++){var u=n(i[h]);0===t[u].references&&(t[u].updater(),t.splice(u,1))}i=l}}},659:e=>{var t={};e.exports=function(e,n){var s=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!s)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");s.appendChild(n)}},540:e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},56:(e,t,n)=>{e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},825:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var s="";n.supports&&(s+="@supports (".concat(n.supports,") {")),n.media&&(s+="@media ".concat(n.media," {"));var r=void 0!==n.layer;r&&(s+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),s+=n.css,r&&(s+="}"),n.media&&(s+="}"),n.supports&&(s+="}");var i=n.sourceMap;i&&"undefined"!=typeof btoa&&(s+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(i))))," */")),t.styleTagTransform(s,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},113:e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}}},t={};function n(s){var r=t[s];if(void 0!==r)return r.exports;var i=t[s]={id:s,exports:{}};return e[s](i,i.exports,n),i.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var s in t)n.o(t,s)&&!n.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.nc=void 0,(()=>{var e=(()=>{for(var e=new Uint8Array(128),t=0;t<64;t++)e[t<26?t+65:t<52?t+71:t<62?t-4:4*t-205]=t;return t=>{for(var n=t.length,s=new Uint8Array(3*(n-("="==t[n-1])-("="==t[n-2]))/4|0),r=0,i=0;r<n;){var a=e[t.charCodeAt(r++)],o=e[t.charCodeAt(r++)],l=e[t.charCodeAt(r++)],h=e[t.charCodeAt(r++)];s[i++]=a<<2|o>>4,s[i++]=o<<4|l>>2,s[i++]=l<<6|h}return s}})();function t(e,n,s){return n>s?t(e,s,n):Math.min(Math.max(e,n),s)}var s=class e{r=255;g=255;b=255;constructor(e,n,s){this.r=t(e,0,255),this.g=t(n,0,255),this.b=t(s,0,255)}static fromArray(t){return new e(t[0],t[1],t[2])}static fromHex(t){if("number"==typeof t)return new e(t>>16&255,t>>8&255,255&t);if("string"==typeof t){let n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);if(!n)throw new Error("Invalid hex color format");return new e(parseInt(n[1],16),parseInt(n[2],16),parseInt(n[3],16))}throw new Error("Invalid hex color format")}static fromHSL(t,n,s){if(0==n)return new e(255*s,255*s,255*s);let r=(e,t,n)=>(n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+6*(t-e)*n:n<.5?t:n<2/3?e+(t-e)*(2/3-n)*6:e),i=s<.5?s*(1+n):s+n-s*n,a=2*s-i,o=r(a,i,t+1/3),l=r(a,i,t),h=r(a,i,t-1/3);return new e(Math.round(255*o),Math.round(255*l),Math.round(255*h))}static RED=new e(255,0,0);static GREEN=new e(0,255,0);static BLUE=new e(0,0,255);static YELLOW=new e(255,255,0);static MAGENTA=new e(255,0,255);static CYAN=new e(0,255,255);static WHITE=new e(255,255,255);static BLACK=new e(0,0,0);clone(){return new e(this.r,this.g,this.b)}lighten(t){return new e(this.r+t,this.g+t,this.b+t)}darken(e){return this.lighten(-e)}invert(){return new e(255-this.r,255-this.g,255-this.b)}mult(t){return new e(this.r*t.r/255,this.g*t.g/255,this.b*t.b/255)}lerp(t,n){return new e(l(this.r,t.r,n),l(this.g,t.g,n),l(this.b,t.b,n))}toHSL(){let e=this.r/255,t=this.g/255,n=this.b/255,s=Math.max(e,t,n),r=Math.min(e,t,n),i=(s+r)/2,a=i,o=i;if(s==r)i=a=0;else{let l=s-r;switch(a=o>.5?l/(2-s-r):l/(s+r),s){case e:i=(t-n)/l+(t<n?6:0);break;case t:i=(n-e)/l+2;break;case n:i=(e-t)/l+4}i/=6}return[i,a,o]}eq(e){return this.r===e.r&&this.g===e.g&&this.b===e.b}toString(){return`rgb(${this.r}, ${this.g}, ${this.b})`}toHex(){return"#"+((1<<24)+(this.r<<16)+(this.g<<8)+this.b).toString(16).slice(1)}toArray(){return[this.r,this.g,this.b]}};function r(...e){if(0===e.length)return new s(255,255,255);if(1===e.length){if(e[0]instanceof s)return e[0].clone();if("string"==typeof e[0])return s.fromHex(e[0]);if(Array.isArray(e[0])&&3===e[0].length)return s.fromArray(e[0])}else if(2===e.length){if(e[0]instanceof s)return e[0].clone()}else if(3===e.length||4===e.length)return new s(e[0],e[1],e[2]);throw new Error("Invalid color arguments")}var i=(e,t,n)=>s.fromHSL(e,t,n);function a(e){return e*Math.PI/180}function o(e){return 180*e/Math.PI}function l(e,t,n){if("number"==typeof e&&"number"==typeof t)return e+(t-e)*n;if(e instanceof d&&t instanceof d)return e.lerp(t,n);if(e instanceof s&&t instanceof s)return e.lerp(t,n);throw new Error(`Bad value for lerp(): ${e}, ${t}. Only number, Vec2 and Color is supported.`)}function h(e,t,n,s,r){return s+(e-t)/(n-t)*(r-s)}function u(e,n,s,r,i){return t(h(e,n,s,r,i),r,i)}var d=class e{x=0;y=0;constructor(e=0,t=e){this.x=e,this.y=t}static fromAngle(t){let n=a(t);return new e(Math.cos(n),Math.sin(n))}static fromArray(t){return new e(t[0],t[1])}static ZERO=new e(0,0);static ONE=new e(1,1);static LEFT=new e(-1,0);static RIGHT=new e(1,0);static UP=new e(0,-1);static DOWN=new e(0,1);clone(){return new e(this.x,this.y)}add(...t){let n=c(...t);return new e(this.x+n.x,this.y+n.y)}sub(...t){let n=c(...t);return new e(this.x-n.x,this.y-n.y)}scale(...t){let n=c(...t);return new e(this.x*n.x,this.y*n.y)}dist(...e){let t=c(...e);return this.sub(t).len()}sdist(...e){let t=c(...e);return this.sub(t).slen()}static sdist(e,t){let n=e.x-t.x,s=e.y-t.y;return n*n+s*s}len(){return Math.sqrt(this.dot(this))}slen(){return this.dot(this)}unit(){let t=this.len();return 0===t?new e(0):this.scale(1/t)}normal(){return new e(this.y,-this.x)}reflect(e){return this.sub(e.scale(2*this.dot(e)))}project(e){return e.scale(e.dot(this)/e.len())}reject(e){return this.sub(this.project(e))}dot(e){return this.x*e.x+this.y*e.y}static dot(e,t){return e.x*t.x+e.y*t.y}cross(e){return this.x*e.y-this.y*e.x}static cross(e,t){return e.x*t.y-e.y*t.x}angle(...e){let t=c(...e);return o(Math.atan2(this.y-t.y,this.x-t.x))}angleBetween(...e){let t=c(...e);return o(Math.atan2(this.cross(t),this.dot(t)))}lerp(t,n){return new e(l(this.x,t.x,n),l(this.y,t.y,n))}slerp(e,t){let n=this.dot(e),s=this.cross(e),r=Math.atan2(s,n);return this.scale(Math.sin((1-t)*r)).add(e.scale(Math.sin(t*r))).scale(1/s)}isZero(){return 0===this.x&&0===this.y}toFixed(t){return new e(Number(this.x.toFixed(t)),Number(this.y.toFixed(t)))}transform(e){return e.multVec2(this)}eq(e){return this.x===e.x&&this.y===e.y}bbox(){return new _(this,0,0)}toString(){return`vec2(${this.x.toFixed(2)}, ${this.y.toFixed(2)})`}toArray(){return[this.x,this.y]}};function c(...e){if(1===e.length){if(e[0]instanceof d)return new d(e[0].x,e[0].y);if(Array.isArray(e[0])&&2===e[0].length)return new d(...e[0])}return new d(...e)}var f=class e{x=0;y=0;w=1;h=1;constructor(e,t,n,s){this.x=e,this.y=t,this.w=n,this.h=s}scale(t){return new e(this.x+this.w*t.x,this.y+this.h*t.y,this.w*t.w,this.h*t.h)}pos(){return new d(this.x,this.y)}clone(){return new e(this.x,this.y,this.w,this.h)}eq(e){return this.x===e.x&&this.y===e.y&&this.w===e.w&&this.h===e.h}toString(){return`quad(${this.x}, ${this.y}, ${this.w}, ${this.h})`}};function p(e,t,n,s){return new f(e,t,n,s)}var g=class e{a;b;c;d;constructor(e,t,n,s){this.a=e,this.b=t,this.c=n,this.d=s}mul(t){return new e(this.a*t.a+this.b*t.c,this.a*t.b+this.b*t.d,this.c*t.a+this.d*t.c,this.c*t.b+this.d*t.d)}transform(e){return c(this.a*e.x+this.b*e.y,this.c*e.x+this.d*e.y)}get inverse(){let t=this.det;return new e(this.d/t,-this.b/t,-this.c/t,this.a/t)}get transpose(){return new e(this.a,this.c,this.b,this.d)}get eigenvalues(){let e=this.trace/2,t=this.det;return[e+Math.sqrt(e*e-t),e-Math.sqrt(e*e-t)]}eigenvectors(e,t){return 0!=this.c?[[e-this.d,this.c],[t-this.d,this.c]]:0!=this.b?[[this.b,e-this.a],[this.b,t-this.a]]:Math.abs(this.transform(c(1,0)).x-e)<Number.EPSILON?[[1,0],[0,1]]:[[0,1],[1,0]]}get det(){return this.a*this.d-this.b*this.c}get trace(){return this.a+this.d}static rotation(t){let n=Math.cos(t),s=Math.sin(t);return new e(n,s,-s,n)}static scale(t,n){return new e(t,0,0,n)}},m=class e{m11;m12;m13;m21;m22;m23;m31;m32;m33;constructor(e,t,n,s,r,i,a,o,l){this.m11=e,this.m12=t,this.m13=n,this.m21=s,this.m22=r,this.m23=i,this.m31=a,this.m32=o,this.m33=l}static fromMat2(t){return new e(t.a,t.b,0,t.c,t.d,0,0,0,1)}toMat2(){return new g(this.m11,this.m12,this.m21,this.m22)}mul(t){return new e(this.m11*t.m11+this.m12*t.m21+this.m13*t.m31,this.m11*t.m12+this.m12*t.m22+this.m13*t.m32,this.m11*t.m13+this.m12*t.m23+this.m13*t.m33,this.m21*t.m11+this.m22*t.m21+this.m23*t.m31,this.m21*t.m12+this.m22*t.m22+this.m23*t.m32,this.m21*t.m13+this.m22*t.m23+this.m23*t.m33,this.m31*t.m11+this.m32*t.m21+this.m33*t.m31,this.m31*t.m12+this.m32*t.m22+this.m33*t.m32,this.m31*t.m13+this.m32*t.m23+this.m33*t.m33)}get det(){return this.m11*this.m22*this.m33+this.m12*this.m23*this.m31+this.m13*this.m21*this.m32-this.m13*this.m22*this.m31-this.m12*this.m21*this.m33-this.m11*this.m23*this.m32}rotate(e){let t=Math.cos(e),n=Math.sin(e),s=this.m11,r=this.m12;return this.m11=t*this.m11+n*this.m21,this.m12=t*this.m12+n*this.m22,this.m21=t*this.m21-n*s,this.m22=t*this.m22-n*r,this}scale(e,t){return this.m11*=e,this.m12*=e,this.m21*=t,this.m22*=t,this}get inverse(){let t=this.det;return new e((this.m22*this.m33-this.m23*this.m32)/t,(this.m13*this.m32-this.m12*this.m33)/t,(this.m12*this.m23-this.m13*this.m22)/t,(this.m23*this.m31-this.m21*this.m33)/t,(this.m11*this.m33-this.m13*this.m31)/t,(this.m13*this.m21-this.m11*this.m23)/t,(this.m21*this.m32-this.m22*this.m31)/t,(this.m12*this.m31-this.m11*this.m32)/t,(this.m11*this.m22-this.m12*this.m21)/t)}get transpose(){return new e(this.m11,this.m21,this.m31,this.m12,this.m22,this.m32,this.m13,this.m23,this.m33)}},w=class e{m=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];constructor(e){e&&(this.m=e)}static translate(t){return new e([1,0,0,0,0,1,0,0,0,0,1,0,t.x,t.y,0,1])}static scale(t){return new e([t.x,0,0,0,0,t.y,0,0,0,0,1,0,0,0,0,1])}static rotateX(t){t=a(-t);let n=Math.cos(t),s=Math.sin(t);return new e([1,0,0,0,0,n,-s,0,0,s,n,0,0,0,0,1])}static rotateY(t){t=a(-t);let n=Math.cos(t),s=Math.sin(t);return new e([n,0,s,0,0,1,0,0,-s,0,n,0,0,0,0,1])}static rotateZ(t){t=a(-t);let n=Math.cos(t),s=Math.sin(t);return new e([n,-s,0,0,s,n,0,0,0,0,1,0,0,0,0,1])}translate(e){return this.m[12]+=this.m[0]*e.x+this.m[4]*e.y,this.m[13]+=this.m[1]*e.x+this.m[5]*e.y,this.m[14]+=this.m[2]*e.x+this.m[6]*e.y,this.m[15]+=this.m[3]*e.x+this.m[7]*e.y,this}scale(e){return this.m[0]*=e.x,this.m[4]*=e.y,this.m[1]*=e.x,this.m[5]*=e.y,this.m[2]*=e.x,this.m[6]*=e.y,this.m[3]*=e.x,this.m[7]*=e.y,this}rotate(e){e=a(-e);let t=Math.cos(e),n=Math.sin(e),s=this.m[0],r=this.m[1],i=this.m[4],o=this.m[5];return this.m[0]=s*t+r*n,this.m[1]=-s*n+r*t,this.m[4]=i*t+o*n,this.m[5]=-i*n+o*t,this}mult(t){let n=[];for(let e=0;e<4;e++)for(let s=0;s<4;s++)n[4*e+s]=this.m[0+s]*t.m[4*e+0]+this.m[4+s]*t.m[4*e+1]+this.m[8+s]*t.m[4*e+2]+this.m[12+s]*t.m[4*e+3];return new e(n)}multVec2(e){return new d(e.x*this.m[0]+e.y*this.m[4]+this.m[12],e.x*this.m[1]+e.y*this.m[5]+this.m[13])}getTranslation(){return new d(this.m[12],this.m[13])}getScale(){if(0!=this.m[0]||0!=this.m[1]){let e=this.m[0]*this.m[5]-this.m[1]*this.m[4],t=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return new d(t,e/t)}if(0!=this.m[4]||0!=this.m[5]){let e=this.m[0]*this.m[5]-this.m[1]*this.m[4],t=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return new d(e/t,t)}return new d(0,0)}getRotation(){if(0!=this.m[0]||0!=this.m[1]){let e=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return o(this.m[1]>0?Math.acos(this.m[0]/e):-Math.acos(this.m[0]/e))}if(0!=this.m[4]||0!=this.m[5]){let e=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return o(Math.PI/2-(this.m[5]>0?Math.acos(-this.m[4]/e):-Math.acos(this.m[4]/e)))}return 0}getSkew(){if(0!=this.m[0]||0!=this.m[1]){let e=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return new d(Math.atan(this.m[0]*this.m[4]+this.m[1]*this.m[5])/(e*e),0)}if(0!=this.m[4]||0!=this.m[5]){let e=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return new d(0,Math.atan(this.m[0]*this.m[4]+this.m[1]*this.m[5])/(e*e))}return new d(0,0)}invert(){let t=[],n=this.m[10]*this.m[15]-this.m[14]*this.m[11],s=this.m[9]*this.m[15]-this.m[13]*this.m[11],r=this.m[9]*this.m[14]-this.m[13]*this.m[10],i=this.m[8]*this.m[15]-this.m[12]*this.m[11],a=this.m[8]*this.m[14]-this.m[12]*this.m[10],o=this.m[8]*this.m[13]-this.m[12]*this.m[9],l=this.m[6]*this.m[15]-this.m[14]*this.m[7],h=this.m[5]*this.m[15]-this.m[13]*this.m[7],u=this.m[5]*this.m[14]-this.m[13]*this.m[6],d=this.m[4]*this.m[15]-this.m[12]*this.m[7],c=this.m[4]*this.m[14]-this.m[12]*this.m[6],f=this.m[5]*this.m[15]-this.m[13]*this.m[7],p=this.m[4]*this.m[13]-this.m[12]*this.m[5],g=this.m[6]*this.m[11]-this.m[10]*this.m[7],m=this.m[5]*this.m[11]-this.m[9]*this.m[7],w=this.m[5]*this.m[10]-this.m[9]*this.m[6],y=this.m[4]*this.m[11]-this.m[8]*this.m[7],A=this.m[4]*this.m[10]-this.m[8]*this.m[6],x=this.m[4]*this.m[9]-this.m[8]*this.m[5];t[0]=this.m[5]*n-this.m[6]*s+this.m[7]*r,t[4]=-(this.m[4]*n-this.m[6]*i+this.m[7]*a),t[8]=this.m[4]*s-this.m[5]*i+this.m[7]*o,t[12]=-(this.m[4]*r-this.m[5]*a+this.m[6]*o),t[1]=-(this.m[1]*n-this.m[2]*s+this.m[3]*r),t[5]=this.m[0]*n-this.m[2]*i+this.m[3]*a,t[9]=-(this.m[0]*s-this.m[1]*i+this.m[3]*o),t[13]=this.m[0]*r-this.m[1]*a+this.m[2]*o,t[2]=this.m[1]*l-this.m[2]*h+this.m[3]*u,t[6]=-(this.m[0]*l-this.m[2]*d+this.m[3]*c),t[10]=this.m[0]*f-this.m[1]*d+this.m[3]*p,t[14]=-(this.m[0]*u-this.m[1]*c+this.m[2]*p),t[3]=-(this.m[1]*g-this.m[2]*m+this.m[3]*w),t[7]=this.m[0]*g-this.m[2]*y+this.m[3]*A,t[11]=-(this.m[0]*m-this.m[1]*y+this.m[3]*x),t[15]=this.m[0]*w-this.m[1]*A+this.m[2]*x;let v=this.m[0]*t[0]+this.m[1]*t[4]+this.m[2]*t[8]+this.m[3]*t[12];for(let e=0;e<4;e++)for(let n=0;n<4;n++)t[4*e+n]*=1/v;return new e(t)}clone(){return new e([...this.m])}toString(){return this.m.toString()}};function y(e,t,n,s=(e=>-Math.cos(e))){return e+(s(n)+1)/2*(t-e)}var A=2147483648,x=class{seed;constructor(e){this.seed=e}gen(){return this.seed=(1103515245*this.seed+12345)%A,this.seed/A}genNumber(e,t){return e+this.gen()*(t-e)}genVec2(e,t){return new d(this.genNumber(e.x,t.x),this.genNumber(e.y,t.y))}genColor(e,t){return new s(this.genNumber(e.r,t.r),this.genNumber(e.g,t.g),this.genNumber(e.b,t.b))}genAny(...e){if(0===e.length)return this.gen();if(1===e.length){if("number"==typeof e[0])return this.genNumber(0,e[0]);if(e[0]instanceof d)return this.genVec2(c(0,0),e[0]);if(e[0]instanceof s)return this.genColor(r(0,0,0),e[0])}else if(2===e.length){if("number"==typeof e[0]&&"number"==typeof e[1])return this.genNumber(e[0],e[1]);if(e[0]instanceof d&&e[1]instanceof d)return this.genVec2(e[0],e[1]);if(e[0]instanceof s&&e[1]instanceof s)return this.genColor(e[0],e[1])}throw new Error("More than 2 arguments not supported")}},v=new x(Date.now());function b(e){return null!=e&&(v.seed=e),v.seed}function E(...e){return v.genAny(...e)}function M(...e){return Math.floor(E(...e.length>0?e:[2]))}function S(e){return E()<=e}function q(e){for(let t=e.length-1;t>0;t--){let n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e}function k(e,t){return e.length<=t?e.slice():q(e.slice()).slice(0,t)}function B(e){return e[M(e.length)]}function R(e,t){return e.pos.x+e.width>t.pos.x&&e.pos.x<t.pos.x+t.width&&e.pos.y+e.height>t.pos.y&&e.pos.y<t.pos.y+t.height}function C(e,t){let n=function(e,t){if(e.p1.x===e.p2.x&&e.p1.y===e.p2.y||t.p1.x===t.p2.x&&t.p1.y===t.p2.y)return null;let n=(t.p2.y-t.p1.y)*(e.p2.x-e.p1.x)-(t.p2.x-t.p1.x)*(e.p2.y-e.p1.y);if(0===n)return null;let s=((t.p2.x-t.p1.x)*(e.p1.y-t.p1.y)-(t.p2.y-t.p1.y)*(e.p1.x-t.p1.x))/n,r=((e.p2.x-e.p1.x)*(e.p1.y-t.p1.y)-(e.p2.y-e.p1.y)*(e.p1.x-t.p1.x))/n;return s<0||s>1||r<0||r>1?null:s}(e,t);return n?c(e.p1.x+n*(e.p2.x-e.p1.x),e.p1.y+n*(e.p2.y-e.p1.y)):null}function I(e,t){let n=t.p2.sub(t.p1),s=Number.NEGATIVE_INFINITY,r=Number.POSITIVE_INFINITY;if(0!=n.x){let i=(e.pos.x-t.p1.x)/n.x,a=(e.pos.x+e.width-t.p1.x)/n.x;s=Math.max(s,Math.min(i,a)),r=Math.min(r,Math.max(i,a))}if(0!=n.y){let i=(e.pos.y-t.p1.y)/n.y,a=(e.pos.y+e.height-t.p1.y)/n.y;s=Math.max(s,Math.min(i,a)),r=Math.min(r,Math.max(i,a))}return r>=s&&r>=0&&s<=1}function P(e,t){return t.x>e.pos.x&&t.x<e.pos.x+e.width&&t.y>e.pos.y&&t.y<e.pos.y+e.height}function T(e,t){return c(Math.max(e.pos.x,Math.min(t.center.x,e.pos.x+e.width)),Math.max(e.pos.y,Math.min(t.center.y,e.pos.y+e.height))).sdist(t.center)<=t.radius*t.radius}function F(e,t){return H(t,new te(e.points()))}function D(e,t){let n=t.sub(e.p1),s=e.p2.sub(e.p1);if(Math.abs(n.cross(s))>Number.EPSILON)return!1;let r=n.dot(s)/s.dot(s);return r>=0&&r<=1}function O(e,t){let n=e.p2.sub(e.p1),s=n.dot(n),r=e.p1.sub(t.center),i=2*n.dot(r),a=i*i-4*s*(r.dot(r)-t.radius*t.radius);if(s<=Number.EPSILON||a<0)return!1;if(0==a){let e=-i/(2*s);if(e>=0&&e<=1)return!0}else{let e=(-i+Math.sqrt(a))/(2*s),t=(-i-Math.sqrt(a))/(2*s);if(e>=0&&e<=1||t>=0&&t<=1)return!0}return L(t,e.p1)}function U(e,t){if(j(t,e.p1)||j(t,e.p2))return!0;for(let n=0;n<t.pts.length;n++){let s=t.pts[n],r=t.pts[(n+1)%t.pts.length];if(C(e,new Z(s,r)))return!0}return!1}function L(e,t){return e.center.sdist(t)<e.radius*e.radius}function N(e,t){let n=t.pts[t.pts.length-1];for(let s of t.pts){if(O(new Z(n,s),e))return!0;n=s}return!!L(e,t.pts[0])||j(t,e.center)}function H(e,t){for(let n=0;n<e.pts.length;n++)if(U(new Z(e.pts[n],e.pts[(n+1)%e.pts.length]),t))return!0;return!(!e.pts.some((e=>j(t,e)))&&!t.pts.some((t=>j(e,t))))}function j(e,t){let n=!1,s=e.pts;for(let e=0,r=s.length-1;e<s.length;r=e++)s[e].y>t.y!=s[r].y>t.y&&t.x<(s[r].x-s[e].x)*(t.y-s[e].y)/(s[r].y-s[e].y)+s[e].x&&(n=!n);return n}function K(e,t){t=t.sub(e.center);let n=a(e.angle),s=Math.cos(n),r=Math.sin(n),i=t.x*s+t.y*r,o=-t.x*r+t.y*s;return i*i/(e.radiusX*e.radiusX)+o*o/(e.radiusY*e.radiusY)<1}function G(e,t){let n=t.center.sub(e.center),s=a(e.angle),r=Math.cos(s),i=Math.sin(s),o=n.x*r+n.y*i,l=-n.x*i+n.y*r;return K(new ee(c(),e.radiusX+t.radius,e.radiusY+t.radius,0),c(o,l))}function V(e,t){let n=e.toMat2().inverse;return O(t=new Z(n.transform(t.p1.sub(e.center)),n.transform(t.p2.sub(e.center))),new $(c(),1))}function Y(e,t){return X(e,new te(t.points()))}function X(e,t){let n=e.toMat2().inverse;return t=new te(t.pts.map((t=>n.transform(t.sub(e.center))))),N(new $(c(),1),t)}function z(e,t){return t instanceof d?K(e,t):t instanceof $?G(e,t):t instanceof Z?V(e,t):t instanceof _?Y(e,t):t instanceof te?X(e,t):t instanceof ee&&function(e,t){if(e.radiusX===e.radiusY)return G(t,new $(e.center,e.radiusX));if(t.radiusX===t.radiusY)return G(e,new $(t.center,t.radiusX));let n=new m(1/e.radiusX**2,0,0,0,1/e.radiusY**2,0,0,0,-1),s=new m(1/t.radiusX**2,0,0,0,1/t.radiusY**2,0,0,0,-1),r=e.center.x,i=e.center.y,o=t.center.x,l=t.center.y,h=a(e.angle),u=a(t.angle),d=new m(Math.cos(h),-Math.sin(h),r,Math.sin(h),Math.cos(h),i,0,0,1),c=new m(Math.cos(u),-Math.sin(u),o,Math.sin(u),Math.cos(u),l,0,0,1),f=d.inverse,p=c.inverse,g=f.transpose.mul(n).mul(f),w=p.transpose.mul(s).mul(p),y=g.m11,A=g.m12,x=g.m13,v=g.m21,b=g.m22,E=g.m23,M=g.m31,S=g.m32,q=g.m33,k=w.m11,B=w.m12,R=w.m13,C=w.m21,I=w.m22,P=w.m23,T=w.m31,F=w.m32,D=w.m33,O=y*b*q-y*E*S-A*v*q+A*E*M+x*v*S-x*b*M,U=(y*b*D-y*E*F-y*S*P+y*q*I-A*v*D+A*E*T+A*M*P-A*q*C+x*v*F-x*b*T-x*M*I+x*S*C+v*S*R-v*q*B-b*M*R+b*q*k+E*M*B-E*S*k)/O,L=(y*I*D-y*P*F-A*C*D+A*P*T+x*C*F-x*I*T-v*B*D+v*R*F+b*k*D-b*R*T-E*k*F+E*B*T+M*B*P-M*R*I-S*k*P+S*R*C+q*k*I-q*B*C)/O,N=(k*I*D-k*P*F-B*C*D+B*P*T+R*C*F-R*I*T)/O;if(U>=0)return!(-3*L+U**2>0&&3*U*N+L*U**2-4*L**2<0&&-27*N**2+18*N*U*L+U**2*L**2-4*U**3*N-4*L**3>0);return!(-3*L+U**2>0&&-27*N**2+18*N*U*L+U**2*L**2-4*U**3*N-4*L**3>0)}(t,e)}function Q(e,t,n){let s=e,r=n.p1,i=t,a=n.p2.sub(r),o=i.cross(a);if(Math.abs(o)<Number.EPSILON)return null;let l=r.sub(s),h=l.cross(a)/o;if(h<=0||h>=1)return null;let u=l.cross(i)/o;if(u<=0||u>=1)return null;let d=a.normal().unit();return t.dot(d)>0&&(d.x*=-1,d.y*=-1),{point:s.add(i.scale(h)),normal:d,fraction:h}}function W(e,t,n){let s=e,r=n.center,i=t,a=i.dot(i),o=s.sub(r),l=2*i.dot(o),h=l*l-4*a*(o.dot(o)-n.radius*n.radius);if(a<=Number.EPSILON||h<0)return null;if(0==h){let e=-l/(2*a);if(e>=0&&e<=1){let t=s.add(i.scale(e));return{point:t,normal:t.sub(r),fraction:e}}}else{let e=(-l+Math.sqrt(h))/(2*a),t=(-l-Math.sqrt(h))/(2*a),n=null;if(e>=0&&e<=1&&(n=e),t>=0&&t<=1&&(n=Math.min(t,n??t)),null!=n){let e=s.add(i.scale(n));return{point:e,normal:e.sub(r).unit(),fraction:n}}}return null}var J=class e{pt;constructor(e){this.pt=e.clone()}transform(t){return new e(t.multVec2(this.pt))}bbox(){return new _(this.pt,0,0)}area(){return 0}clone(){return new e(this.pt)}collides(e){return function(e,t){return t instanceof d?function(e,t){return e.x===t.x&&e.y===t.y}(t,e.pt):t instanceof $?L(t,e.pt):t instanceof Z?D(t,e.pt):t instanceof _?P(t,e.pt):t instanceof te?j(t,e.pt):t instanceof ee&&K(t,e.pt)}(this,e)}contains(e){return this.pt.eq(e)}raycast(e,t){return null}random(){return this.pt.clone()}},Z=class e{p1;p2;constructor(e,t){this.p1=e.clone(),this.p2=t.clone()}transform(t){return new e(t.multVec2(this.p1),t.multVec2(this.p2))}bbox(){return _.fromPoints(this.p1,this.p2)}area(){return this.p1.dist(this.p2)}clone(){return new e(this.p1,this.p2)}collides(e){return function(e,t){return t instanceof d?D(e,t):t instanceof $?O(e,t):t instanceof Z?null!=C(e,t):t instanceof _?I(t,e):t instanceof te?U(e,t):t instanceof ee&&V(t,e)}(this,e)}contains(e){return this.collides(e)}raycast(e,t){return Q(e,t,this)}random(){return this.p1.add(this.p2.sub(this.p1).scale(E(1)))}},_=class e{pos;width;height;constructor(e,t,n){this.pos=e.clone(),this.width=t,this.height=n}static fromPoints(t,n){return new e(t.clone(),n.x-t.x,n.y-t.y)}center(){return new d(this.pos.x+this.width/2,this.pos.y+this.height/2)}points(){return[this.pos,this.pos.add(this.width,0),this.pos.add(this.width,this.height),this.pos.add(0,this.height)]}transform(e){return new te(this.points().map((t=>e.multVec2(t))))}bbox(){return this.clone()}area(){return this.width*this.height}clone(){return new e(this.pos.clone(),this.width,this.height)}distToPoint(e){return Math.sqrt(this.sdistToPoint(e))}sdistToPoint(e){let t=this.pos,n=this.pos.add(this.width,this.height),s=Math.max(t.x-e.x,0,e.x-n.x),r=Math.max(t.y-e.y,0,e.y-n.y);return s*s+r*r}collides(e){return function(e,t){return t instanceof d?P(e,t):t instanceof $?T(e,t):t instanceof Z?I(e,t):t instanceof _?R(e,t):t instanceof te?F(e,t):t instanceof ee&&Y(t,e)}(this,e)}contains(e){return this.collides(e)}raycast(e,t){return function(e,t,n){let s,r=Number.NEGATIVE_INFINITY,i=Number.POSITIVE_INFINITY;if(0!=e.x){let a=(n.pos.x-e.x)/t.x,o=(n.pos.x+n.width-e.x)/t.x;s=c(-Math.sign(t.x),0),r=Math.max(r,Math.min(a,o)),i=Math.min(i,Math.max(a,o))}if(0!=e.y){let a=(n.pos.y-e.y)/t.y,o=(n.pos.y+n.height-e.y)/t.y;Math.min(a,o)>r&&(s=c(0,-Math.sign(t.y))),r=Math.max(r,Math.min(a,o)),i=Math.min(i,Math.max(a,o))}return i>=r&&r>=0&&r<=1?{point:e.add(t.scale(r)),normal:s,fraction:r}:null}(e,t,this)}random(){return this.pos.add(E(this.width),E(this.height))}},$=class e{center;radius;constructor(e,t){this.center=e.clone(),this.radius=t}transform(e){return new ee(this.center,this.radius,this.radius).transform(e)}bbox(){return _.fromPoints(this.center.sub(c(this.radius)),this.center.add(c(this.radius)))}area(){return this.radius*this.radius*Math.PI}clone(){return new e(this.center,this.radius)}collides(e){return function(e,t){return t instanceof d?L(e,t):t instanceof $?function(e,t){return e.center.sdist(t.center)<(e.radius+t.radius)*(e.radius+t.radius)}(e,t):t instanceof Z?O(t,e):t instanceof _?T(t,e):t instanceof te?N(e,t):t instanceof ee&&G(t,e)}(this,e)}contains(e){return this.collides(e)}raycast(e,t){return W(e,t,this)}random(){return this.center.add(d.fromAngle(E(360)).scale(E(this.radius)))}},ee=class e{center;radiusX;radiusY;angle;constructor(e,t,n,s=0){this.center=e.clone(),this.radiusX=t,this.radiusY=n,this.angle=s}static fromMat2(t){let n=t.inverse,s=n.transpose.mul(n),[r,i]=s.eigenvalues,[a,l]=s.eigenvectors(r,i),[h,u]=[1/Math.sqrt(r),1/Math.sqrt(i)];return h>u?new e(c(),h,u,o(Math.atan2(-a[1],a[0]))):new e(c(),u,h,o(Math.atan2(-l[1],l[0])))}toMat2(){let e=a(this.angle),t=Math.cos(e),n=Math.sin(e);return new g(t*this.radiusX,-n*this.radiusY,n*this.radiusX,t*this.radiusY)}transform(t){if(0==this.angle&&0==t.getRotation())return new e(t.multVec2(this.center),t.m[0]*this.radiusX,t.m[5]*this.radiusY);{let n=this.toMat2(),s=t.getRotation(),r=t.getScale();n=m.fromMat2(n).scale(r.x,r.y).rotate(s).toMat2();let i=e.fromMat2(n);return i.center=t.multVec2(this.center),i}}bbox(){if(0==this.angle)return _.fromPoints(this.center.sub(c(this.radiusX,this.radiusY)),this.center.add(c(this.radiusX,this.radiusY)));{let e=a(this.angle),t=Math.cos(e),n=Math.sin(e),s=this.radiusX*t,r=this.radiusX*n,i=this.radiusY*n,o=this.radiusY*t,l=Math.sqrt(s*s+i*i),h=Math.sqrt(r*r+o*o);return _.fromPoints(this.center.sub(c(l,h)),this.center.add(c(l,h)))}}area(){return this.radiusX*this.radiusY*Math.PI}clone(){return new e(this.center,this.radiusX,this.radiusY,this.angle)}collides(e){return z(this,e)}contains(e){e=e.sub(this.center);let t=a(this.angle),n=Math.cos(t),s=Math.sin(t),r=e.x*n+e.y*s,i=-e.x*s+e.y*n;return r*r/(this.radiusX*this.radiusX)+i*i/(this.radiusY*this.radiusY)<1}raycast(e,t){return function(e,t,n){let s=n.toMat2(),r=s.inverse,i=W(r.transform(e.sub(n.center)),r.transform(t),new $(c(),1));if(i){let r=g.rotation(a(-n.angle)),o=g.scale(n.radiusX,n.radiusY).transform(i.point),l=s.transform(i.point).add(n.center),h=l.dist(e)/t.len();return{point:l,normal:r.transform(c(n.radiusY**2*o.x,n.radiusX**2*o.y)).unit(),fraction:h}}return i}(e,t,this)}random(){return this.center}};var te=class e{pts;constructor(e){if(e.length<3)throw new Error("Polygons should have at least 3 vertices");this.pts=e}transform(t){return new e(this.pts.map((e=>t.multVec2(e))))}bbox(){let e=c(Number.MAX_VALUE),t=c(-Number.MAX_VALUE);for(let n of this.pts)e.x=Math.min(e.x,n.x),t.x=Math.max(t.x,n.x),e.y=Math.min(e.y,n.y),t.y=Math.max(t.y,n.y);return _.fromPoints(e,t)}area(){let e=0,t=this.pts.length;for(let n=0;n<t;n++){let s=this.pts[n],r=this.pts[(n+1)%t];e+=s.x*r.y*.5,e-=r.x*s.y*.5}return Math.abs(e)}clone(){return new e(this.pts.map((e=>e.clone())))}collides(e){return function(e,t){return t instanceof d?j(e,t):t instanceof $?N(t,e):t instanceof Z?U(t,e):t instanceof _?F(t,e):t instanceof te?H(t,e):t instanceof ee&&X(t,e)}(this,e)}contains(e){return this.collides(e)}raycast(e,t){return function(e,t,n){let s=n.pts,r=null,i=s[s.length-1];for(let n=0;n<s.length;n++){let a=s[n],o=Q(e,t,new Z(i,a));o&&(!r||r.fraction>o.fraction)&&(r=o),i=a}return r}(e,t,this)}random(){return c()}cut(t,n){new Z(t,n);let s=[],r=[],i=n.sub(t),a=this.pts[this.pts.length-1],o=a.sub(t),l=i.cross(o)>0;return this.pts.forEach((e=>{o=e.sub(t);let h=i.cross(o)>0;if(l!=h){let i=function(e,t,n,s){let r=t.sub(e),i=s.sub(n),a=r.cross(i);return a<1e-5&&a>-1e-5||(a=n.sub(e).cross(i)/a,a<0||a>1)?null:e.add(r.scale(a))}(a,e,t,n);s.push(i),r.push(i),l=h}(h?s:r).push(e),a=e})),[s.length?new e(s):null,r.length?new e(r):null]}};function ne(e,t,n,s){let r=s*s,i=1-s,a=i*i;return e.scale(a).add(t.scale(2*i*s)).add(n.scale(r))}function se(e,t,n,s){let r=1-s;return t.sub(e).scale(2*r).add(n.sub(t).scale(2*s))}function re(e,t,n,s){return n.sub(t.scale(2)).add(e).scale(2)}function ie(e,t,n,s,r){let i=r*r,a=i*r,o=1-r,l=o*o,h=l*o;return e.scale(h).add(t.scale(3*l*r)).add(n.scale(3*o*i)).add(s.scale(a))}function ae(e,t,n,s,r){let i=r*r,a=1-r,o=a*a;return t.sub(e).scale(3*o).add(n.sub(t).scale(6*a*r)).add(s.sub(n).scale(3*i))}function oe(e,t,n,s,r){let i=1-r;return n.sub(t.scale(2)).add(e).scale(6*i).add(s.sub(n.scale(2)).add(t).scale(6*r))}function le(e,t,n,s,r){let i=((2-r)*r-1)*r*.5,a=.5*((3*r-5)*r*r+2),o=((-3*r+4)*r+1)*r*.5,l=(r-1)*r*r*.5;return e.scale(i).add(t.scale(a)).add(n.scale(o)).add(s.scale(l))}function he(e,t,n,s,r){let i=.5*((-3*r+4)*r-1),a=(9*r-10)*r*.5,o=.5*((-9*r+8)*r+1),l=(3*r-2)*r*.5;return e.scale(i).add(t.scale(a)).add(n.scale(o)).add(s.scale(l))}function ue(e){let t=de(e),n=t(1);return s=>{let r=t(s*n,!0);return e(r)}}function de(e,t=10,n=10){let s=[0],r=[0],i=1/(t-1)/n,a=0,o=e(0),l=0;for(let h=1;h<t;h++){for(let t=0;t<n;t++){l+=i;let t=e(l),n=t.dist(o);a+=n,o=t}s[h]=a,r[h]=l}return r[t-1]=1,(e,n=!1)=>{if(n){let t=e;if(t<=0)return 0;if(t>=a)return 1;let n=0;for(;s[n+1]<t;)n++;let i=r[n],o=r[n+1],l=s[n];return i+(o-i)*((t-l)/(s[n+1]-l))}{if(e<=0)return 0;if(e>=1)return s[t-1];let n=0;for(;r[n+1]<e;)n++;let i=r[n],a=r[n+1],o=s[n];return o+(s[n+1]-o)*((e-i)/(a-i))}}}function ce(e,t,n,s){let r=2*e+t-2*s+n,i=-3*e+3*s-2*t-n,a=t,o=e;return e=>{let t=e*e;return r*(t*e)+i*t+a*e+o}}function fe(e,t,n,s,r,i=ce){let a=i(t.x,(1-r)*(n.x-e.x),(1-r)*(s.x-t.x),n.x),o=i(t.y,(1-r)*(n.y-e.y),(1-r)*(s.y-t.y),n.y);return e=>new d(a(e),o(e))}function pe(e,t,n,s,r=ce){return fe(e,t,n,s,.5,r)}function ge(e,t,n,s,r=ce){return pe(s.add(e.sub(t).scale(6)),e,s,e.add(s.sub(n).scale(6)),r)}function me(e,t,n,s,r,i,a,o=ce){let l=o(t.x,.5*(1-r)*(1+a)*(1+i)*(t.x-e.x)+.5*(1-r)*(1-a)*(1-i)*(n.x-t.x),.5*(1-r)*(1+a)*(1-i)*(n.x-t.x)+.5*(1-r)*(1-a)*(1+i)*(s.x-n.x),n.x),h=o(t.y,.5*(1-r)*(1+a)*(1+i)*(t.y-e.y)+.5*(1-r)*(1-a)*(1-i)*(n.y-t.y),.5*(1-r)*(1+a)*(1-i)*(n.y-t.y)+.5*(1-r)*(1-a)*(1+i)*(s.y-n.y),n.y);return e=>new d(l(e),h(e))}function we(e,t,n,s){let r=2*e+t-2*s+n,i=-3*e+3*s-2*t+n,a=t;return e=>3*r*(e*e)+2*i*e+a}function ye(e){return 0<=e&&e<=1}function Ae(e,t){return Math.abs(e-t)<=Number.EPSILON}function xe(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function ve(e,t,n,s,r){let i=function(e,t,n,s){let r=3*e-6*t+3*n,i=-3*e+3*t,a=e,o=3*t-e-3*n+s;if(Ae(o,0)){if(Ae(r,0))return Ae(i,0)?[]:[-a/i].filter(ye);let e=Math.sqrt(i*i-4*r*a),t=2*r;return[(e-i)/t,(-i-e)/t].filter(ye)}r/=o,i/=o,a/=o;let l=(3*i-r*r)/3,h=l/3,u=(2*r*r*r-9*r*i+27*a)/27,d=u/2,c=d*d+h*h*h;if(c<0){let e=-l/3,t=e*e*e,n=Math.sqrt(t),s=-u/(2*n),i=s<-1?-1:s>1?1:s,a=Math.acos(i),o=2*xe(n);return[o*Math.cos(a/3)-r/3,o*Math.cos((a+2*Math.PI)/3)-r/3,o*Math.cos((a+4*Math.PI)/3)-r/3].filter(ye)}if(0===c){let e=d<0?xe(-d):-xe(d);return[2*e-r/3,-e-r/3].filter(ye)}let f=Math.sqrt(c);return[xe(f-d)-xe(f+d)-r/3].filter(ye)}(e.x-r,t.x-r,n.x-r,s.x-r);return i.length>0?ie(e,t,n,s,i[0]).y:NaN}function be(e){if(!e||0==e.length)throw new Error("Need at least one point for easingLinear.");let t=e.length;return n=>{if(n<=0||1==e.length||n<=e[0].x)return e[0].y;for(let s=0;s<t;s++)if(e[s].x>=n)return h(n,e[s-1].x,e[s].x,e[s-1].y,e[s].y);return e[e.length-1].y}}function Ee(e,t){return n=>ve(c(0,0),e,t,c(1,1),n)}function Me(e,t="jump-end"){let n=1/e,s=1/(e+("jump-end"==t||"jump-both"==t?1:0)),r="jump-start"==t||"jump-both"==t?s:0;return e=>{let t=Math.floor(e/n);return r+t*s}}function Se(e,t){let n=Number.MAX_VALUE,s={normal:c(0),distance:0};for(let r of[e,t])for(let i=0;i<r.pts.length;i++){let a=r.pts[i],o=r.pts[(i+1)%r.pts.length].sub(a).normal().unit(),l=Number.MAX_VALUE,h=-Number.MAX_VALUE;for(let t=0;t<e.pts.length;t++){let n=e.pts[t].dot(o);l=Math.min(l,n),h=Math.max(h,n)}let u=Number.MAX_VALUE,d=-Number.MAX_VALUE;for(let e=0;e<t.pts.length;e++){let n=t.pts[e].dot(o);u=Math.min(u,n),d=Math.max(d,n)}let c=Math.min(h,d)-Math.max(l,u);if(c<0)return null;if(c<Math.abs(n)){let e=d-l,t=u-h;n=Math.abs(e)<Math.abs(t)?e:t,s.normal=o,s.distance=n}}return s}function qe(e,t,n){return(t.x-e.x)*(n.y-e.y)-(t.y-e.y)*(n.x-e.x)>=0}function ke(e,t,n,s){let r=s.x-n.x,i=s.y-n.y;return(r*(e.y-n.y)-i*(e.x-n.x))*(r*(t.y-n.y)-i*(t.x-n.x))>=0}function Be(e,t,n,s){return ke(e,t,n,s)&&ke(e,n,t,s)&&ke(e,s,t,n)}function Re(e,t,n,s){return qe(e,t,n)&&!function(e,t,n,s){for(let r of e)if(r!==t&&r!==n&&r!==s&&Be(r,t,n,s))return!0;return!1}(s,e,t,n)}function Ce(e){if(e.length<3)return[];if(3==e.length)return[e];let t=[],n=[],s=0;for(let r=0;r<e.length;r++){let i=e[s],a=e[r];a.x<i.x||a.x==i.x&&(a.y,i.y),t[r]=r+1,n[r]=r-1}t[t.length-1]=0,n[0]=n.length-1,function(e){let t=0,n=e[e.length-1];for(let s=0;s<e.length;s++)t+=(e[s].x-n.x)*(e[s].y+n.y),n=e[s];return t<0}(e)||([t,n]=[n,t]);let r=[];for(let s=0;s<e.length;++s)qe(e[n[s]],e[s],e[t[s]])||r.push(e[s]);let i,a,o=[],l=e.length,h=1,u=0;for(;l>3;){i=t[h],a=n[h];let s=e[a],d=e[h],c=e[i];if(Re(s,d,c,r))o.push([s,d,c]),t[a]=i,n[i]=a,r.splice(r.indexOf(d),1),--l,u=0;else if(++u>l)return[];h=i}return i=t[h],a=n[h],o.push([e[a],e[h],e[i]]),o}function Ie(e){if(e.length<3)return!1;let t=e.length-2,n=e.length-1,s=0,r=e[n].sub(e[t]),i=e[s].sub(e[n]),a=r.cross(i);for(;s+1<e.length;)if(t=n,n=s,s++,r=e[n].sub(e[t]),i=e[s].sub(e[n]),r.cross(i)*a<0)return!1;return!0}var Pe=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~",Te="topleft",Fe="monospace",De="monospace",Oe="linear",Ue=[{name:"a_pos",size:2},{name:"a_uv",size:2},{name:"a_color",size:4}],Le=8192*Ue.reduce(((e,t)=>e+t.size),0),Ne="\nattribute vec2 a_pos;\nattribute vec2 a_uv;\nattribute vec4 a_color;\n\nvarying vec2 v_pos;\nvarying vec2 v_uv;\nvarying vec4 v_color;\n\nvec4 def_vert() {\n\treturn vec4(a_pos, 0.0, 1.0);\n}\n\n{{user}}\n\nvoid main() {\n\tvec4 pos = vert(a_pos, a_uv, a_color);\n\tv_pos = a_pos;\n\tv_uv = a_uv;\n\tv_color = a_color;\n\tgl_Position = pos;\n}\n",He="\nprecision mediump float;\n\nvarying vec2 v_pos;\nvarying vec2 v_uv;\nvarying vec4 v_color;\n\nuniform sampler2D u_tex;\n\nvec4 def_frag() {\n\tvec4 texColor = texture2D(u_tex, v_uv);\n\treturn vec4((v_color.rgb * texColor.rgb), texColor.a) * v_color.a;\n}\n\n{{user}}\n\nvoid main() {\n\tgl_FragColor = frag(v_pos, v_uv, v_color, u_tex);\n\tif (gl_FragColor.a == 0.0) {\n\t\tdiscard;\n\t}\n}\n",je="\nvec4 vert(vec2 pos, vec2 uv, vec4 color) {\n\treturn def_vert();\n}\n",Ke="\nvec4 frag(vec2 pos, vec2 uv, vec4 color, sampler2D tex) {\n\treturn def_frag();\n}\n",Ge=new Set(["id","require"]),Ve=new Set(["add","fixedUpdate","update","draw","destroy","inspect","drawInspect"]),Ye=Symbol.for("kaplay.cancel"),Xe=class extends Map{lastID=0;push(e){let t=this.lastID;return this.set(t,e),this.lastID++,t}pushd(e){let t=this.push(e);return()=>this.delete(t)}},ze=class e{paused=!1;cancel;constructor(e){this.cancel=e}static join(t){let n=new e((()=>t.forEach((e=>e.cancel()))));return Object.defineProperty(n,"paused",{get:()=>t[0].paused,set:e=>t.forEach((t=>t.paused=e))}),n.paused=!1,n}static replace(e,t){return e.cancel=()=>t.cancel(),t.paused=e.paused,Object.defineProperty(e,"paused",{get:()=>t.paused,set:e=>t.paused=e}),e}},Qe=class{cancellers=new WeakMap;handlers=new Xe;add(e){function t(...t){if(!s.paused)return e(...t)}let n=this.handlers.pushd(t),s=new ze(n);return this.cancellers.set(t,n),s}addOnce(e){let t=this.add(((...n)=>{t.cancel(),e(...n)}));return t}next(){return new Promise((e=>this.addOnce(e)))}trigger(...e){this.handlers.forEach((t=>{let n;t(...e)===Ye&&(n=this.cancellers.get(t))&&n()}))}numListeners(){return this.handlers.size}clear(){this.handlers.clear()}},We=class{handlers={};registers={};on(e,t){return this.handlers[e]||(this.handlers[e]=new Qe),this.handlers[e].add(t)}onOnce(e,t){let n=this.on(e,((...e)=>{n.cancel(),t(...e)}));return n}next(e){return new Promise((t=>{this.onOnce(e,((...e)=>t(e[0])))}))}trigger(e,...t){this.handlers[e]&&this.handlers[e].trigger(...t)}remove(e){delete this.handlers[e]}clear(){this.handlers={}}numListeners(e){return this.handlers[e]?.numListeners()??0}},Je=e=>e[0]instanceof s,Ze=e=>e[0]instanceof d,_e=class{_items;_compareFn;constructor(e=((e,t)=>e<t)){this._compareFn=e,this._items=[]}insert(e){this._items.push(e),this.moveUp(this._items.length-1)}remove(){if(0===this._items.length)return null;let e=this._items[0],t=this._items.pop();return 0!==this._items.length&&(this._items[0]=t,this.moveDown(0)),e}clear(){this._items.splice(0,this._items.length)}moveUp(e){for(;e>0;){let t=Math.floor((e-1)/2);if(!this._compareFn(this._items[e],this._items[t])&&this._items[e]>=this._items[t])break;this.swap(e,t),e=t}}moveDown(e){for(;e<Math.floor(this._items.length/2);){let t=2*e+1;if(t<this._items.length-1&&!this._compareFn(this._items[t],this._items[t+1])&&++t,this._compareFn(this._items[e],this._items[t]))break;this.swap(e,t),e=t}}swap(e,t){[this._items[e],this._items[t]]=[this._items[t],this._items[e]]}get length(){return this._items.length}};function $e(e){return function(e){let t=window.atob(e),n=t.length,s=new Uint8Array(n);for(let e=0;e<n;e++)s[e]=t.charCodeAt(e);return s.buffer}(e.split(",")[1])}function et(e,t){let n=document.createElement("a");n.href=t,n.download=e,n.click()}function tt(e,t){et(e,"data:text/plain;charset=utf-8,"+t)}function nt(e,t){tt(e,JSON.stringify(t))}function st(e,t){let n=URL.createObjectURL(t);et(e,n),URL.revokeObjectURL(n)}var rt=e=>e.match(/^data:\w+\/\w+;base64,.+/);function it(e,t){if(e===t)return!0;let n=typeof e,s=typeof t;if(n!==s)return!1;if("object"===n&&"object"===s&&null!==e&&null!==t){if(Array.isArray(e)!==Array.isArray(t))return!1;let n=Object.keys(e),s=Object.keys(t);if(n.length!==s.length)return!1;for(let s of n){if(!it(e[s],t[s]))return!1}return!0}return!1}var at=new Set,ot=e=>e instanceof Error?e.message:String(e);function lt(e,t){!function(e){at.has(e)||(at.add(e),console.warn(e))}(`${e} is deprecated. Use ${t} instead.`)}function ht(e,t){return Number(e.toFixed(t))}function ut(e,t){return(...n)=>{let s=n.length;return s===e.length?e(...n):s===t.length?t(...n):void 0}}var dt=Object.freeze([776,2359,2367,2984,3007,3021,3633,3635,3648,3657,4352,4449,4520]);function ct(e,t){let n=t[e];if(!function(e){return e&&At(e[0].charCodeAt(0),55296,56319)}(n)||e===t.length-1)return 1;let s=n+t[e+1],r=t.substring(e+2,e+5);return ft(s)&&ft(r)?4:function(e){return At(yt(e),127988,127988)}(s)&&function(e){let t=e.codePointAt(0);return"string"==typeof e&&"number"==typeof t&&At(t,917504,917631)}(r)?t.slice(e).indexOf(String.fromCodePoint(917631))+2:function(e){return At(yt(e),127995,127999)}(r)?4:2}function ft(e){return At(yt(e),127462,127487)}function pt(e){return"string"==typeof e&&At(e.charCodeAt(0),65024,65039)}function gt(e){return"string"==typeof e&&At(e.charCodeAt(0),8400,8447)}function mt(e){return"string"==typeof e&&dt.includes(e.charCodeAt(0))}function wt(e){return"string"==typeof e&&8205===e.charCodeAt(0)}function yt(e){return(e.charCodeAt(0)-55296<<10)+(e.charCodeAt(1)-56320)+65536}function At(e,t,n){return e>=t&&e<=n}var xt=(e,t)=>Array.isArray(e)?e?.includes(t):e===t,vt=(e,t)=>Array.isArray(t)?t.some((t=>e.has(t))):e.has(t),bt=(e,t,n)=>{e.has(t)?e.get(t)?.push(n):e.set(t,[n])},Et=(()=>{let e=0;return()=>e++})();function Mt(){let e=zi.globalOpt.pixelDensity??1,t=zi.globalOpt.width,n=zi.globalOpt.height,s=zi.gfx.ggl.gl.drawingBufferWidth/e,r=zi.gfx.ggl.gl.drawingBufferHeight/e,i=0,a=0,o=s,l=r;if(zi.globalOpt.letterbox){if(!t||!n)throw new Error("Letterboxing requires width and height defined.");let e=t/n;if(s/r>e){let t=r*e;i=(s-t)/2,o=t}else{let t=s/e;l=t,a=(r-t)/2}}if(zi.globalOpt.stretch&&(!zi.globalOpt.width||!zi.globalOpt.height))throw new Error("Stretching requires width and height defined.");zi.gfx.viewport={x:i,y:a,width:o,height:l,scale:(zi.gfx.viewport.width+zi.gfx.viewport.height)/(zi.gfx.width+zi.gfx.height)}}var St,qt=()=>St.lastInputDevice,kt=class{pressed=new Set([]);pressedRepeat=new Set([]);released=new Set([]);down=new Set([]);update(){this.pressed.clear(),this.released.clear(),this.pressedRepeat.clear()}press(e){this.pressed.add(e),this.pressedRepeat.add(e),this.down.add(e)}pressRepeat(e){this.pressedRepeat.add(e)}release(e){this.down.delete(e),this.pressed.delete(e),this.released.add(e)}},Bt=class{buttonState=new kt;stickState=new Map},Rt=class{dts=[];timer=0;fps=0;tick(e){this.dts.push(e),this.timer+=e,this.timer>=1&&(this.timer=0,this.fps=Math.round(1/(this.dts.reduce(((e,t)=>e+t))/this.dts.length)),this.dts=[])}},Ct={"Joy-Con L+R (STANDARD GAMEPAD Vendor: 057e Product: 200e)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home",17:"capture"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}},"Joy-Con (L) (STANDARD GAMEPAD Vendor: 057e Product: 2006)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",9:"select",10:"lstick",16:"start"},sticks:{left:{x:0,y:1}}},"Joy-Con (R) (STANDARD GAMEPAD Vendor: 057e Product: 2007)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",9:"start",10:"lstick",16:"select"},sticks:{left:{x:0,y:1}}},"Pro Controller (STANDARD GAMEPAD Vendor: 057e Product: 2009)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home",17:"capture"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}},default:{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}}},It=e=>{if(!e.canvas)throw new Error("Please provide a canvas");let t=(e=>{let t=e.buttons??{};return{canvas:e.canvas,buttons:t,buttonsByKey:new Map,buttonsByMouse:new Map,buttonsByGamepad:new Map,buttonsByKeyCode:new Map,loopID:null,stopped:!1,dt:0,fixedDt:.02,restDt:0,time:0,realTime:0,fpsCounter:new Rt,timeScale:1,skipTime:!1,isHidden:!1,numFrames:0,mousePos:new d(0),mouseDeltaPos:new d(0),keyState:new kt,mouseState:new kt,mergedGamepadState:new Bt,gamepadStates:new Map,lastInputDevice:null,buttonState:new kt,gamepads:[],charInputted:[],isMouseMoved:!1,lastWidth:e.canvas.offsetWidth,lastHeight:e.canvas.offsetHeight,events:new We}})(e);function n(){return t.dt*t.timeScale}function s(){return document.fullscreenElement===t.canvas||document.webkitFullscreenElement===t.canvas}function r(){return t.mousePos.clone()}function i(){return t.mouseDeltaPos.clone()}St=t,(()=>{let e=St.buttons;for(let t in e){let n=e[t].keyboard&&[e[t].keyboard].flat(),s=e[t].keyboardCode&&[e[t].keyboardCode].flat(),r=e[t].gamepad&&[e[t].gamepad].flat(),i=e[t].mouse&&[e[t].mouse].flat();n&&n.forEach((e=>{bt(St.buttonsByKey,e,t)})),s&&s.forEach((e=>{bt(St.buttonsByKeyCode,e,t)})),r&&r.forEach((e=>{bt(St.buttonsByGamepad,e,t)})),i&&i.forEach((e=>{bt(St.buttonsByMouse,e,t)}))}})();let a=ut((e=>t.events.on("keyDown",e)),((e,n)=>t.events.on("keyDown",(t=>xt(e,t)&&n(t))))),o=ut((e=>t.events.on("keyPress",(t=>e(t)))),((e,n)=>t.events.on("keyPress",(t=>xt(e,t)&&n(t))))),l=ut((e=>t.events.on("keyPressRepeat",e)),((e,n)=>t.events.on("keyPressRepeat",(t=>xt(e,t)&&n(t))))),u=ut((e=>t.events.on("keyRelease",e)),((e,n)=>t.events.on("keyRelease",(t=>xt(e,t)&&n(t))))),f=ut((e=>t.events.on("mouseDown",(t=>e(t)))),((e,n)=>t.events.on("mouseDown",(t=>xt(e,t)&&n(t))))),p=ut((e=>t.events.on("mousePress",(t=>e(t)))),((e,n)=>t.events.on("mousePress",(t=>xt(e,t)&&n(t))))),g=ut((e=>t.events.on("mouseRelease",(t=>e(t)))),((e,n)=>t.events.on("mouseRelease",(t=>t===e&&n(t)))));let m=ut((e=>t.events.on("gamepadButtonPress",((t,n)=>e(t,n)))),((e,n)=>t.events.on("gamepadButtonPress",((t,s)=>xt(e,t)&&n(t,s))))),w=ut((e=>t.events.on("gamepadButtonDown",((t,n)=>e(t,n)))),((e,n)=>t.events.on("gamepadButtonDown",((t,s)=>xt(e,t)&&n(t,s))))),y=ut((e=>t.events.on("gamepadButtonRelease",((t,n)=>e(t,n)))),((e,n)=>t.events.on("gamepadButtonRelease",((t,s)=>xt(e,t)&&n(t,s)))));function A(){return[...t.gamepads]}let x=ut((e=>t.events.on("buttonPress",(t=>e(t)))),((e,n)=>t.events.on("buttonPress",(t=>xt(e,t)&&n(t))))),v=ut((e=>t.events.on("buttonDown",(t=>e(t)))),((e,n)=>t.events.on("buttonDown",(t=>xt(e,t)&&n(t))))),b=ut((e=>t.events.on("buttonRelease",(t=>e(t)))),((e,n)=>t.events.on("buttonRelease",(t=>xt(e,t)&&n(t)))));function E(){t.events.trigger("input"),t.keyState.down.forEach((e=>t.events.trigger("keyDown",e))),t.mouseState.down.forEach((e=>t.events.trigger("mouseDown",e))),t.buttonState.down.forEach((e=>{t.events.trigger("buttonDown",e)})),function(){for(let e of navigator.getGamepads())e&&!t.gamepadStates.has(e.index)&&S(e);for(let n of t.gamepads){let s=navigator.getGamepads()[n.index];if(!s)continue;let r=(e.gamepads??{})[s.id]||Ct[s.id]||Ct.default,i=t.gamepadStates.get(n.index);if(i){for(let e=0;e<s.buttons.length;e++){let a=r.buttons[e],o=s.buttons[e],l=t.buttonsByGamepad.has(a);if(o.pressed){if(i.buttonState.down.has(a)){t.events.trigger("gamepadButtonDown",a,n);continue}t.lastInputDevice="gamepad",l&&t.buttonsByGamepad.get(a)?.forEach((e=>{t.buttonState.press(e),t.events.trigger("buttonPress",e)})),t.mergedGamepadState.buttonState.press(a),i.buttonState.press(a),t.events.trigger("gamepadButtonPress",a,n)}else i.buttonState.down.has(a)&&(l&&t.buttonsByGamepad.get(a)?.forEach((e=>{t.buttonState.release(e),t.events.trigger("buttonRelease",e)})),t.mergedGamepadState.buttonState.release(a),i.buttonState.release(a),t.events.trigger("gamepadButtonRelease",a,n))}for(let e in r.sticks){let a=r.sticks[e];if(!a)continue;let o=new d(s.axes[a.x],s.axes[a.y]);i.stickState.set(e,o),t.mergedGamepadState.stickState.set(e,o),t.events.trigger("gamepadStick",e,o,n)}}}}()}function M(){t.keyState.update(),t.mouseState.update(),t.buttonState.update(),t.mergedGamepadState.buttonState.update(),t.mergedGamepadState.stickState.forEach(((e,n)=>{t.mergedGamepadState.stickState.set(n,new d(0))})),t.charInputted=[],t.isMouseMoved=!1,t.mouseDeltaPos=new d(0),t.gamepadStates.forEach((e=>{e.buttonState.update(),e.stickState.forEach(((t,n)=>{e.stickState.set(n,new d(0))}))}))}function S(e){let n={index:e.index,isPressed:n=>t.gamepadStates.get(e.index)?.buttonState.pressed.has(n)||!1,isDown:n=>t.gamepadStates.get(e.index)?.buttonState.down.has(n)||!1,isReleased:n=>t.gamepadStates.get(e.index)?.buttonState.released.has(n)||!1,getStick:n=>t.gamepadStates.get(e.index)?.stickState.get(n)||c()};return t.gamepads.push(n),t.gamepadStates.set(e.index,{buttonState:new kt,stickState:new Map([["left",new d(0)],["right",new d(0)]])}),n}let q={},k={},B={},R=e.pixelDensity||1;q.mousemove=e=>{let n=function(e){return new d((e.x-zi.gfx.viewport.x)*zi.gfx.width/zi.gfx.viewport.width,(e.y-zi.gfx.viewport.y)*zi.gfx.height/zi.gfx.viewport.height)}(new d(e.offsetX,e.offsetY)),r=new d(e.movementX,e.movementY);if(s()){let s=t.canvas.width/R,r=t.canvas.height/R,i=window.innerWidth,a=window.innerHeight;if(i/a>s/r){let t=a/r,o=(i-s*t)/2;n.x=h(e.offsetX-o,0,s*t,0,s),n.y=h(e.offsetY,0,r*t,0,r)}else{let t=i/s,o=(a-r*t)/2;n.x=h(e.offsetX,0,s*t,0,s),n.y=h(e.offsetY-o,0,r*t,0,r)}}t.events.onOnce("input",(()=>{t.isMouseMoved=!0,t.mousePos=n,t.mouseDeltaPos=r,t.events.trigger("mouseMove")}))};let C=["left","middle","right","back","forward"];q.mousedown=e=>{t.events.onOnce("input",(()=>{let n=C[e.button];n&&(t.lastInputDevice="mouse",t.buttonsByMouse.has(n)&&t.buttonsByMouse.get(n)?.forEach((e=>{t.buttonState.press(e),t.events.trigger("buttonPress",e)})),t.mouseState.press(n),t.events.trigger("mousePress",n))}))},q.mouseup=e=>{t.events.onOnce("input",(()=>{let n=C[e.button];n&&(t.buttonsByMouse.has(n)&&t.buttonsByMouse.get(n)?.forEach((e=>{t.buttonState.release(e),t.events.trigger("buttonRelease",e)})),t.mouseState.release(n),t.events.trigger("mouseRelease",n))}))};let I=new Set([" ","ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Tab"]),P={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down"," ":"space"};q.keydown=e=>{I.has(e.key)&&e.preventDefault(),t.events.onOnce("input",(()=>{let n=P[e.key]||e.key.toLowerCase(),s=e.code;if(void 0===n)throw new Error(`Unknown key: ${e.key}`);1===n.length?(t.events.trigger("charInput",n),t.charInputted.push(n)):"space"===n&&(t.events.trigger("charInput"," "),t.charInputted.push(" ")),e.repeat?(t.keyState.pressRepeat(n),t.events.trigger("keyPressRepeat",n)):(t.lastInputDevice="keyboard",t.buttonsByKey.has(n)&&t.buttonsByKey.get(n)?.forEach((e=>{t.buttonState.press(e),t.events.trigger("buttonPress",e)})),t.buttonsByKeyCode.has(s)&&t.buttonsByKeyCode.get(s)?.forEach((e=>{t.buttonState.press(e),t.events.trigger("buttonPress",e)})),t.keyState.press(n),t.events.trigger("keyPressRepeat",n),t.events.trigger("keyPress",n))}))},q.keyup=e=>{t.events.onOnce("input",(()=>{let n=P[e.key]||e.key.toLowerCase(),s=e.code;t.buttonsByKey.has(n)&&t.buttonsByKey.get(n)?.forEach((e=>{t.buttonState.release(e),t.events.trigger("buttonRelease",e)})),t.buttonsByKeyCode.has(s)&&t.buttonsByKeyCode.get(s)?.forEach((e=>{t.buttonState.release(e),t.events.trigger("buttonRelease",e)})),t.keyState.release(n),t.events.trigger("keyRelease",n)}))},q.touchstart=n=>{n.preventDefault(),t.events.onOnce("input",(()=>{let s=[...n.changedTouches],r=t.canvas.getBoundingClientRect();!1!==e.touchToMouse&&(t.mousePos=new d(s[0].clientX-r.x,s[0].clientY-r.y),t.lastInputDevice="mouse",t.buttonsByMouse.has("left")&&t.buttonsByMouse.get("left")?.forEach((e=>{t.buttonState.press(e),t.events.trigger("buttonPress",e)})),t.mouseState.press("left"),t.events.trigger("mousePress","left")),s.forEach((e=>{t.events.trigger("touchStart",new d(e.clientX-r.x,e.clientY-r.y),e)}))}))},q.touchmove=n=>{n.preventDefault(),t.events.onOnce("input",(()=>{let s=[...n.changedTouches],r=t.canvas.getBoundingClientRect();if(!1!==e.touchToMouse){let e=t.mousePos;t.mousePos=new d(s[0].clientX-r.x,s[0].clientY-r.y),t.mouseDeltaPos=t.mousePos.sub(e),t.events.trigger("mouseMove")}s.forEach((e=>{t.events.trigger("touchMove",new d(e.clientX-r.x,e.clientY-r.y),e)}))}))},q.touchend=n=>{t.events.onOnce("input",(()=>{let s=[...n.changedTouches],r=t.canvas.getBoundingClientRect();!1!==e.touchToMouse&&(t.mousePos=new d(s[0].clientX-r.x,s[0].clientY-r.y),t.mouseDeltaPos=new d(0,0),t.buttonsByMouse.has("left")&&t.buttonsByMouse.get("left")?.forEach((e=>{t.buttonState.release(e),t.events.trigger("buttonRelease",e)})),t.mouseState.release("left"),t.events.trigger("mouseRelease","left")),s.forEach((e=>{t.events.trigger("touchEnd",new d(e.clientX-r.x,e.clientY-r.y),e)}))}))},q.touchcancel=n=>{t.events.onOnce("input",(()=>{let s=[...n.changedTouches],r=t.canvas.getBoundingClientRect();!1!==e.touchToMouse&&(t.mousePos=new d(s[0].clientX-r.x,s[0].clientY-r.y),t.mouseState.release("left"),t.events.trigger("mouseRelease","left")),s.forEach((e=>{t.events.trigger("touchEnd",new d(e.clientX-r.x,e.clientY-r.y),e)}))}))},q.wheel=e=>{e.preventDefault(),t.events.onOnce("input",(()=>{t.events.trigger("scroll",new d(e.deltaX,e.deltaY))}))},q.contextmenu=e=>e.preventDefault(),k.visibilitychange=()=>{"visible"===document.visibilityState?(t.skipTime=!0,t.isHidden=!1,t.events.trigger("show")):(t.isHidden=!0,t.events.trigger("hide"))},B.gamepadconnected=e=>{let n=S(e.gamepad);t.events.onOnce("input",(()=>{t.events.trigger("gamepadConnect",n)}))},B.gamepaddisconnected=e=>{let n=A().filter((t=>t.index===e.gamepad.index))[0];(function(e){t.gamepads=t.gamepads.filter((t=>t.index!==e.index)),t.gamepadStates.delete(e.index)})(e.gamepad),t.events.onOnce("input",(()=>{t.events.trigger("gamepadDisconnect",n)}))};for(let[e,n]of Object.entries(q))t.canvas.addEventListener(e,n);for(let[e,t]of Object.entries(k))document.addEventListener(e,t);for(let[e,t]of Object.entries(B))window.addEventListener(e,t);let T=new ResizeObserver((e=>{for(let n of e)if(n.target===t.canvas){if(t.lastWidth===t.canvas.offsetWidth&&t.lastHeight===t.canvas.offsetHeight)return;t.lastWidth=t.canvas.offsetWidth,t.lastHeight=t.canvas.offsetHeight,t.events.onOnce("input",(()=>{t.events.trigger("resize")}))}}));return T.observe(t.canvas),{state:t,dt:n,fixedDt:function(){return t.fixedDt*t.timeScale},restDt:function(){return t.restDt*t.timeScale},time:function(){return t.time},run:function(s,r){null!==t.loopID&&cancelAnimationFrame(t.loopID);let i=0,a=0,o=l=>{if(t.stopped)return;if("visible"!==document.visibilityState)return void(t.loopID=requestAnimationFrame(o));let h=l/1e3,u=Math.min(h-t.realTime,.25),d=e.maxFPS?1/e.maxFPS:0;if(t.realTime=h,a+=u,a>d){if(!t.skipTime){for(i+=a,t.dt=t.fixedDt,t.restDt=0;i>t.fixedDt;)i-=t.fixedDt,i<t.fixedDt&&(t.restDt=i),s();t.restDt=i,t.dt=a,t.time+=n(),t.fpsCounter.tick(t.dt)}a=0,t.skipTime=!1,t.numFrames++,r(E,M)}t.loopID=requestAnimationFrame(o)};o(0)},canvas:t.canvas,fps:function(){return t.fpsCounter.fps},numFrames:function(){return t.numFrames},quit:function(){t.stopped=!0;let e=Object.entries(q),n=Object.entries(k),s=Object.entries(B);for(let[n,s]of e)t.canvas.removeEventListener(n,s);for(let[e,t]of n)document.removeEventListener(e,t);for(let[e,t]of s)window.removeEventListener(e,t);T.disconnect()},isHidden:function(){return t.isHidden},setFullscreen:function(e=!0){e?function(e){e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen()}(t.canvas):document.exitFullscreen?document.exitFullscreen():document.webkitExitFullScreen&&document.webkitExitFullScreen()},isFullscreen:s,setCursor:function(e){t.canvas.style.cursor=e},screenshot:function(){return t.canvas.toDataURL()},getGamepads:A,getCursor:function(){return t.canvas.style.cursor},setCursorLocked:function(e){if(e)try{let e=t.canvas.requestPointerLock();e?.catch&&e.catch((e=>console.error(e)))}catch(e){console.error(e)}else document.exitPointerLock()},isCursorLocked:function(){return!!document.pointerLockElement},isTouchscreen:function(){return"ontouchstart"in window||navigator.maxTouchPoints>0},mousePos:r,mouseDeltaPos:i,isKeyDown:function(e){return void 0===e?t.keyState.down.size>0:vt(t.keyState.down,e)},isKeyPressed:function(e){return void 0===e?t.keyState.pressed.size>0:vt(t.keyState.pressed,e)},isKeyPressedRepeat:function(e){return void 0===e?t.keyState.pressedRepeat.size>0:vt(t.keyState.pressedRepeat,e)},isKeyReleased:function(e){return void 0===e?t.keyState.released.size>0:vt(t.keyState.released,e)},isMouseDown:function(e="left"){return t.mouseState.down.has(e)},isMousePressed:function(e="left"){return t.mouseState.pressed.has(e)},isMouseReleased:function(e="left"){return t.mouseState.released.has(e)},isMouseMoved:function(){return t.isMouseMoved},isGamepadButtonPressed:function(e){return void 0===e?t.mergedGamepadState.buttonState.pressed.size>0:vt(t.mergedGamepadState.buttonState.pressed,e)},isGamepadButtonDown:function(e){return void 0===e?t.mergedGamepadState.buttonState.down.size>0:vt(t.mergedGamepadState.buttonState.down,e)},isGamepadButtonReleased:function(e){return void 0===e?t.mergedGamepadState.buttonState.released.size>0:vt(t.mergedGamepadState.buttonState.released,e)},getGamepadStick:function(e){return t.mergedGamepadState.stickState.get(e)||new d(0)},isButtonPressed:function(e){return void 0===e?t.buttonState.pressed.size>0:vt(t.buttonState.pressed,e)},isButtonDown:function(e){return void 0===e?t.buttonState.down.size>0:vt(t.buttonState.down,e)},isButtonReleased:function(e){return void 0===e?t.buttonState.released.size>0:vt(t.buttonState.released,e)},setButton:function(e,n){t.buttons[e]={...t.buttons[e],...n}},getButton:function(e){return t.buttons?.[e]},pressButton:function(e){t.buttonState.press(e),t.events.trigger("buttonPress",e)},releaseButton:function(e){t.buttonState.release(e),t.events.trigger("buttonRelease",e)},charInputted:function(){return[...t.charInputted]},onResize:function(e){return t.events.on("resize",e)},onKeyDown:a,onKeyPress:o,onKeyPressRepeat:l,onKeyRelease:u,onMouseDown:f,onMousePress:p,onMouseRelease:g,onMouseMove:function(e){return t.events.on("mouseMove",(()=>e(r(),i())))},onCharInput:function(e){return t.events.on("charInput",e)},onTouchStart:function(e){return t.events.on("touchStart",e)},onTouchMove:function(e){return t.events.on("touchMove",e)},onTouchEnd:function(e){return t.events.on("touchEnd",e)},onScroll:function(e){return t.events.on("scroll",e)},onHide:function(e){return t.events.on("hide",e)},onShow:function(e){return t.events.on("show",e)},onGamepadButtonDown:w,onGamepadButtonPress:m,onGamepadButtonRelease:y,onGamepadStick:function(e,n){return t.events.on("gamepadStick",((t,s,r)=>t===e&&n(s,r)))},onGamepadConnect:function(e){t.events.on("gamepadConnect",e)},onGamepadDisconnect:function(e){t.events.on("gamepadDisconnect",e)},onButtonPress:x,onButtonDown:v,onButtonRelease:b,getLastInputDeviceType:qt,events:t.events}};function Pt(){return zi.app.dt()}function Tt(){return zi.app.fixedDt()}function Ft(){return zi.app.restDt()}var Dt=new d(-1,-1),Ot=new d(0,-1),Ut=new d(1,-1),Lt=new d(-1,0),Nt=new d(0,0),Ht=new d(1,0),jt=new d(-1,1),Kt=new d(0,1),Gt=new d(1,1);function Vt(e){switch(e){case"topleft":return Dt;case"top":return Ot;case"topright":return Ut;case"left":return Lt;case"center":return Nt;case"right":return Ht;case"botleft":return jt;case"bot":return Kt;case"botright":return Gt;default:return e}}function Yt(e){switch(e){case"left":default:return 0;case"center":return.5;case"right":return 1}}var Xt=2.5949095,zt=2.70158,Qt=2*Math.PI/3,Wt=2*Math.PI/4.5,Jt={linear:e=>e,easeInSine:e=>1-Math.cos(e*Math.PI/2),easeOutSine:e=>Math.sin(e*Math.PI/2),easeInOutSine:e=>-(Math.cos(Math.PI*e)-1)/2,easeInQuad:e=>e*e,easeOutQuad:e=>1-(1-e)*(1-e),easeInOutQuad:e=>e<.5?2*e*e:1-Math.pow(-2*e+2,2)/2,easeInCubic:e=>e*e*e,easeOutCubic:e=>1-Math.pow(1-e,3),easeInOutCubic:e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2,easeInQuart:e=>e*e*e*e,easeOutQuart:e=>1-Math.pow(1-e,4),easeInOutQuart:e=>e<.5?8*e*e*e*e:1-Math.pow(-2*e+2,4)/2,easeInQuint:e=>e*e*e*e*e,easeOutQuint:e=>1-Math.pow(1-e,5),easeInOutQuint:e=>e<.5?16*e*e*e*e*e:1-Math.pow(-2*e+2,5)/2,easeInExpo:e=>0===e?0:Math.pow(2,10*e-10),easeOutExpo:e=>1===e?1:1-Math.pow(2,-10*e),easeInOutExpo:e=>0===e?0:1===e?1:e<.5?Math.pow(2,20*e-10)/2:(2-Math.pow(2,-20*e+10))/2,easeInCirc:e=>1-Math.sqrt(1-Math.pow(e,2)),easeOutCirc:e=>Math.sqrt(1-Math.pow(e-1,2)),easeInOutCirc:e=>e<.5?(1-Math.sqrt(1-Math.pow(2*e,2)))/2:(Math.sqrt(1-Math.pow(-2*e+2,2))+1)/2,easeInBack:e=>zt*e*e*e-1.70158*e*e,easeOutBack:e=>1+zt*Math.pow(e-1,3)+1.70158*Math.pow(e-1,2),easeInOutBack:e=>e<.5?Math.pow(2*e,2)*(7.189819*e-Xt)/2:(Math.pow(2*e-2,2)*((Xt+1)*(2*e-2)+Xt)+2)/2,easeInElastic:e=>0===e?0:1===e?1:-Math.pow(2,10*e-10)*Math.sin((10*e-10.75)*Qt),easeOutElastic:e=>0===e?0:1===e?1:Math.pow(2,-10*e)*Math.sin((10*e-.75)*Qt)+1,easeInOutElastic:e=>0===e?0:1===e?1:e<.5?-Math.pow(2,20*e-10)*Math.sin((20*e-11.125)*Wt)/2:Math.pow(2,-20*e+10)*Math.sin((20*e-11.125)*Wt)/2+1,easeInBounce:e=>1-Jt.easeOutBounce(1-e),easeOutBounce:e=>e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375,easeInOutBounce:e=>e<.5?(1-Jt.easeOutBounce(1-2*e))/2:(1+Jt.easeOutBounce(2*e-1))/2},Zt=Jt;var _t=class{a;b;polygon;constructor(e,t,n){this.a=e,this.b=t,this.polygon=new WeakRef(n)}isLeft(e,t){return(this.b.x-this.a.x)*(t-this.a.y)-(e-this.a.x)*(this.b.y-this.a.y)}get middle(){return this.a.add(this.b).scale(.5)}},$t=class{_edges;_centroid;_id;constructor(e){this._id=e}get id(){return this._id}set edges(e){this._edges=e;let t=0,n=0,s=0;for(let e of this._edges){e.polygon=new WeakRef(this);let r=e.a.x*e.b.y-e.a.y*e.b.x;t+=(e.a.x+e.b.x)*r,n+=(e.a.y+e.b.y)*r,s+=r}s/=2,this._centroid=c(t/(6*s),n/(6*s))}get edges(){return this._edges}get centroid(){return this._centroid}contains(e){let t=!1;for(let n of this.edges)n.b.y>e.y!=n.a.y>e.y&&e.x<(n.a.x-n.b.x)*(e.y-n.b.y)/(n.a.y-n.b.y)+n.b.x&&(t=!t);return t}},en=class{_polygons;_pointCache;_edgeCache;constructor(){this._polygons=[],this._pointCache={},this._edgeCache={}}_addPoint(e){let t=this._pointCache[`${e.x}_${e.y}`];return t||(t=e.clone(),this._pointCache[`${e.x}_${e.y}`]=t,t)}_addEdge(e){let t=`${e.a.x}_${e.a.y}-${e.b.x}_${e.b.y}`;return this._edgeCache[t]=e,e}_findEdge(e,t){let n=`${e.x}_${e.y}-${t.x}_${t.y}`;return this._edgeCache[n]}_findCommonEdge(e,t){for(let n of e.edges){let e=this._findEdge(n.b,n.a);if(e&&e.polygon.deref().id===t.id)return e}return null}addPolygon(e){let t=new $t(this._polygons.length),n=e.map(((n,s)=>new _t(n,e[(s+1)%e.length],t)));t.edges=n,this._polygons.push(t);for(let e of t.edges)this._addEdge(e);return t}addRect(e,t){let n=this._addPoint(e),s=this._addPoint(e.add(t.x,0)),r=this._addPoint(e.add(t)),i=this._addPoint(e.add(0,t.y));return this.addPolygon([n,s,r,i])}_getLocation(e){for(let t of this._polygons)if(t.contains(e))return t;return null}getNeighbours(e){let t=[];for(let n of this._polygons[e].edges){let e=this._findEdge(n.b,n.a);if(e){let n=e.polygon.deref();n&&t.push(n.id)}}return t}getCost(e,t){return 1}getHeuristic(e,t){let n=this._polygons[e],s=this._polygons[t],r=n.centroid.x-s.centroid.x,i=n.centroid.y-s.centroid.y;return Math.sqrt(r*r+i*i)}getPath(e,t){return void 0===e||void 0===t?[]:e===t?[e,t]:function(e,t,n){let s=new _e(((e,t)=>e.cost<t.cost));s.insert({cost:0,node:t});let r=new Map;r.set(t,t);let i=new Map;for(i.set(t,0);0!==s.length;){let t=s.remove()?.node;if(t===n)break;let a=e.getNeighbours(t);for(let o of a){let a=(i.get(t)||0)+e.getCost(t,o)+e.getHeuristic(o,n);(!i.has(o)||a<i.get(o))&&(i.set(o,a),s.insert({cost:a,node:o}),r.set(o,t))}}return function(e,t,n){let s=[],r=t;for(s.push(r);r!==e;){if(r=n.get(r),null==r)return null;s.push(r)}return s.reverse()}(t,n,r)}(this,e,t)}getWaypointPath(e,t,n){let s=n?.type||"centroids",r=this._getLocation(e),i=this._getLocation(t);if(void 0===r||void 0===i)return[];let a=this.getPath(r.id,i.id);if(!a)return[];if("edges"===s){let n=[];for(let e=1;e<a.length;e++){let t=this._polygons[a[e-1]],s=this._polygons[a[e]],r=this._findCommonEdge(t,s);n.push(r.middle.add(s.centroid.sub(r.middle).unit().scale(4)))}return[e,...n,t]}return[e,...a.slice(1,-1).map((e=>this._polygons[e].centroid)),t]}};function tn(e){let t=new w;return e.pos&&t.translate(e.pos),e.scale&&t.scale(e.scale),e.angle&&t.rotate(e.angle),e.parent?t.mult(e.parent.transform):t}function nn(e){return new d(e.x/pn()*2-1,-e.y/gn()*2+1)}function sn(e,t,n,s,r,i=1){s=a(s%360),(r=a(r%360))<=s&&(r+=2*Math.PI);let o=[],l=Math.ceil((r-s)/a(8)*i),h=(r-s)/l,u=c(Math.cos(s),Math.sin(s)),d=c(Math.cos(h),Math.sin(h));for(let s=0;s<=l;s++)o.push(e.add(t*u.x,n*u.y)),u=c(u.x*d.x-u.y*d.y,u.x*d.y+u.y*d.x);return o}function rn(...e){let t=r(...e),n=e[3]??1;zi.gfx.bgColor=t,zi.gfx.bgAlpha=n,zi.gfx.ggl.gl.clearColor(t.r/255,t.g/255,t.b/255,n)}function an(){return zi.gfx.bgColor?.clone?.()??null}function on(...e){if(void 0===e[0])return;let t=c(...e);0===t.x&&0===t.y||zi.gfx.transform.translate(t)}function ln(){zi.gfx.transformStack.push(zi.gfx.transform.clone())}function hn(e){zi.gfx.transform=e.clone()}function un(...e){if(void 0===e[0])return;let t=c(...e);1===t.x&&1===t.y||zi.gfx.transform.scale(t)}function dn(e){e&&zi.gfx.transform.rotate(e)}function cn(){zi.gfx.transformStack.length>0&&(zi.gfx.transform=zi.gfx.transformStack.pop())}function fn(){zi.gfx.renderer.flush()}function pn(){return zi.gfx.width}function gn(){return zi.gfx.height}function mn(){return(zi.gfx.viewport.width+zi.gfx.viewport.height)/(zi.gfx.width+zi.gfx.height)}function wn(){return c(pn()/2,gn()/2)}var yn=class{lastTextureId=0;textures=[];bigTextures=[];texturesPosition=new Map;canvas;c2d;x=0;y=0;curHeight=0;gfx;padding;constructor(e,t,n,s){this.gfx=e,this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=n,this.textures=[us.fromImage(e,this.canvas)],this.bigTextures=[],this.padding=s;let r=this.canvas.getContext("2d");if(!r)throw new Error("Failed to get 2d context");this.c2d=r}addSingle(e){let t=us.fromImage(this.gfx,e);return this.bigTextures.push(t),[t,new f(0,0,1,1),0]}add(e){let t=e.width+2*this.padding,n=e.height+2*this.padding;if(t>this.canvas.width||n>this.canvas.height)return this.addSingle(e);this.x+t>this.canvas.width&&(this.x=0,this.y+=this.curHeight,this.curHeight=0),this.y+n>this.canvas.height&&(this.c2d.clearRect(0,0,this.canvas.width,this.canvas.height),this.textures.push(us.fromImage(this.gfx,this.canvas)),this.x=0,this.y=0,this.curHeight=0);let s=this.textures[this.textures.length-1],r=new d(this.x+this.padding,this.y+this.padding);return this.x+=t,n>this.curHeight&&(this.curHeight=n),e instanceof ImageData?this.c2d.putImageData(e,r.x,r.y):this.c2d.drawImage(e,r.x,r.y),s.update(this.canvas),this.texturesPosition.set(this.lastTextureId,{position:r,size:new d(e.width,e.height),texture:s}),this.lastTextureId++,[s,new f(r.x/this.canvas.width,r.y/this.canvas.height,e.width/this.canvas.width,e.height/this.canvas.height),this.lastTextureId-1]}free(){for(let e of this.textures)e.free();for(let e of this.bigTextures)e.free()}};function An(e){return"string"!=typeof e||rt(e)?e:zi.assets.urlPrefix+e}var xn=class e{loaded=!1;data=null;error=null;onLoadEvents=new Qe;onErrorEvents=new Qe;onFinishEvents=new Qe;constructor(e){e.then((e=>{this.loaded=!0,this.data=e,this.onLoadEvents.trigger(e)})).catch((e=>{if(this.error=e,!(this.onErrorEvents.numListeners()>0))throw e;this.onErrorEvents.trigger(e)})).finally((()=>{this.onFinishEvents.trigger(),this.loaded=!0}))}static loaded(t){let n=new e(Promise.resolve(t));return n.data=t,n.loaded=!0,n}onLoad(e){return this.loaded&&this.data?e(this.data):this.onLoadEvents.add(e),this}onError(e){return this.loaded&&this.error?e(this.error):this.onErrorEvents.add(e),this}onFinish(e){return this.loaded?e():this.onFinishEvents.add(e),this}then(e){return this.onLoad(e)}catch(e){return this.onError(e)}finally(e){return this.onFinish(e)}},vn=class{assets=new Map;lastUID=0;add(e,t){let n=e??this.lastUID+++"",s=new xn(t);return this.assets.set(n,s),s}addLoaded(e,t){let n=e??this.lastUID+++"",s=xn.loaded(t);return this.assets.set(n,s),s}get(e){return this.assets.get(e)}progress(){if(0===this.assets.size)return 1;let e=0;return this.assets.forEach((t=>{t.loaded&&e++})),e/this.assets.size}getFailedAssets(){return Array.from(this.assets.keys()).filter((e=>null!==this.assets.get(e).error)).map((e=>[e,this.assets.get(e)]))}};function bn(e){return fetch(e).then((t=>{if(!t.ok)throw new Error(`Failed to fetch "${e}"`);return t}))}function En(e){return bn(e).then((e=>e.json()))}function Mn(e){return void 0!==e&&(zi.assets.urlPrefix=e),zi.assets.urlPrefix}function Sn(e,t){return zi.assets.custom.add(e,En(An(t)))}function qn(e){let t=new Image;return t.crossOrigin="anonymous",t.src=e,new Promise(((n,s)=>{t.onload=()=>n(t),t.onerror=()=>s(new Error(`Failed to load image from "${e}"`))}))}function kn(){let e=[zi.assets.sprites,zi.assets.sounds,zi.assets.shaders,zi.assets.fonts,zi.assets.bitmapFonts,zi.assets.custom];return e.reduce(((e,t)=>e+t.progress()),0)/e.length}function Bn(){return[zi.assets.sprites,zi.assets.sounds,zi.assets.shaders,zi.assets.fonts,zi.assets.bitmapFonts,zi.assets.custom].reduce(((e,t)=>e.concat(t.getFailedAssets())),[])}function Rn(e){return zi.assets.custom.get(e)??null}function Cn(e){return zi.assets.custom.add(null,e)}var In=class e{tex;frames=[new f(0,0,1,1)];anims={};slice9=null;constructor(e,t,n={},s=null){this.tex=e,t&&(this.frames=t),this.anims=n,this.slice9=s}get width(){return this.tex.width*this.frames[0].w}get height(){return this.tex.height*this.frames[0].h}static from(t,n={}){return"string"==typeof t?e.fromURL(t,n):Promise.resolve(e.fromImage(t,n))}static fromImage(t,n={}){let[s,r]=n.singular?zi.assets.packer.addSingle(t):zi.assets.packer.add(t),i=n.frames?n.frames.map((e=>new f(r.x+e.x*r.w,r.y+e.y*r.h,e.w*r.w,e.h*r.h))):Dn(n.sliceX||1,n.sliceY||1,r.x,r.y,r.w,r.h);return new e(s,i,n.anims,n.slice9)}static fromURL(t,n={}){return qn(t).then((t=>e.fromImage(t,n)))}};function Pn(e){if("string"==typeof e){let t=Tn(e);if(t)return t;if(kn()<1)return null;throw new Error(`Sprite not found: ${e}`)}if(e instanceof In)return xn.loaded(e);if(e instanceof xn)return e;throw new Error(`Invalid sprite: ${e}`)}function Tn(e){return zi.assets.sprites.get(e)??null}function Fn(e,t,n={sliceX:1,sliceY:1,anims:{}}){return t=An(t),Array.isArray(t)?t.some((e=>"string"==typeof e))?zi.assets.sprites.add(e,Promise.all(t.map((e=>"string"==typeof e?qn(e):Promise.resolve(e)))).then((e=>On(e,n)))):zi.assets.sprites.addLoaded(e,On(t,n)):"string"==typeof t?zi.assets.sprites.add(e,In.from(t,n)):zi.assets.sprites.addLoaded(e,In.fromImage(t,n))}function Dn(e=1,t=1,n=0,s=0,r=1,i=1){let a=[],o=r/e,l=i/t;for(let r=0;r<t;r++)for(let t=0;t<e;t++)a.push(new f(n+t*o,s+r*l,o,l));return a}function On(e,t={}){let n=document.createElement("canvas"),s=e[0].width,r=e[0].height;n.width=s*e.length,n.height=r;let i=n.getContext("2d");if(!i)throw new Error("Failed to create canvas context");e.forEach(((e,t)=>{e instanceof ImageData?i.putImageData(e,t*s,0):i.drawImage(e,t*s,0)}));let a=i.getImageData(0,0,e.length*s,r);return In.fromImage(a,{...t,sliceX:e.length,sliceY:1})}function Un(e="bean"){return Fn(e,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAA1CAYAAADyMeOEAAAAAXNSR0IArs4c6QAAAoVJREFUaIHdm7txwkAQhheGAqACiCHzOKQDQrqgILpwSAeEDBnEUAF0gCMxZ7G72qce/mec2Lpf9+3unaS78wgSNZ8uX5729+d1FNWXUuGmXlBOUUEIMckEpeQJgBu6C+BSFngztBR2vd+ovY+7g+p6LbgaWgJrAeUkDYIUXgXdBBwNi6kpABJwMTQH3AZsXRR8GHTfgEth8E3gjdAUcNewpbTgY85sCMCUuOokozE0YM0YRzM9NGAAXd8+omAF5h4lnmBRvpSnZHyLoLEbaN+aKB9KWv/KWw0tAbbANnlG+UvB2dm77NxxdwgBpjrF/d7rW9cbmpvio2A5z8iAYpVU8pGZlo6/2+MSco2lHfd3rv9jAP038e1xef9o2mjvYb2OqpqKE81028/jeietlSEVO5FRWsxWsJit1G3aFpW8iWe5RwpiCZAk25QvV6nz6fIlynRGuTd5WqpJ4guAlDfVKBK87hXljflgv1ON6fV+4+5gVlA17SfeG0heKqQd4l4jI/wrmaA9N9R4ar+wpHJDZyrrfcH0nB66PqAzPi76pn+faSyJk/vzOorYhGurQrzj/P68jtBMawHaHBIR9xoD5O34dy0qQOSYHvqExq2TpT2nf76+w7y251OYF0CRaU+J920TwLUa6inx6OxE6g80lu2ux7Y2eJLF/rCXE6zEPdnenk9o+4ih9AEdnW2q81HXl5LuU6OTl2fXUhqganbXAGq3g6jJOWV/OnoesO6YqqEB/GdNsjf7uHtwj2DzmRNpp7iOZfm6D9oAxB6Yi1gC4oIYeo4MIPdopEQRB+cAko5J1tW386HpB2Kz1eop4Epdwls/kgZ1sh8gZsEjdcWkr//D8Qu3Z3l5Nl1NtAAAAABJRU5ErkJggg==")}function Ln(e,t,n){t=An(t),n=An(n),"string"==typeof t&&!n&&(n=(e=>e.split(".").slice(0,-1).join("."))(t)+".json");let s="string"==typeof n?En(n):Promise.resolve(n);return zi.assets.sprites.add(e,s.then((e=>{let n=e.meta.size,s=e.frames.map((e=>new f(e.frame.x/n.w,e.frame.y/n.h,e.frame.w/n.w,e.frame.h/n.h))),r={};for(let t of e.meta.frameTags)t.from===t.to?r[t.name]=t.from:r[t.name]={from:t.from,to:t.to,speed:10,loop:!0,pingpong:"pingpong"===t.direction};return In.from(t,{frames:s,anims:r})})))}var Nn=class{fontface;filter=Oe;outline=null;size=64;constructor(e,t={}){if(this.fontface=e,this.filter=t.filter??Oe,this.size=t.size??64,this.size>256)throw new Error("Max font size: 256");t.outline&&(this.outline={width:1,color:r(0,0,0)},"number"==typeof t.outline?this.outline.width=t.outline:"object"==typeof t.outline&&(t.outline.width&&(this.outline.width=t.outline.width),t.outline.color&&(this.outline.color=t.outline.color)))}};function Hn(e){if(!e)return Hn(zi.globalOpt.font??Fe);if("string"==typeof e){let t=Gn(e),n=jn(e);if(t)return t.data??t;if(n)return n.data??n;if(document.fonts.check(`64px ${e}`))return e;if(kn()<1)return null;throw new Error(`Font not found: ${e}`)}return e instanceof xn&&e.data?e.data:e}function jn(e){return zi.assets.fonts.get(e)??null}function Kn(e,t,n={}){let s=An(t),r=new FontFace(e,"string"==typeof t?`url(${s})`:s);return document.fonts.add(r),zi.assets.fonts.add(e,r.load().catch((e=>{throw new Error(`Failed to load font from "${s}": ${e}`)})).then((e=>new Nn(e,n))))}function Gn(e){return zi.assets.bitmapFonts.get(e)??null}function Vn(e,t,n,s,r={}){let i=An(t);return zi.assets.bitmapFonts.add(e,qn(i).then((e=>function(e,t,n,s){let r=e.width/t,i={},a=s.split("").entries();for(let[e,s]of a)i[s]=new f(e%r*t,Math.floor(e/r)*n,t,n);return{tex:e,map:i,size:n}}(us.fromImage(zi.gfx.ggl,e,r),n,s,r.chars??Pe))))}function Yn(e,t){return t=An(t),zi.assets.sprites.add(e,new Promise((async e=>{let n="string"==typeof t?await En(t):t,s=await Promise.all(n.frames.map(qn)),r=document.createElement("canvas");r.width=n.width,r.height=n.height*n.frames.length;let i=r.getContext("2d");if(!i)throw new Error("Failed to create canvas context");s.forEach(((e,t)=>{i.drawImage(e,0,t*n.height)})),e(await Fn(null,r,{sliceY:n.frames.length,anims:n.anims}))})))}var Xn=class{ctx;glProgram;constructor(e,t,n,s){this.ctx=e,e.onDestroy((()=>this.free()));let r=e.gl,i=r.createShader(r.VERTEX_SHADER),a=r.createShader(r.FRAGMENT_SHADER);if(!i||!a)throw new Error("Failed to create shader");r.shaderSource(i,t),r.shaderSource(a,n),r.compileShader(i),r.compileShader(a);let o=r.createProgram();if(this.glProgram=o,r.attachShader(o,i),r.attachShader(o,a),s.forEach(((e,t)=>r.bindAttribLocation(o,t,e))),r.linkProgram(o),!r.getProgramParameter(o,r.LINK_STATUS)){let e=r.getShaderInfoLog(i);if(e)throw new Error("VERTEX SHADER "+e);let t=r.getShaderInfoLog(a);if(t)throw new Error("FRAGMENT SHADER "+t)}r.deleteShader(i),r.deleteShader(a)}bind(){this.ctx.pushProgram(this.glProgram)}unbind(){this.ctx.popProgram()}send(e){let t=this.ctx.gl;for(let n in e){let r=e[n],i=t.getUniformLocation(this.glProgram,n);if("number"==typeof r)t.uniform1f(i,r);else if(r instanceof w)t.uniformMatrix4fv(i,!1,new Float32Array(r.m));else if(r instanceof s)t.uniform3f(i,r.r,r.g,r.b);else if(r instanceof d)t.uniform2f(i,r.x,r.y);else{if(!Array.isArray(r))throw new Error("Unsupported uniform data type");r[0];"number"==typeof r[0]?t.uniform1fv(i,r):Ze(r)?t.uniform2fv(i,r.map((e=>[e.x,e.y])).flat()):Je(r)&&t.uniform3fv(i,r.map((e=>[e.r,e.g,e.b])).flat())}}}free(){this.ctx.gl.deleteProgram(this.glProgram)}};function zn(e,t=je,n=Ke){let s=Ne.replace("{{user}}",t??je),r=He.replace("{{user}}",n??Ke);try{return new Xn(e,s,r,Ue.map((e=>e.name)))}catch(e){let t=/(?<type>^\w+) SHADER ERROR: 0:(?<line>\d+): (?<msg>.+)/,n=ot(e).match(t);if(!n?.groups)throw e;let s=Number(n.groups.line)-14,r=n.groups.msg.trim(),i=n.groups.type.toLowerCase();throw new Error(`${i} shader line ${s}: ${r}`)}}function Qn(e){return zi.assets.shaders.get(e)??null}function Wn(e,t,n){return zi.assets.shaders.addLoaded(e,zn(zi.gfx.ggl,t,n))}function Jn(e,t,n){t=An(t),n=An(n);let s=e=>e?function(e){return bn(e).then((e=>e.text()))}(e):Promise.resolve(null),r=Promise.all([s(t),s(n)]).then((([e,t])=>zn(zi.gfx.ggl,e,t)));return zi.assets.shaders.add(e,r)}var Zn=class e{buf;constructor(e){this.buf=e}static fromArrayBuffer(t){return new Promise(((e,n)=>zi.audio.ctx.decodeAudioData(t,e,n))).then((t=>new e(t)))}static fromURL(t){return rt(t)?e.fromArrayBuffer($e(t)):function(e){return bn(e).then((e=>e.arrayBuffer()))}(t).then((t=>e.fromArrayBuffer(t)))}};function _n(e){return zi.assets.sounds.get(e)??null}function $n(e,t){return t=An(t),zi.assets.sounds.add(e,"string"==typeof t?Zn.fromURL(t):Zn.fromArrayBuffer(t))}function es(e,t){let n=An(t);return new Audio(n).preload="auto",zi.assets.music[e]=n}function ts(e,t){return e=An(e),Cn("string"==typeof t?new Promise(((n,s)=>{En(t).then((t=>{ts(e,t).then(n).catch(s)}))})):In.from(e).then((e=>{let n={};for(let s in t){let r=t[s],i=e.frames[0],a=2048*i.w,o=2048*i.h,l=r.frames?r.frames.map((e=>new f(i.x+(r.x+e.x)/a*i.w,i.y+(r.y+e.y)/o*i.h,e.w/a*i.w,e.h/o*i.h))):Dn(r.sliceX||1,r.sliceY||1,i.x+r.x/a*i.w,i.y+r.y/o*i.h,r.width/a*i.w,r.height/o*i.h),h=new In(e.tex,l,r.anims);zi.assets.sprites.addLoaded(s,h),n[s]=h}return n})))}function ns(e,t,n=!1,s,r,i={}){let a=s??zi.gfx.defTex,o=function(e){if(!e)return zi.gfx.defShader;if("string"==typeof e){let t=Qn(e);if(t)return t.data??t;if(kn()<1)return null;throw new Error(`Shader not found: ${e}`)}return e instanceof xn&&e.data?e.data:e}(r??zi.gfx.defShader);if(!o||o instanceof xn)return;let l=zi.gfx.fixed||n?zi.gfx.transform:zi.game.cam.transform.mult(zi.gfx.transform),h=[];for(let t of e){let e=nn(l.multVec2(t.pos));h.push(e.x,e.y,t.uv.x,t.uv.y,t.color.r/255,t.color.g/255,t.color.b/255,t.opacity)}zi.gfx.renderer.push(zi.gfx.ggl.gl.TRIANGLES,h,t,o,a,i)}function ss(e){if(!e.pts)throw new Error('drawPolygon() requires property "pts".');let t=e.pts.length;if(!(t<3)){if(ln(),on(e.pos),un(e.scale),dn(e.angle),on(e.offset),!1!==e.fill){let n,r=e.color??s.WHITE,i=e.pts.map(((t,n)=>({pos:new d(t.x,t.y),uv:e.uv?e.uv[n]:new d(0,0),color:e.colors&&e.colors[n]?e.colors[n].mult(r):r,opacity:e.opacity??1})));n=e.triangulate?Ce(e.pts).map((t=>t.map((t=>e.pts.indexOf(t))))).flat():[...Array(t-2).keys()].map((e=>[0,e+1,e+2])).flat(),ns(i,e.indices??n,e.fixed,e.uv?e.tex:zi.gfx.defTex,e.shader,e.uniform??void 0)}e.outline&&os({pts:[...e.pts,e.pts[0]],radius:e.radius,width:e.outline.width,color:e.outline.color,join:e.outline.join,uniform:e.uniform,fixed:e.fixed,opacity:e.opacity??e.outline.opacity}),cn()}}function rs(e){if(void 0===e.radiusX||void 0===e.radiusY)throw new Error('drawEllipse() requires properties "radiusX" and "radiusY".');if(0===e.radiusX||0===e.radiusY)return;let t=e.start??0,n=e.end??360,s=Vt(e.anchor??"center").scale(new d(-e.radiusX,-e.radiusY)),r=sn(s,e.radiusX,e.radiusY,t,n,e.resolution);r.unshift(s);let i=Object.assign({},e,{pts:r,radius:0,...e.gradient?{colors:[e.gradient[0],...Array(r.length-1).fill(e.gradient[1])]}:{}});if(n-t>=360&&e.outline)return!1!==e.fill&&ss(Object.assign({},i,{outline:null})),void ss(Object.assign({},i,{pts:r.slice(1),fill:!1}));ss(i)}function is(e){if("number"!=typeof e.radius)throw new Error('drawCircle() requires property "radius".');0!==e.radius&&rs(Object.assign({},e,{radiusX:e.radius,radiusY:e.radius,angle:0}))}function as(e){let{p1:t,p2:n}=e;if(!t||!n)throw new Error('drawLine() requires properties "p1" and "p2".');let r=e.width||1,i=n.sub(t).unit().normal().scale(.5*r);ns([t.sub(i),t.add(i),n.add(i),n.sub(i)].map((t=>({pos:new d(t.x,t.y),uv:new d(0),color:e.color??s.WHITE,opacity:e.opacity??1}))),[0,1,3,1,2,3],e.fixed,zi.gfx.defTex,e.shader,e.uniform??void 0)}function os(e){let t=e.pts,n=e.width??1;if(!t)throw new Error('drawLines() requires property "pts".');if(!(t.length<2)){if(t.length>2)switch(e.join){case"bevel":return function(e){let t,n=e.pts,r=[],i=.5*(e.width||1),a=n[0]===n[n.length-1]||n[0].eq(n[n.length-1]),o=e.pos||c(0,0);t=a?n[0].sub(n[n.length-2]):n[1].sub(n[0]);let l,h=t.len(),u=t.normal().scale(-i/h),d=n[0];if(!a)switch(e.cap){case"square":{let e=t.scale(-i/h);r.push(d.add(e).add(u)),r.push(d.add(e).sub(u));break}case"round":{let e=Math.max(i,10),t=Math.PI/e,n=u.scale(-1),s=Math.cos(t),a=Math.sin(t);for(let t=0;t<e;t++)r.push(d),r.push(d.sub(n)),n=c(n.x*s-n.y*a,n.x*a+n.y*s)}}for(let e=1;e<n.length;e++){if(d===n[e]||d.eq(n[e]))continue;l=d,d=n[e];let s=d.sub(l),a=s.len(),o=s.normal().scale(-i/a),c=t.cross(s);if(Math.abs(c)/(h*a)<.05){r.push(l.add(u)),r.push(l.sub(u)),t.dot(s)<0&&(r.push(l.sub(u)),r.push(l.add(u))),t=s,h=a,u=o;continue}let f=o.sub(u).cross(s)/c,p=u.add(t.scale(f));c>0?(r.push(l.add(p)),r.push(l.sub(u)),r.push(l.add(p)),r.push(l.sub(o))):(r.push(l.add(u)),r.push(l.sub(p)),r.push(l.add(o)),r.push(l.sub(p))),t=s,h=a,u=o}if(!a)switch(r.push(d.add(u)),r.push(d.sub(u)),e.cap){case"square":{let e=t.scale(i/h);r.push(d.add(e).add(u)),r.push(d.add(e).sub(u));break}case"round":{let e=Math.max(i,10),t=Math.PI/e,n=u.scale(1),s=Math.cos(t),a=Math.sin(t);for(let t=0;t<e;t++)n=c(n.x*s-n.y*a,n.x*a+n.y*s),r.push(d),r.push(d.sub(n))}}if(r.length<4)return;let f=r.map((t=>({pos:o.add(t),uv:c(),color:e.color||s.WHITE,opacity:e.opacity??1}))),p=[],g=0;for(let e=0;e<r.length-2;e+=2)p[g++]=e+1,p[g++]=e,p[g++]=e+2,p[g++]=e+2,p[g++]=e+3,p[g++]=e+1;a&&(p[g++]=r.length-1,p[g++]=r.length-2,p[g++]=0,p[g++]=0,p[g++]=1,p[g++]=r.length-1),ns(f,p,e.fixed,zi.gfx.defTex,e.shader,e.uniform??void 0)}(e);case"round":return function(e){let t,n=e.pts,r=[],i=.5*(e.width||1),o=n[0]===n[n.length-1]||n[0].eq(n[n.length-1]),l=e.pos||c(0,0);t=o?n[0].sub(n[n.length-2]):n[1].sub(n[0]);let h,u=t.len(),d=t.normal().scale(-i/u),f=n[0];if(!o)switch(e.cap){case"square":{let e=t.scale(-i/u);r.push(f.add(e).add(d)),r.push(f.add(e).sub(d));break}case"round":{let e=Math.max(i,10),t=Math.PI/e,n=d.scale(-1),s=Math.cos(t),a=Math.sin(t);for(let t=0;t<e;t++)r.push(f),r.push(f.sub(n)),n=c(n.x*s-n.y*a,n.x*a+n.y*s)}}for(let e=1;e<n.length;e++){if(f===n[e]||f.eq(n[e]))continue;h=f,f=n[e];let s=f.sub(h),o=s.len(),l=s.normal().scale(-i/o),p=t.cross(s);if(Math.abs(p)/(u*o)<.05){r.push(h.add(d)),r.push(h.sub(d)),t.dot(s)<0&&(r.push(h.sub(d)),r.push(h.add(d))),t=s,u=o,d=l;continue}let g=l.sub(d).cross(s)/p,m=d.add(t.scale(g));if(p>0){let e=h.add(m),t=Math.max(i,10),n=a(d.angleBetween(l)/t),s=d,o=Math.cos(n),u=Math.sin(n);for(let n=0;n<t;n++)r.push(e),r.push(h.sub(s)),s=c(s.x*o-s.y*u,s.x*u+s.y*o)}else{let e=h.sub(m),t=Math.max(i,10),n=a(d.angleBetween(l)/t),s=d,o=Math.cos(n),u=Math.sin(n);for(let n=0;n<t;n++)r.push(h.add(s)),r.push(e),s=c(s.x*o-s.y*u,s.x*u+s.y*o)}t=s,u=o,d=l}if(!o)switch(r.push(f.add(d)),r.push(f.sub(d)),e.cap){case"square":{let e=t.scale(i/u);r.push(f.add(e).add(d)),r.push(f.add(e).sub(d));break}case"round":{let e=Math.max(i,10),t=Math.PI/e,n=d.scale(1),s=Math.cos(t),a=Math.sin(t);for(let t=0;t<e;t++)n=c(n.x*s-n.y*a,n.x*a+n.y*s),r.push(f),r.push(f.sub(n))}}if(r.length<4)return;let p=r.map((t=>({pos:l.add(t),uv:c(),color:e.color||s.WHITE,opacity:e.opacity??1}))),g=[],m=0;for(let e=0;e<r.length-2;e+=2)g[m++]=e+1,g[m++]=e,g[m++]=e+2,g[m++]=e+2,g[m++]=e+3,g[m++]=e+1;o&&(g[m++]=r.length-1,g[m++]=r.length-2,g[m++]=0,g[m++]=0,g[m++]=1,g[m++]=r.length-1),ns(p,g,e.fixed,zi.gfx.defTex,e.shader,e.uniform??void 0)}(e);case"miter":return function(e){let t,n=e.pts,r=[],i=.5*(e.width||1),a=n[0]===n[n.length-1]||n[0].eq(n[n.length-1]),o=e.pos||c(0,0);t=a?n[0].sub(n[n.length-2]):n[1].sub(n[0]);let l,h=t.len(),u=t.normal().scale(-i/h),d=n[0];if(!a)switch(e.cap){case"square":{let e=t.scale(-i/h);r.push(d.add(e).add(u)),r.push(d.add(e).sub(u));break}case"round":{let e=Math.max(i,10),t=Math.PI/e,n=u.scale(-1),s=Math.cos(t),a=Math.sin(t);for(let t=0;t<e;t++)r.push(d),r.push(d.sub(n)),n=c(n.x*s-n.y*a,n.x*a+n.y*s)}}for(let e=1;e<n.length;e++){if(d===n[e]||d.eq(n[e]))continue;l=d,d=n[e];let s=d.sub(l),a=s.len(),o=s.normal().scale(-i/a),c=t.cross(s);if(Math.abs(c)/(h*a)<.05){r.push(l.add(u)),r.push(l.sub(u)),t.dot(s)<0&&(r.push(l.sub(u)),r.push(l.add(u))),t=s,h=a,u=o;continue}let f=o.sub(u).cross(s)/c,p=u.add(t.scale(f));r.push(l.add(p)),r.push(l.sub(p)),t=s,h=a,u=o}if(!a)switch(r.push(d.add(u)),r.push(d.sub(u)),e.cap){case"square":{let e=t.scale(i/h);r.push(d.add(e).add(u)),r.push(d.add(e).sub(u));break}case"round":{let e=Math.max(i,10),t=Math.PI/e,n=u.scale(1),s=Math.cos(t),a=Math.sin(t);for(let t=0;t<e;t++)n=c(n.x*s-n.y*a,n.x*a+n.y*s),r.push(d),r.push(d.sub(n))}}if(r.length<4)return;let f=r.map((t=>({pos:o.add(t),uv:c(),color:e.color||s.WHITE,opacity:e.opacity??1}))),p=[],g=0;for(let e=0;e<r.length-2;e+=2)p[g++]=e+1,p[g++]=e,p[g++]=e+2,p[g++]=e+2,p[g++]=e+3,p[g++]=e+1;a&&(p[g++]=r.length-1,p[g++]=r.length-2,p[g++]=0,p[g++]=0,p[g++]=1,p[g++]=r.length-1),ns(f,p,e.fixed,zi.gfx.defTex,e.shader,e.uniform??void 0)}(e)}if(e.radius&&t.length>=3){as(Object.assign({},e,{p1:t[0],p2:t[1]}));for(let n=1;n<t.length-2;n++){let s=t[n],r=t[n+1];as(Object.assign({},e,{p1:s,p2:r}))}as(Object.assign({},e,{p1:t[t.length-2],p2:t[t.length-1]}))}else for(let s=0;s<t.length-1;s++)as(Object.assign({},e,{p1:t[s],p2:t[s+1]})),"none"!==e.join&&is(Object.assign({},e,{pos:t[s],radius:n/2}))}}function ls(e,t){let n=t.segments??16,s=[];for(let t=0;t<=n;t++)s.push(e(t/n));os({pts:s,width:t.width||1,pos:t.pos,color:t.color,opacity:t.opacity})}function hs(e){ls((t=>ie(e.pt1,e.pt2,e.pt3,e.pt4,t)),e)}var us=class e{ctx;src=null;glTex;width;height;constructor(e,t,n,s={}){this.ctx=e;let r=e.gl,i=e.gl.createTexture();if(!i)throw new Error("Failed to create texture");this.glTex=i,e.onDestroy((()=>this.free())),this.width=t,this.height=n;let a={linear:r.LINEAR,nearest:r.NEAREST}[s.filter??e.opts.texFilter??"nearest"],o={repeat:r.REPEAT,clampToEdge:r.CLAMP_TO_EDGE}[s.wrap??"clampToEdge"];this.bind(),t&&n&&r.texImage2D(r.TEXTURE_2D,0,r.RGBA,t,n,0,r.RGBA,r.UNSIGNED_BYTE,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,a),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,a),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,o),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,o),r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),this.unbind()}static fromImage(t,n,s={}){let r=new e(t,n.width,n.height,s);return r.update(n),r.src=n,r}update(e,t=0,n=0){let s=this.ctx.gl;this.bind(),s.texSubImage2D(s.TEXTURE_2D,0,t,n,s.RGBA,s.UNSIGNED_BYTE,e),this.unbind()}bind(){this.ctx.pushTexture2D(this.glTex)}unbind(){this.ctx.popTexture2D()}free(){this.ctx.gl.deleteTexture(this.glTex)}},ds=class{ctx;tex;glFramebuffer;glRenderbuffer;constructor(e,t,n,s={}){this.ctx=e;let r=e.gl;e.onDestroy((()=>this.free())),this.tex=new us(e,t,n,s);let i=r.createFramebuffer(),a=r.createRenderbuffer();if(!i||!a)throw new Error("Failed to create framebuffer");this.glFramebuffer=i,this.glRenderbuffer=a,this.bind(),r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_STENCIL,t,n),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this.tex.glTex,0),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_STENCIL_ATTACHMENT,r.RENDERBUFFER,this.glRenderbuffer),this.unbind()}get width(){return this.tex.width}get height(){return this.tex.height}toImageData(){let e=this.ctx.gl,t=new Uint8ClampedArray(this.width*this.height*4);this.bind(),e.readPixels(0,0,this.width,this.height,e.RGBA,e.UNSIGNED_BYTE,t),this.unbind();let n=4*this.width,s=new Uint8Array(n);for(let e=0;e<(this.height/2|0);e++){let r=e*n,i=(this.height-e-1)*n;s.set(t.subarray(r,r+n)),t.copyWithin(r,i,i+n),t.set(s,i)}return new ImageData(t,this.width,this.height)}toDataURL(){let e=document.createElement("canvas"),t=e.getContext("2d");if(e.width=this.width,e.height=this.height,!t)throw new Error("Failed to get 2d context");return t.putImageData(this.toImageData(),0,0),e.toDataURL()}clear(){let e=this.ctx.gl;e.clear(e.COLOR_BUFFER_BIT)}draw(e){this.bind(),e(),this.unbind()}bind(){this.ctx.pushFramebuffer(this.glFramebuffer),this.ctx.pushRenderbuffer(this.glRenderbuffer),this.ctx.pushViewport({x:0,y:0,w:this.width,h:this.height})}unbind(){this.ctx.popFramebuffer(),this.ctx.popRenderbuffer(),this.ctx.popViewport()}free(){let e=this.ctx.gl;e.deleteFramebuffer(this.glFramebuffer),e.deleteRenderbuffer(this.glRenderbuffer),this.tex.free()}},cs=class{ctx;glVBuf;glIBuf;vqueue=[];iqueue=[];stride;maxVertices;maxIndices;vertexFormat;numDraws=0;curPrimitive=null;curTex=null;curShader=null;curUniform={};constructor(e,t,n,s){let r=e.gl;this.vertexFormat=t,this.ctx=e,this.stride=t.reduce(((e,t)=>e+t.size),0),this.maxVertices=n,this.maxIndices=s;let i=r.createBuffer();if(!i)throw new Error("Failed to create vertex buffer");this.glVBuf=i,e.pushArrayBuffer(this.glVBuf),r.bufferData(r.ARRAY_BUFFER,4*n,r.DYNAMIC_DRAW),e.popArrayBuffer(),this.glIBuf=r.createBuffer(),e.pushElementArrayBuffer(this.glIBuf),r.bufferData(r.ELEMENT_ARRAY_BUFFER,4*s,r.DYNAMIC_DRAW),e.popElementArrayBuffer()}push(e,t,n,s,r=null,i={}){(e!==this.curPrimitive||r!==this.curTex||s!==this.curShader||!it(this.curUniform,i)||this.vqueue.length+t.length*this.stride>this.maxVertices||this.iqueue.length+n.length>this.maxIndices)&&this.flush();let a=this.vqueue.length/this.stride;for(let e of t)this.vqueue.push(e);for(let e of n)this.iqueue.push(e+a);this.curPrimitive=e,this.curShader=s,this.curTex=r,this.curUniform=i}flush(){if(!this.curPrimitive||!this.curShader||0===this.vqueue.length||0===this.iqueue.length)return;let e=this.ctx.gl;this.ctx.pushArrayBuffer(this.glVBuf),e.bufferSubData(e.ARRAY_BUFFER,0,new Float32Array(this.vqueue)),this.ctx.pushElementArrayBuffer(this.glIBuf),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,0,new Uint16Array(this.iqueue)),this.ctx.setVertexFormat(this.vertexFormat),this.curShader.bind(),this.curShader.send(this.curUniform),this.curTex?.bind(),e.drawElements(this.curPrimitive,this.iqueue.length,e.UNSIGNED_SHORT,0),this.curTex?.unbind(),this.curShader.unbind(),this.ctx.popArrayBuffer(),this.ctx.popElementArrayBuffer(),this.vqueue=[],this.iqueue=[],this.numDraws++}free(){let e=this.ctx.gl;e.deleteBuffer(this.glVBuf),e.deleteBuffer(this.glIBuf)}};function fs(e){let t=[],n=()=>t[t.length-1];return[n=>{t.push(n),e(n)},()=>{t.pop(),e(n()??null)},n]}var ps={};function gs(e,t){t.override?Object.assign(e,t):(t.pos&&(e.pos=e.pos.add(t.pos)),t.scale&&(e.scale=e.scale.scale(c(t.scale))),t.angle&&(e.angle+=t.angle),t.color&&1===e.ch.length&&(e.color=e.color.mult(t.color)),null!=t.opacity&&(e.opacity*=t.opacity))}function ms(e){let t={},n="",s=[],r=String(e),i=e=>{s.length>0&&(t[n.length]=s.slice()),n+=e};for(;""!==r;)if("\\"!==r[0])if("["!==r[0])i(r[0]),r=r.slice(1);else{let e=/^\[(\/)?(\w+?)\]/.exec(r);if(!e){i(r[0]),r=r.slice(1);continue}let[t,n,a]=e;if(void 0!==n){let e=s.pop();if(e!==a)throw void 0!==e?new Error(`Styled text error: mismatched tags. Expected [/${e}], got [/${a}]`):new Error(`Styled text error: stray end tag [/${a}]`)}else s.push(a);r=r.slice(t.length)}else{if(1===r.length)throw new Error("Styled text error: \\ at end of string");i(r[1]),r=r.slice(2)}if(s.length>0)throw new Error(`Styled text error: unclosed tags ${s}`);return{charStyleMap:t,text:n}}function ws(e){if(void 0===e.text)throw new Error('formatText() requires property "text".');let t=Hn(e.font);if(!e.text||""===e.text||t instanceof xn||!t)return{width:0,height:0,chars:[],opt:e,renderedText:""};let{charStyleMap:n,text:r}=ms(e.text+""),i=function(e){if("string"!=typeof e)throw new TypeError("string cannot be undefined or null");let t=[],n=0,s=0;for(;n<e.length;)s+=ct(n+s,e),mt(e[n+s])&&s++,pt(e[n+s])&&s++,gt(e[n+s])&&s++,wt(e[n+s])?s++:(t.push(e.substring(n,n+s)),n+=s,s=0);return t}(r);if(t instanceof Nn||"string"==typeof t){let e=t instanceof Nn?t.fontface.family:t,n=t instanceof Nn?{outline:t.outline,filter:t.filter}:{outline:null,filter:Oe},s=ps[e]??{font:{tex:new us(zi.gfx.ggl,2048,2048,{filter:n.filter}),map:{},size:64},cursor:new d(0),maxHeight:0,outline:n.outline};ps[e]||(ps[e]=s),t=s.font;for(let n of i)if(!s.font.map[n]){let r=zi.fontCacheC2d;if(!r)throw new Error("fontCacheC2d is not defined.");if(!zi.fontCacheCanvas)throw new Error("fontCacheCanvas is not defined.");r.clearRect(0,0,zi.fontCacheCanvas.width,zi.fontCacheCanvas.height),r.font=`${t.size}px ${e}`,r.textBaseline="top",r.textAlign="left",r.fillStyle="#ffffff";let i=r.measureText(n),a=Math.ceil(i.width);if(!a)continue;let o=Math.ceil(Math.abs(i.actualBoundingBoxAscent))+Math.ceil(Math.abs(i.actualBoundingBoxDescent));s.outline&&s.outline.width&&s.outline.color&&(r.lineJoin="round",r.lineWidth=2*s.outline.width,r.strokeStyle=s.outline.color.toHex(),r.strokeText(n,s.outline.width,s.outline.width),a+=2*s.outline.width,o+=3*s.outline.width),r.fillText(n,s.outline?.width??0,s.outline?.width??0);let l=r.getImageData(0,0,a,o);if(s.cursor.x+a>2048&&(s.cursor.x=0,s.cursor.y+=s.maxHeight,s.maxHeight=0,s.cursor.y>2048))throw new Error("Font atlas exceeds character limit");t.tex.update(l,s.cursor.x,s.cursor.y),t.map[n]=new f(s.cursor.x,s.cursor.y,a,o),s.cursor.x+=a+1,s.maxHeight=Math.max(s.maxHeight,o)}}let a,o=e.size||t.size,l=c(e.scale??1).scale(o/t.size),h=e.lineSpacing??0,u=e.letterSpacing??0,p=0,g=0,m=0,w=[],y=[],A=0,x=null,v=0;for(;A<i.length;){let n=i[A];if("\n"===n)m+=o+h,w.push({width:p-u,chars:y}),x=null,v=0,p=0,y=[],a=void 0;else{let r=t.map[n];if(r){let b=r.w*l.x;e.width&&p+b>e.width&&(m+=o+h,null!=x&&(A-=y.length-x,n=i[A],r=t.map[n],b=r.w*l.x,y=y.slice(0,x-1),p=v),x=null,v=0,w.push({width:p-u,chars:y}),p=a??0,y=[]),y.push({tex:t.tex,width:r.w,height:r.h,quad:new f(r.x/t.tex.width,r.y/t.tex.height,r.w/t.tex.width,r.h/t.tex.height),ch:n,pos:new d(p,m),opacity:e.opacity??1,color:e.color??s.WHITE,scale:c(l),angle:0})," "===n&&(x=y.length,v=p),e.indentAll&&void 0===a&&/\S/.test(n)&&(a=p),p+=b,g=Math.max(g,p),p+=u}}A++}w.push({width:p-u,chars:y}),m+=o,e.width&&(g=e.width);let b=[];for(let s=0;s<w.length;s++){let r=(g-w[s].width)*Yt(e.align??"left");for(let i of w[s].chars){let a=t.map[i.ch],o=b.length+s;if(i.pos=i.pos.add(r,0).add(a.w*l.x*.5,a.h*l.y*.5),e.transform){let t="function"==typeof e.transform?e.transform(o,i.ch):e.transform;t&&gs(i,t)}if(n[o]){let t=n[o];for(let n of t){let t=e.styles?.[n],s="function"==typeof t?t(o,i.ch):t;s&&gs(i,s)}}b.push(i)}}return{width:g,height:m,chars:b,opt:e,renderedText:r}}function ys(e){if(void 0===e.width||void 0===e.height)throw new Error('drawUVQuad() requires property "width" and "height".');if(e.width<=0||e.height<=0)return;let t=e.width,n=e.height,s=Vt(e.anchor||Te).scale(new d(t,n).scale(-.5)),i=e.quad||new f(0,0,1,1),a=e.color||r(255,255,255),o=e.opacity??1,l=e.tex?.1/e.tex.width:0,h=e.tex?.1/e.tex.height:0,u=i.x+l,c=i.y+h,p=i.w-2*l,g=i.h-2*h;ln(),on(e.pos),dn(e.angle),un(e.scale),on(s),ns([{pos:new d(-t/2,n/2),uv:new d(e.flipX?u+p:u,e.flipY?c:c+g),color:a,opacity:o},{pos:new d(-t/2,-n/2),uv:new d(e.flipX?u+p:u,e.flipY?c+g:c),color:a,opacity:o},{pos:new d(t/2,-n/2),uv:new d(e.flipX?u:u+p,e.flipY?c+g:c),color:a,opacity:o},{pos:new d(t/2,n/2),uv:new d(e.flipX?u:u+p,e.flipY?c:c+g),color:a,opacity:o}],[0,1,3,1,2,3],e.fixed,e.tex,e.shader,e.uniform??void 0),cn()}function As(e){ln(),on(e.opt.pos),dn(e.opt.angle),on(Vt(e.opt.anchor??"topleft").add(1,1).scale(e.width,e.height).scale(-.5)),e.chars.forEach((t=>{ys({tex:t.tex,width:t.width,height:t.height,pos:t.pos,scale:t.scale,angle:t.angle,color:t.color,opacity:t.opacity,quad:t.quad,anchor:"center",uniform:e.opt.uniform,shader:e.opt.shader,fixed:e.opt.fixed})})),cn()}function xs(e){if(void 0===e.width||void 0===e.height)throw new Error('drawRect() requires property "width" and "height".');if(e.width<=0||e.height<=0)return;let t=e.width,n=e.height,s=Vt(e.anchor||Te).add(1,1).scale(new d(t,n).scale(-.5)),r=[new d(0,0),new d(t,0),new d(t,n),new d(0,n)];if(e.radius){let s=Math.min(t,n)/2,i=Array.isArray(e.radius)?e.radius.map((e=>Math.min(s,e))):new Array(4).fill(Math.min(s,e.radius));r=[new d(i[0],0),...i[1]?sn(new d(t-i[1],i[1]),i[1],i[1],270,360):[c(t,0)],...i[2]?sn(new d(t-i[2],n-i[2]),i[2],i[2],0,90):[c(t,n)],...i[3]?sn(new d(i[3],n-i[3]),i[3],i[3],90,180):[c(0,n)],...i[0]?sn(new d(i[0],i[0]),i[0],i[0],180,270):[]]}ss(Object.assign({},e,{offset:s,pts:r,...e.gradient?{colors:e.horizontal?[e.gradient[0],e.gradient[1],e.gradient[1],e.gradient[0]]:[e.gradient[0],e.gradient[0],e.gradient[1],e.gradient[1]]}:{}}))}function vs(e){fn();let t=zi.gfx.width,n=zi.gfx.height;zi.gfx.width=zi.gfx.viewport.width,zi.gfx.height=zi.gfx.viewport.height,e(),fn(),zi.gfx.width=t,zi.gfx.height=n}function bs(e,t){vs((()=>{let n=c(8);ln(),on(e);let s=ws({text:t,font:De,size:16,pos:n,color:r(255,255,255),fixed:!0}),i=s.width+2*n.x,a=s.height+2*n.x;e.x+i>=pn()&&on(c(-i,0)),e.y+a>=gn()&&on(c(0,-a)),xs({width:i,height:a,color:r(0,0,0),radius:4,opacity:.8,fixed:!0}),As(s),cn()}))}function Es(e){if(!e.p1||!e.p2||!e.p3)throw new Error('drawTriangle() requires properties "p1", "p2" and "p3".');return ss(Object.assign({},e,{pts:[e.p1,e.p2,e.p3]}))}function Ms(){if(zi.debug.inspect){let e=null;for(let t of zi.game.root.get("*",{recursive:!0}))if(t.has("area")&&t.isHovering()){e=t;break}if(zi.game.root.drawInspect(),e){let t=[],n=e.inspect();for(let e in n)n[e]?t.push(`${n[e]}`):t.push(`${e}`);bs(function(e){return new d(e.x*zi.gfx.viewport.width/zi.gfx.width,e.y*zi.gfx.viewport.height/zi.gfx.height)}(zi.k.mousePos()),t.join("\n"))}bs(c(8),`FPS: ${zi.debug.fps()}`)}zi.debug.paused&&vs((()=>{ln(),on(pn(),0),on(-8,8);xs({width:32,height:32,anchor:"topright",color:r(0,0,0),opacity:.8,radius:4,fixed:!0});for(let e=1;e<=2;e++)xs({width:4,height:19.2,anchor:"center",pos:c(-32/3*e,16),color:r(255,255,255),radius:2,fixed:!0});cn()})),1!==zi.debug.timeScale&&vs((()=>{ln(),on(pn(),gn()),on(-8,-8);let e=ws({text:zi.debug.timeScale.toFixed(1),font:De,size:16,color:r(255,255,255),pos:c(-8),anchor:"botright",fixed:!0});xs({width:e.width+16+32,height:e.height+16,anchor:"botright",color:r(0,0,0),opacity:.8,radius:4,fixed:!0});for(let t=0;t<2;t++){let n=zi.debug.timeScale<1;Es({p1:c(-e.width-8*(n?2:3.5),-8),p2:c(-e.width-8*(n?2:3.5),-8-e.height),p3:c(-e.width-8*(n?3.5:2),-8-e.height/2),pos:c(8*-t*1+(n?-4:0),0),color:r(255,255,255),fixed:!0})}As(e),cn()})),zi.debug.curRecording&&vs((()=>{ln(),on(0,gn()),on(24,-24),is({radius:12,color:r(255,0,0),opacity:y(0,1,4*zi.app.time()),fixed:!0}),cn()})),zi.debug.showLog&&zi.game.logs.length>0&&vs((()=>{ln(),on(0,gn()),on(8,-8);let e=[];for(let t of zi.game.logs){let n="",s=t.msg instanceof Error?"error":"info";n+=`[time]${t.time.toFixed(2)}[/time]`,n+=" ",n+=`[${s}]${Ss(t.msg)}[/${s}]`,e.push(n)}zi.game.logs=zi.game.logs.filter((e=>zi.app.time()-e.time<(zi.globalOpt.logTime||4)));let t=ws({text:e.join("\n"),font:De,pos:c(8,-8),anchor:"botleft",size:16,width:.6*pn(),lineSpacing:4,fixed:!0,styles:{time:{color:r(127,127,127)},info:{color:r(255,255,255)},error:{color:r(255,0,127)}}});xs({width:t.width+16,height:t.height+16,anchor:"botleft",color:r(0,0,0),radius:4,opacity:.8,fixed:!0}),As(t),cn()}))}function Ss(e,t=!1,n=new Set){if(n.has(e))return"<recursive>";var s,r="";return t&&"string"==typeof e&&(e=JSON.stringify(e)),Array.isArray(e)&&(r=["[",e.map((t=>Ss(t,!0,n.union(new Set([e]))))).join(", "),"]"].join(""),e=r),null===e?"null":("object"==typeof e&&e.toString===Object.prototype.toString&&(e.constructor!==Object&&(r+=e.constructor.name+" "),r+=["{",(s=Object.getOwnPropertyNames(e).map((t=>`${/^\w+$/.test(t)?t:JSON.stringify(t)}: ${Ss(e[t],!0,n.union(new Set([e])))}`)).join(", "))?` ${s} `:"","}"].join(""),e=r),String(e).replaceAll(/(?<!\\)\[/g,"\\["))}function qs(e,t,n){let s=zi.gfx.ggl.gl;fn(),s.clear(s.STENCIL_BUFFER_BIT),s.enable(s.STENCIL_TEST),s.stencilFunc(s.NEVER,1,255),s.stencilOp(s.REPLACE,s.REPLACE,s.REPLACE),t(),fn(),s.stencilFunc(n,1,255),s.stencilOp(s.KEEP,s.KEEP,s.KEEP),e(),fn(),s.disable(s.STENCIL_TEST)}function ks(e,t){qs(e,t,zi.gfx.ggl.gl.EQUAL)}function Bs(e){if(!e.tex)throw new Error('drawTexture() requires property "tex".');let t=e.quad??new f(0,0,1,1),n=e.tex.width*t.w,r=e.tex.height*t.h,i=new d(1);if(e.tiled){let i=Vt(e.anchor||Te),a=(e.pos,i.x,e.width,e.pos,i.y,e.height,(e.width||n)/n),o=(e.height||r)/r,l=Math.floor(a),h=Math.floor(o),u=a-l,c=o-h,p=(l+u?1:0)*(h+c?1:0),g=new Array(6*p),m=new Array(4*p),w=0,y=(t,n,r,a,o)=>{g[6*w+0]=4*w+0,g[6*w+1]=4*w+1,g[6*w+2]=4*w+3,g[6*w+3]=4*w+1,g[6*w+4]=4*w+2,g[6*w+5]=4*w+3,m[4*w+0]={pos:new d(t-i.x,n-i.y),uv:new d(o.x,o.y),color:e.color||s.WHITE,opacity:e.opacity||1},m[4*w+1]={pos:new d(t+r-i.x,n-i.y),uv:new d(o.x+o.w,o.y),color:e.color||s.WHITE,opacity:e.opacity||1},m[4*w+2]={pos:new d(t+r-i.x,n+a-i.y),uv:new d(o.x+o.w,o.y+o.h),color:e.color||s.WHITE,opacity:e.opacity||1},m[4*w+3]={pos:new d(t-i.x,n+a-i.y),uv:new d(o.x,o.y+o.h),color:e.color||s.WHITE,opacity:e.opacity||1},w++};for(let e=0;e<h;e++){for(let s=0;s<l;s++)y(s*n,e*r,n,r,t);u&&y(l*n,e*r,n*u,r,new f(t.x,t.y,t.w*u,t.h))}if(c){for(let e=0;e<l;e++)y(e*n,h*r,n,r*c,new f(t.x,t.y,t.w,t.h*c));u&&y(l*n,h*r,n*u,r*c,new f(t.x,t.y,t.w*u,t.h*c))}ns(m,g,e.fixed,e.tex,e.shader,e.uniform??void 0)}else e.width&&e.height?(i.x=e.width/n,i.y=e.height/r):e.width?(i.x=e.width/n,i.y=i.x):e.height&&(i.y=e.height/r,i.x=i.y),ys(Object.assign({},e,{scale:i.scale(e.scale||new d(1)),tex:e.tex,quad:t,width:n,height:r}))}function Rs(e){if(!e.sprite)throw new Error('drawSprite() requires property "sprite"');let t=Pn(e.sprite);if(!t||!t.data)return;let n=t.data.frames[e.frame??0];if(!n)throw new Error(`Frame not found: ${e.frame??0}`);Bs(Object.assign({},e,{tex:t.data.tex,quad:n.scale(e.quad??new f(0,0,1,1))}))}function Cs(e,t){qs(e,t,zi.gfx.ggl.gl.NOTEQUAL)}function Is(e){As(ws(e))}function Ps(e){return!!e.fixed||!!e.parent&&Ps(e.parent)}function Ts(e){return{color:e.color,opacity:e.opacity,anchor:e.anchor,outline:e.outline,shader:e.shader,uniform:e.uniform}}function Fs(e,t={}){return{id:"circle",radius:e,draw(){is(Object.assign(Ts(this),{radius:this.radius,fill:t.fill}))},renderArea(){return new _(new d(this.anchor?0:-this.radius),2*this.radius,2*this.radius)},inspect(){return`radius: ${Math.ceil(this.radius)}`}}}function Ds(...e){return{id:"color",color:r(...e),inspect(){return`color: ${this.color.toString()}`}}}function Os(e){return{add(){this.canvas=e}}}function Us(e=1){let t,n=0,s=!1;return{require:["opacity"],add(){t=this.opacity,this.opacity=0},update(){s||(n+=Pt(),this.opacity=h(n,0,e,0,t),n>=e&&(this.opacity=t,s=!0))}}}function Ls(e="intersect"){return{id:"mask",mask:e}}function Ns(e){return{id:"opacity",opacity:e??1,fadeIn(e=1,t=zi.k.easings.linear){return zi.game.root.tween(0,this.opacity,e,(e=>this.opacity=e),t)},fadeOut(e=1,t=zi.k.easings.linear){return zi.game.root.tween(this.opacity,0,e,(e=>this.opacity=e),t)},inspect(){return`opacity: ${ht(this.opacity,1)}`}}}function Hs(e=1,t=r(0,0,0),n=1,s="miter",i=10,a="butt"){return{id:"outline",outline:{width:e,color:t,opacity:n,join:s,miterLimit:i,cap:a},inspect(){return`outline: ${this.outline.width}px, ${this.outline.color}`}}}var js=class{pos=c(0);vel=c(0);acc=c(0);angle=0;angularVelocity=0;damping=0;t;lt=null;gc;constructor(){this.t=0,this.gc=!0}get progress(){return this.lt?this.t/this.lt:this.t}};function Ks(e,t){let n=t.lifetime,i=[],a=e.colors||[s.WHITE],o=e.opacities||[1],u=e.quads||[new f(0,0,1,1)],p=e.scales||[1],g=e.lifeTime,m=t.direction,w=t.spread,y=e.speed||[0,0],A=e.angle||[0,0],x=e.angularVelocity||[0,0],v=e.acceleration||[c(0),c(0)],b=e.damping||[0,0],M=[],S=new Array(e.max),q=0,k=0;for(let t=0;t<e.max;t++){M[6*t+0]=4*t+0,M[6*t+1]=4*t+1,M[6*t+2]=4*t+3,M[6*t+3]=4*t+1,M[6*t+4]=4*t+2,M[6*t+5]=4*t+3;for(let e=0;e<4;e++)S[4*t+e]={pos:new d(0,0),uv:new d(0,0),color:r(255,255,255),opacity:1};i[t]=new js}let B=new Qe;function R(t=0){for(;t<e.max;){if(i[t].gc)return t;t++}return null}return{id:"particles",emit(e){let n=0;for(let s=0;s<e;s++){if(n=R(n),null==n)return;let e=E(m-w,m+w),s=d.fromAngle(e).scale(E(y[0],y[1])),r=E(A[0],A[1]),a=E(x[0],x[1]),o=c(E(v[0].x,v[1].x),E(v[0].y,v[1].y)),l=E(b[0],b[1]),h=g?E(g[0],g[1]):null,u=t.shape?t.shape.random():c(),f=i[n];f.lt=h,f.pos=u,f.vel=s,f.acc=o,f.angle=r,f.angularVelocity=a,f.damping=l,f.angularVelocity=a,f.gc=!1}q+=e},update(){if(void 0!==n&&n<=0)return;let s=Pt();for(let e of i)if(!e.gc){if(e.t+=s,e.lt&&e.t>=e.lt){e.gc=!0,q--;continue}e.vel=e.vel.add(e.acc.scale(s)).scale(1-e.damping*s),e.pos=e.pos.add(e.vel.scale(s)),e.angle+=e.angularVelocity*s}for(void 0!==n&&(n-=s,n<=0&&B.trigger()),k+=s;q<e.max&&t.rate&&k>t.rate;)this.emit(1),q++,k-=t.rate},draw(){if(!(void 0!==n&&n<=0)){for(let t=0;t<i.length;t++){let n=i[t];if(n.gc)continue;let s=n.progress,r=Math.floor(n.progress*a.length),d=r<a.length-1?l(a[r],a[r+1],h(s,r/a.length,(r+1)/a.length,0,1)):a[r],c=Math.floor(n.progress*o.length),f=c<o.length-1?l(o[c],o[c+1],h(s,c/o.length,(c+1)/o.length,0,1)):o[c],g=Math.floor(n.progress*u.length),m=u[g],w=Math.floor(n.progress*p.length),y=p[w],A=Math.cos(n.angle*Math.PI/180),x=Math.sin(n.angle*Math.PI/180),v=(e.texture?e.texture.width:10)*m.w/2,b=(e.texture?e.texture.height:10)*m.h/2,E=4*t,M=S[E];M.pos.x=n.pos.x+-v*y*A- -b*y*x,M.pos.y=n.pos.y+-v*y*x+-b*y*A,M.uv.x=m.x,M.uv.y=m.y,M.color.r=d.r,M.color.g=d.g,M.color.b=d.b,M.opacity=f,M=S[E+1],M.pos.x=n.pos.x+v*y*A- -b*y*x,M.pos.y=n.pos.y+v*y*x+-b*y*A,M.uv.x=m.x+m.w,M.uv.y=m.y,M.color.r=d.r,M.color.g=d.g,M.color.b=d.b,M.opacity=f,M=S[E+2],M.pos.x=n.pos.x+v*y*A-b*y*x,M.pos.y=n.pos.y+v*y*x+b*y*A,M.uv.x=m.x+m.w,M.uv.y=m.y+m.h,M.color.r=d.r,M.color.g=d.g,M.color.b=d.b,M.opacity=f,M=S[E+3],M.pos.x=n.pos.x+-v*y*A-b*y*x,M.pos.y=n.pos.y+-v*y*x+b*y*A,M.uv.x=m.x,M.uv.y=m.y+m.h,M.color.r=d.r,M.color.g=d.g,M.color.b=d.b,M.opacity=f}ns(S,M,this.fixed,e.texture,this.shader,this.uniform)}},onEnd:e=>B.add(e),inspect:()=>`count: ${q}/${e.max}`}}function Gs(e,t={}){if(e.length<3)throw new Error(`Polygon's need more than two points, ${e.length} points provided`);return{id:"polygon",pts:e,colors:t.colors,uv:t.uv,tex:t.tex,radius:t.radius,draw(){ss(Object.assign(Ts(this),{pts:this.pts,colors:this.colors,uv:this.uv,tex:this.tex,radius:this.radius,fill:t.fill,triangulate:t.triangulate}))},renderArea(){return new te(this.pts)},inspect(){return`polygon: ${this.pts.map((e=>`[${e.x},${e.y}]`)).join(",")}`}}}function Vs(e,t,n){let s;return zi.game.root.get("area").forEach((r=>{if(n&&n.some((e=>r.is(e))))return;let i=r.worldArea().raycast(e,t);i&&(s?i.fraction<s.fraction&&(s=i,s.object=r):(s=i,s.object=r))})),s}function Ys(e,t,n={}){return{id:"rect",width:e,height:t,radius:n.radius||0,draw(){xs(Object.assign(Ts(this),{width:this.width,height:this.height,radius:this.radius,fill:n.fill}))},renderArea(){return new _(c(0),this.width,this.height)},inspect(){return`rect: (${Math.ceil(this.width)}w, ${Math.ceil(this.height)}h)`}}}function Xs(e,t){return{id:"shader",shader:e,..."function"==typeof t?{uniform:t(),update(){this.uniform=t()}}:{uniform:t},inspect:()=>`shader: ${e}`}}function zs(e,t){if(!t.tileWidth||!t.tileHeight)throw new Error("Must provide tileWidth and tileHeight.");let n=zi.game.root.add([Gi(t.pos??c(0))]),s=e.length,r=0,i=null,a=null,o=null,l=null,h=e=>e.x+e.y*r,u=e=>c(Math.floor(e%r),Math.floor(e/r)),d=()=>{i=[];for(let e of n.children)f(e)},f=e=>{let t=h(e.tilePos);i[t]?i[t].push(e):i[t]=[e]},p=e=>{let t=h(e.tilePos);if(i[t]){let n=i[t].indexOf(e);n>=0&&i[t].splice(n,1)}},g=(e,t)=>a[t],m=(e,t)=>{let n=u(e),s=u(t);return n.dist(s)},w=(e,t)=>{let n=[],i=Math.floor(e%r),l=i>0&&1&o[e]&&a[e-1]!==1/0,h=e>=r&&2&o[e]&&a[e-r]!==1/0,u=i<r-1&&4&o[e]&&a[e+1]!==1/0,d=e<r*s-r-1&&8&o[e]&&a[e+r]!==1/0;return t?(l&&(h&&n.push(e-r-1),n.push(e-1),d&&n.push(e+r-1)),h&&n.push(e-r),u&&(h&&n.push(e-r+1),n.push(e+1),d&&n.push(e+r+1)),d&&n.push(e+r)):(l&&n.push(e-1),h&&n.push(e-r),u&&n.push(e+1),d&&n.push(e+r)),n},y={id:"level",tileWidth:()=>t.tileWidth,tileHeight:()=>t.tileHeight,spawn(e,...s){let r=c(...s),a=(()=>{if("string"!=typeof e){if(Array.isArray(e))return e;throw new Error("Expected a symbol or a component list")}if(t.tiles[e]){if("function"!=typeof t.tiles[e])throw new Error("Level symbol def must be a function returning a component list");return t.tiles[e](r)}if(t.wildcardTile)return t.wildcardTile(e,r)})();if(!a)return null;let o=!1,l=!1;for(let e of a)"tile"===e.id&&(l=!0),"pos"===e.id&&(o=!0);o||a.push(Gi(this.tile2Pos(r))),l||a.push(di());let h=n.add(a);return o&&(h.tilePosOffset=h.pos.clone()),h.tilePos=r,h.transform=tn(h),i&&(f(h),this.trigger("spatialMapChanged"),this.trigger("navigationMapInvalid")),h},numColumns:()=>r,numRows:()=>s,levelWidth(){return r*this.tileWidth()},levelHeight(){return s*this.tileHeight()},tile2Pos(...e){return c(...e).scale(this.tileWidth(),this.tileHeight())},pos2Tile(...e){let t=c(...e);return c(Math.floor(t.x/this.tileWidth()),Math.floor(t.y/this.tileHeight()))},getSpatialMap:()=>(i||d(),i),removeFromSpatialMap:p,insertIntoSpatialMap:f,onSpatialMapChanged(e){return this.on("spatialMapChanged",e)},onNavigationMapInvalid(e){return this.on("navigationMapInvalid",e)},getAt(e){i||d();let t=h(e);return i[t]||[]},raycast(e,t){let n=this.toWorld(e),s=this.toWorld(e.add(t)).sub(n),r=1/this.tileWidth(),i=function(e,t,n,s=64){let r=e,i=t.len(),a=t.scale(1/i),o=0,l=c(Math.floor(e.x),Math.floor(e.y)),h=c(a.x>0?1:-1,a.y>0?1:-1),u=c(Math.abs(1/a.x),Math.abs(1/a.y)),d=c(h.x>0?l.x+1-e.x:e.x-l.x,h.y>0?l.y+1-e.y:e.y-l.y),f=c(u.x<1/0?u.x*d.x:1/0,u.y<1/0?u.y*d.y:1/0),p=-1;for(;o<=s;){let e=n(l);if(!0===e)return{point:r.add(a.scale(o)),normal:c(0===p?-h.x:0,1===p?-h.y:0),fraction:o/i,gridPos:l};if(e)return e;f.x<f.y?(l.x+=h.x,o=f.x,f.x+=u.x,p=0):(l.y+=h.y,o=f.y,f.y+=u.y,p=1)}return null}(e.scale(r),t,(e=>{let t=this.getAt(e);if(t.some((e=>e.isObstacle)))return!0;let i=null;for(let e of t)if(e.has("area")){let t=e.worldArea().raycast(n,s);t&&(i?t.fraction<i.fraction&&(i=t,i.object=e):(i=t,i.object=e))}return i&&(i.point=this.fromWorld(i.point).scale(r)),i||!1}),64);return i&&(i.point=i.point.scale(this.tileWidth())),i},update(){i&&(()=>{let e=!1;for(let t of n.children){let s=n.pos2Tile(t.pos);(t.tilePos.x!=s.x||t.tilePos.y!=s.y)&&(e=!0,p(t),t.tilePos.x=s.x,t.tilePos.y=s.y,f(t))}e&&n.trigger("spatialMapChanged")})()},invalidateNavigationMap(){a=null,o=null,l=null},onNavigationMapChanged(e){return this.on("navigationMapChanged",e)},getTilePath(e,t,i={}){if(a||(()=>{let e=n.getSpatialMap(),t=n.numRows()*n.numColumns();a?a.length=t:a=new Array(t),a.fill(1,0,t);for(let t=0;t<e.length;t++){let n=e[t];if(n){let e=0;for(let t of n){if(t.isObstacle){e=1/0;break}e+=t.cost}a[t]=e||1}}})(),o||(()=>{let e=n.getSpatialMap(),t=n.numRows()*n.numColumns();o?o.length=t:o=new Array(t),o.fill(15,0,t);for(let t=0;t<e.length;t++){let n=e[t];if(n){let e=n.length,s=15;for(let t=0;t<e;t++)s|=n[t].edgeMask;o[t]=s}}})(),l||(()=>{let e=n.numRows()*n.numColumns(),t=(e,t)=>{let n=[];for(n.push(e);n.length>0;){let e=n.pop();w(e).forEach((e=>{l[e]<0&&(l[e]=t,n.push(e))}))}};l?l.length=e:l=new Array(e),l.fill(-1,0,e);let s=0;for(let e=0;e<a.length;e++)l[e]>=0||t(e,s),s++})(),e.x<0||e.x>=r||e.y<0||e.y>=s||t.x<0||t.x>=r||t.y<0||t.y>=s)return null;let d=h(e),c=h(t);if(a[c]===1/0)return null;if(d===c)return[];if(-1!=l[d]&&l[d]!==l[c])return null;let f=new _e(((e,t)=>e.cost<t.cost));f.insert({cost:0,node:d});let p=new Map;p.set(d,d);let y=new Map;for(y.set(d,0);0!==f.length;){let e=f.remove()?.node;if(e===c)break;let t=w(e,i.allowDiagonals);for(let n of t){let t=(y.get(e)||0)+g(0,n)+m(n,c);(!y.has(n)||t<y.get(n))&&(y.set(n,t),f.insert({cost:t,node:n}),p.set(n,e))}}let A=[],x=c,v=u(x);for(A.push(v);x!==d;){let e=p.get(x);if(void 0===e)throw new Error("Bug in pathfinding algorithm");x=e;let t=u(x);A.push(t)}return A.reverse()},getPath(e,t,n={}){let s=this.tileWidth(),r=this.tileHeight(),i=this.getTilePath(this.pos2Tile(e),this.pos2Tile(t),n);return i?[e,...i.slice(1,-1).map((e=>e.scale(s,r).add(s/2,r/2))),t]:null}};return n.use(y),n.onNavigationMapInvalid((()=>{n.invalidateNavigationMap(),n.trigger("navigationMapChanged")})),e.forEach(((e,t)=>{let s=e.split("");r=Math.max(s.length,r),s.forEach(((e,s)=>{n.spawn(e,c(s,t))}))})),n}function Qs(e,t,n){return zi.game.objEvents.registers[e]||(zi.game.objEvents.registers[e]=new Xe),zi.game.objEvents.on(e,((e,...s)=>{e.is(t)&&n(e,...s)}))}var Ws=(e,t,...n)=>{for(let s of zi.game.root.children)s.is(t)&&s.trigger(e,n)},Js=ut((e=>{let t=zi.game.root.add([{fixedUpdate:e}]);return{get paused(){return t.paused},set paused(e){t.paused=e},cancel:()=>t.destroy()}}),((e,t)=>Qs("fixedUpdate",e,t))),Zs=ut((e=>{let t=zi.game.root.add([{update:e}]);return{get paused(){return t.paused},set paused(e){t.paused=e},cancel:()=>t.destroy()}}),((e,t)=>Qs("update",e,t))),_s=ut((e=>{let t=zi.game.root.add([{draw:e}]);return{get paused(){return t.hidden},set paused(e){t.hidden=e},cancel:()=>t.destroy()}}),((e,t)=>Qs("draw",e,t))),$s=ut((e=>zi.game.events.on("add",e)),((e,t)=>Qs("add",e,t))),er=ut((e=>zi.game.events.on("destroy",e)),((e,t)=>Qs("destroy",e,t))),tr=ut((e=>zi.game.events.on("use",e)),((e,t)=>Qs("use",e,t))),nr=ut((e=>zi.game.events.on("unuse",e)),((e,t)=>Qs("unuse",e,t))),sr=ut((e=>zi.game.events.on("tag",e)),((e,t)=>Qs("tag",e,t))),rr=ut((e=>zi.game.events.on("untag",e)),((e,t)=>Qs("untag",e,t)));function ir(e,t,n){return Qs("collide",e,((e,s,r)=>s.is(t)&&n(e,s,r)))}function ar(e,t,n){return Qs("collideUpdate",e,((e,s,r)=>s.is(t)&&n(e,s,r)))}function or(e,t,n){return Qs("collideEnd",e,((e,s,r)=>s.is(t)&&n(e,s,r)))}function lr(e,t){zi.game.root.get(e,{recursive:!0}).forEach(t),$s(e,t),sr(((n,s)=>{s===e&&t(n)}))}var hr=ut((e=>zi.app.onMousePress(e)),((e,t)=>{let n=[];return lr(e,(e=>{if(!e.area)throw new Error("onClick() requires the object to have area() component");n.push(e.onClick((()=>t(e))))})),ze.join(n)}));function ur(e,t){let n=[];return lr(e,(e=>{if(!e.area)throw new Error("onHover() requires the object to have area() component");n.push(e.onHover((()=>t(e))))})),ze.join(n)}function dr(e,t){let n=[];return lr(e,(e=>{if(!e.area)throw new Error("onHoverUpdate() requires the object to have area() component");n.push(e.onHoverUpdate((()=>t(e))))})),ze.join(n)}function cr(e,t){let n=[];return lr(e,(e=>{if(!e.area)throw new Error("onHoverEnd() requires the object to have area() component");n.push(e.onHoverEnd((()=>t(e))))})),ze.join(n)}function fr(e){zi.game.events.on("loading",e)}function pr(e){zi.app.onResize(e)}function gr(e){zi.game.events.on("error",e)}function mr(e){zi.assets.loaded?e():zi.game.events.on("load",e)}function wr(e){if(!zi.assets.loaded)return zi.game.events.on("loadError",e);Bn().forEach((t=>e(...t)))}function yr(...e){zi.game.cam.pos=c(...e)}function Ar(){return zi.game.cam.pos?zi.game.cam.pos.clone():wn()}function xr(...e){zi.game.cam.scale=c(...e)}function vr(){return zi.game.cam.scale.clone()}function br(e){zi.game.cam.angle=e}function Er(){return zi.game.cam.angle}function Mr(){return zi.game.cam.transform.clone()}function Sr(e=r(255,255,255),t=1){let n=zi.game.root.add([Ys(pn(),gn()),Ds(e),Ns(1),{id:"fixed",fixed:!0}]),s=n.fadeOut(t);return s.onEnd((()=>_r(n))),s}function qr(){return zi.game.cam.transform.clone()}function kr(e=12){zi.game.cam.shake+=e}function Br(e){return zi.game.cam.transform.multVec2(e)}function Rr(e){return zi.game.cam.transform.invert().multVec2(e)}function Cr(...e){return lt("camPos","setCamPos / getCamPos"),e.length>0&&yr(...e),Ar()}function Ir(...e){return lt("camScale","setCamScale / getCamScale"),e.length>0&&xr(...e),vr()}function Pr(e){return lt("camRot","setCamRot / getCamRot"),void 0!==e&&br(e),Er()}function Tr(e=r(255,255,255),t=1){return lt("camFlash","flash"),Sr(e,t)}function Fr(e=[]){let t=new Map,n=[],s={},r=new We,i=[],a=new Set("*"),o=zi.globalOpt.tagsAsComponents,l=null,h=!1,u={id:Et(),hidden:!1,transform:new w,children:[],parent:null,set paused(e){if(e!==h){h=e;for(let t of i)t.paused=e}},get paused(){return h},get tags(){return Array.from(a)},add(e){let t=Array.isArray(e)?Fr(e):e;if(t.parent)throw new Error("Cannot add a game obj that already has a parent.");return t.parent=this,t.transform=tn(t),this.children.push(t),t.trigger("add",t),zi.game.events.trigger("add",t),t},readd(e){let t=this.children.indexOf(e);return-1!==t&&(this.children.splice(t,1),this.children.push(e)),e},remove(e){let t=this.children.indexOf(e);if(-1!==t){e.parent=null,this.children.splice(t,1);let n=e=>{e.trigger("destroy"),zi.game.events.trigger("destroy",e),e.children.forEach((e=>n(e)))};n(e)}},removeAll(e){if(e)this.get(e).forEach((e=>this.remove(e)));else for(let e of[...this.children])this.remove(e)},fixedUpdate(){this.paused||(this.children.forEach((e=>e.fixedUpdate())),this.trigger("fixedUpdate"))},update(){this.paused||(this.children.forEach((e=>e.update())),this.trigger("update"))},draw(){if(this.hidden)return;this.canvas&&(fn(),this.canvas.bind());let e=zi.gfx.fixed;this.fixed&&(zi.gfx.fixed=!0),ln(),on(this.pos),un(this.scale),dn(this.angle);let t=this.children.sort(((e,t)=>(e.layerIndex??zi.game.defaultLayerIndex)-(t.layerIndex??zi.game.defaultLayerIndex)||(e.z??0)-(t.z??0)));if(this.mask){let e={intersect:zi.k.drawMasked,subtract:zi.k.drawSubtracted}[this.mask];if(!e)throw new Error(`Invalid mask func: "${this.mask}"`);e((()=>{t.forEach((e=>e.draw()))}),(()=>{this.trigger("draw")}))}else this.trigger("draw"),t.forEach((e=>e.draw()));cn(),zi.gfx.fixed=e,this.canvas&&(fn(),this.canvas.unbind())},drawInspect(){this.hidden||(ln(),on(this.pos),un(this.scale),dn(this.angle),this.children.forEach((e=>e.drawInspect())),this.trigger("drawInspect"),cn())},use(e){if("string"==typeof e)return a.add(e);if(!e||"object"!=typeof e)throw new Error(`You can only pass a component or a string to .use(), you passed a "${typeof e}"`);let r=[];e.id?(this.unuse(e.id),s[e.id]=[],r=s[e.id],t.set(e.id,e),o&&a.add(e.id)):n.push(e);for(let n in e){if(Ge.has(n))continue;let s=Object.getOwnPropertyDescriptor(e,n);if(s)if("function"==typeof s.value&&(e[n]=e[n].bind(this)),s.set&&Object.defineProperty(e,n,{set:s.set.bind(this)}),s.get&&Object.defineProperty(e,n,{get:s.get.bind(this)}),Ve.has(n)){let t="add"===n?()=>{l=e=>r.push(e),e[n]?.(),l=null}:e[n];r.push(this.on(n,t).cancel)}else{if(void 0!==this[n]){let s=t.values().find((e=>void 0!==e[n]))?.id;throw new Error(`Duplicate component property: "${n}" while adding component "${e.id}"`+(s?` (originally added by "${s}")`:""))}Object.defineProperty(this,n,{get:()=>e[n],set:t=>e[n]=t,configurable:!0,enumerable:!0}),r.push((()=>delete this[n]))}}let i=()=>{if(e.require)for(let t of e.require)if(!this.c(t))throw new Error(`Component "${e.id}" requires component "${t}"`)};e.destroy&&r.push(e.destroy.bind(this)),this.exists()?(i(),e.add&&(l=e=>r.push(e),e.add.call(this),l=null),e.id&&(this.trigger("use",e.id),zi.game.events.trigger("use",this,e.id))):e.require&&r.push(this.on("add",i).cancel)},unuse(e){if(t.has(e)){for(let n of t.values())if(n.require&&n.require.includes(e))throw new Error(`Can't unuse. Component "${n.id}" requires component "${e}"`);t.delete(e),this.trigger("unuse",e),zi.game.events.trigger("unuse",this,e)}else o&&a.has(e)&&a.delete(e);s[e]&&(s[e].forEach((e=>e())),delete s[e])},c:e=>t.get(e)??null,get(e,t={}){let n=(e,n)=>"comps"===t.only?e.has(n):"tags"===t.only?e.is(n):e.is(n)||e.has(n),s=t.recursive?this.children.flatMap((function e(t){return[t,...t.children.flatMap(e)]})):this.children;if(s=s.filter((t=>!e||n(t,e))),t.liveUpdate){let r=e=>t.recursive?this.isAncestorOf(e):e.parent===this,i=[];i.push(zi.k.onAdd((t=>{r(t)&&n(t,e)&&s.push(t)}))),i.push(zi.k.onDestroy((t=>{if(r(t)&&n(t,e)){let e=s.findIndex((e=>e.id===t.id));-1!==e&&s.splice(e,1)}}))),this.onDestroy((()=>{for(let e of i)e.cancel()}))}return s},query(e){let t=e.hierarchy||"children",n=e.include,s=e.exclude,r=[];switch(t){case"children":r=this.children;break;case"siblings":r=this.parent?this.parent.children.filter((e=>e!==this)):[];break;case"ancestors":let e=this.parent;for(;e;)r.push(e),e=e.parent;break;case"descendants":r=this.children.flatMap((function e(t){return[t,...t.children.flatMap(e)]}))}if(n&&(r="and"!==(e.includeOp||"and")&&Array.isArray(e.include)?r.filter((t=>e.include.some((e=>t.is(e))))):r.filter((e=>e.is(n)))),s&&(r="and"!==(e.includeOp||"and")&&Array.isArray(e.include)?r.filter((t=>!e.exclude.some((e=>t.is(e))))):r.filter((e=>!e.is(s)))),!0===e.visible&&(r=r.filter((e=>e.visible))),e.distance){if(!this.pos)throw Error("Can't do a distance query from an object without pos");let t=e.distanceOp||"near",n=e.distance*e.distance;r="near"===t?r.filter((e=>e.pos&&this.pos.sdist(e.pos)<=n)):r.filter((e=>e.pos&&this.pos.sdist(e.pos)>n))}return e.name&&(r=r.filter((t=>t.name===e.name))),r},isAncestorOf(e){return!!e.parent&&(e.parent===this||this.isAncestorOf(e.parent))},exists(){return zi.game.root.isAncestorOf(this)},is:(e,t="and")=>Array.isArray(e)?"and"===t?e.every((e=>a.has(e))):e.some((e=>a.has(e))):a.has(e),tag(e){if(Array.isArray(e))for(let t of e)a.add(t),this.trigger("tag",t),zi.game.events.trigger("tag",this,t);else a.add(e),this.trigger("tag",e),zi.game.events.trigger("tag",this,e)},untag(e){if(Array.isArray(e))for(let t of e)a.delete(t),this.trigger("untag",t),zi.game.events.trigger("untag",this,t);else a.delete(e),this.trigger("untag",e),zi.game.events.trigger("untag",this,e)},has:(e,n="and")=>Array.isArray(e)?"and"===n?e.every((e=>t.has(e))):e.some((e=>t.has(e))):t.has(e),on(e,t){let n=r.on(e,t.bind(this));return l&&l((()=>n.cancel())),n},trigger(e,...t){r.trigger(e,...t),zi.game.objEvents.trigger(e,this,...t)},destroy(){this.parent&&this.parent.remove(this)},inspect(){let e={};for(let[n,s]of t)e[n]=s.inspect?.()??null;for(let[t,s]of n.entries())if(s.inspect)e[t]=s.inspect();else for(let[t,n]of Object.entries(s))"function"!=typeof n&&(e[t]=`${t}: ${n}`);return e},onAdd(e){return this.on("add",e)},onFixedUpdate(e){return this.on("fixedUpdate",e)},onUpdate(e){return this.on("update",e)},onDraw(e){return this.on("draw",e)},onDestroy(e){return this.on("destroy",e)},onUse(e){return this.on("use",e)},onUnuse(e){return this.on("unuse",e)},clearEvents(){r.clear()}},d=["onKeyPress","onKeyPressRepeat","onKeyDown","onKeyRelease","onMousePress","onMouseDown","onMouseRelease","onMouseMove","onCharInput","onMouseMove","onTouchStart","onTouchMove","onTouchEnd","onScroll","onGamepadButtonPress","onGamepadButtonDown","onGamepadButtonRelease","onGamepadStick","onButtonPress","onButtonDown","onButtonRelease"];for(let e of d)u[e]=(...t)=>{let n=zi.app[e]?.(...t);return i.push(n),u.onDestroy((()=>n.cancel())),u.on("sceneEnter",(()=>{i.splice(i.indexOf(n),1);let s=zi.app[e]?.(...t);ze.replace(n,s),i.push(n)})),n};for(let t of e)u.use(t);return u}function Dr(e){zi.game.gravity=e?(zi.game.gravity||c(0,1)).unit().scale(e):null}function Or(){return zi.game.gravity?zi.game.gravity.len():0}function Ur(e){zi.game.gravity=e.unit().scale(zi.game.gravity?zi.game.gravity.len():1)}function Lr(){return zi.game.gravity?zi.game.gravity.unit():c(0,1)}var Nr=e("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");function Hr(e,n={}){let s=new Qe,r=new Audio(e);function i(){zi.debug.paused||zi.app.isHidden()&&!zi.globalOpt.backgroundAudio||zi.audio.ctx.resume(),r.play()}return r.crossOrigin="anonymous",r.loop=!!n.loop,zi.audio.ctx.createMediaElementSource(r).connect(zi.audio.masterNode),n.paused||i(),r.onended=()=>s.trigger(),{play(){i()},seek(e){r.currentTime=e},stop(){r.pause(),this.seek(0)},set loop(e){r.loop=e},get loop(){return r.loop},set paused(e){e?r.pause():i()},get paused(){return r.paused},time:()=>r.currentTime,duration:()=>r.duration,set volume(e){r.volume=t(e,0,1)},get volume(){return r.volume},set speed(e){r.playbackRate=Math.max(e,0)},get speed(){return r.playbackRate},set detune(e){},get detune(){return 0},onEnd:e=>s.add(e),then(e){return this.onEnd(e)}}}function jr(e,t={}){if("string"==typeof e&&zi.assets.music[e])return Hr(zi.assets.music[e],t);let n=zi.audio.ctx,s=t.paused??!1,r=n.createBufferSource(),i=new Qe,a=n.createGain(),o=n.createStereoPanner(),l=t.seek??0,h=0,u=0,d=!1;r.loop=!!t.loop,r.detune.value=t.detune??0,r.playbackRate.value=t.speed??1,r.connect(o),r.onended=()=>{f()>=(r.buffer?.duration??Number.POSITIVE_INFINITY)&&i.trigger()},o.pan.value=t.pan??0,o.connect(a),a.connect(zi.audio.masterNode),a.gain.value=t.volume??1;let c=function(e){if("string"==typeof e){let t=_n(e);if(t)return t;if(kn()<1)return null;throw new Error(`Sound not found: ${e}`)}if(e instanceof Zn)return xn.loaded(e);if(e instanceof xn)return e;throw new Error(`Invalid sound: ${e}`)}(e);c instanceof xn&&c.onLoad((e=>{r.buffer=e.buf,s||(h=n.currentTime,r.start(0,l),d=!0)}));let f=()=>{if(!r.buffer)return 0;let e=s?u-h:n.currentTime-h,t=r.buffer.duration;return r.loop?e%t:Math.min(e,t)},p=e=>{let t=n.createBufferSource();return t.buffer=e.buffer,t.loop=e.loop,t.playbackRate.value=e.playbackRate.value,t.detune.value=e.detune.value,t.onended=e.onended,t.connect(o),t};return{stop(){this.paused=!0,this.seek(0)},set paused(e){if(s!==e)if(s=e,e)d&&(r.stop(),d=!1),u=n.currentTime;else{r=p(r);let e=u-h;r.start(0,e),d=!0,h=n.currentTime-e,u=0}},get paused(){return s},play(e=0){this.seek(e),this.paused=!1},seek(e){r.buffer?.duration&&(e>r.buffer.duration||(s?(r=p(r),h=u-e):(r.stop(),r=p(r),h=n.currentTime-e,r.start(0,e),d=!0,u=0)))},set speed(e){r.playbackRate.value=e},get speed(){return r.playbackRate.value},set detune(e){r.detune.value=e},get detune(){return r.detune.value},set volume(e){a.gain.value=Math.max(e,0)},get volume(){return a.gain.value},set pan(e){o.pan.value=e},get pan(){return o.pan.value},set loop(e){r.loop=e},get loop(){return r.loop},duration:()=>r.buffer?.duration??0,time(){return f()%this.duration()},onEnd:e=>i.add(e),then(e){return this.onEnd(e)}}}function Kr(e){return zi.k.play(zi.audio.burpSnd,e)}function Gr(e){zi.audio.masterNode.gain.value=e}function Vr(){return zi.audio.masterNode.gain.value}function Yr(e){return lt("volume","setVolume / getVolume"),void 0!==e&&Gr(e),Vr()}function Xr(){zi.app.onHide((()=>{zi.globalOpt.backgroundAudio||zi.audio.ctx.suspend()})),zi.app.onShow((()=>{!zi.globalOpt.backgroundAudio&&!zi.debug.paused&&zi.audio.ctx.resume()})),zi.app.onResize((()=>{if(zi.app.isFullscreen())return;let e=zi.globalOpt.width&&zi.globalOpt.height;e&&!zi.globalOpt.stretch&&!zi.globalOpt.letterbox||(zi.canvas.width=zi.canvas.offsetWidth*zi.pixelDensity,zi.canvas.height=zi.canvas.offsetHeight*zi.pixelDensity,Mt(),e||(zi.gfx.frameBuffer.free(),zi.gfx.frameBuffer=new ds(zi.gfx.ggl,zi.gfx.ggl.gl.drawingBufferWidth,zi.gfx.ggl.gl.drawingBufferHeight),zi.gfx.width=zi.gfx.ggl.gl.drawingBufferWidth/zi.pixelDensity/zi.gscale,zi.gfx.height=zi.gfx.ggl.gl.drawingBufferHeight/zi.pixelDensity/zi.gscale))})),!1!==zi.globalOpt.debug&&(zi.app.onKeyPress(zi.globalOpt.debugKey??"f1",(()=>zi.debug.inspect=!zi.debug.inspect)),zi.app.onKeyPress("f2",(()=>zi.debug.clearLog())),zi.app.onKeyPress("f8",(()=>zi.debug.paused=!zi.debug.paused)),zi.app.onKeyPress("f7",(()=>{zi.debug.timeScale=ht(t(zi.debug.timeScale-.2,0,2),1)})),zi.app.onKeyPress("f9",(()=>{zi.debug.timeScale=ht(t(zi.debug.timeScale+.2,0,2),1)})),zi.app.onKeyPress("f10",(()=>zi.debug.stepFrame()))),zi.globalOpt.burp&&zi.app.onKeyPress("b",(()=>Kr()))}function zr(e,t={}){let n=zi.game.root.add([Gi(e),Mi()]),s=5*(t.speed||1),r=t.scale||1;n.add([ri(zi.boomSprite),Yi(0),Ui("center"),Ai(s,r),...t.comps??[]]);let i=n.add([ri(zi.kaSprite),Yi(0),Ui("center"),qi(),...t.comps??[]]);return i.wait(.4/s,(()=>i.use(Ai(s,r)))),i.onDestroy((()=>n.destroy())),n}function Qr(e,t){if(zi.game.layers)throw Error("Layers can only be assigned once.");let n=e.indexOf(t);if(-1==n)throw Error("The default layer name should be present in the layers list.");zi.game.layers=e,zi.game.defaultLayerIndex=n}function Wr(){return zi.game.layers}function Jr(){return zi.game.layers?.[zi.game.defaultLayerIndex]??null}function Zr(e,t){lt("layers","setLayers"),Qr(e,t)}function _r(e){e.destroy()}function $r(){return zi.game.root}function ei(e,t){zi.game.scenes[e]=t}function ti(e,...t){if(!zi.game.scenes[e])throw new Error(`Scene not found: ${e}`);zi.game.events.onOnce("frameEnd",(()=>{zi.game.events.trigger("sceneLeave",e),zi.app.events.clear(),zi.game.events.clear(),zi.game.objEvents.clear(),[...zi.game.root.children].forEach((t=>{!t.stay||t.scenesToStay&&!t.scenesToStay.includes(e)?zi.game.root.remove(t):t.trigger("sceneEnter",e)})),zi.game.root.clearEvents(),Xr(),zi.game.cam={pos:null,scale:c(1),angle:0,shake:0,transform:new w},zi.game.scenes[e](...t)})),zi.game.currentScene=e}function ni(e){return zi.game.events.on("sceneLeave",e)}function si(){return zi.game.currentScene}function ri(e,t={}){let n=null,s=null,r=null,i=new Qe;if(!e)throw new Error("Please pass the resource name or data to sprite()");let a=(e,s)=>{if(!s)return;let r=s.frames[0].clone();t.quad&&(r=r.scale(t.quad));let a=((e,t,n,s)=>{let r=c(1,1);return n&&s?(r.x=n/(e.width*t.w),r.y=s/(e.height*t.h)):n?(r.x=n/(e.width*t.w),r.y=r.x):s&&(r.y=s/(e.height*t.h),r.x=r.y),r})(s.tex,r,t.width,t.height);if(e.width=s.tex.width*r.w*a.x,e.height=s.tex.height*r.h*a.y,s.anims)for(let e in s.anims){let t=s.anims[e];"number"!=typeof t&&(t.frames=o(t))}n=s,i.trigger(n),t.anim&&e.play(t.anim)},o=e=>{if(e.frames)return e.frames;let t=[];if(void 0===e.from||void 0===e.to)throw new Error("Sprite anim 'from' and 'to' must be defined if 'frames' is not defined");let n=Math.abs(e.to-e.from)+1;for(let s=0;s<n;s++)t.push(e.from+s*Math.sign(e.to-e.from));if(e.pingpong)for(let e=n-2;e>0;e--)t.push(t[e]);return t};return{id:"sprite",width:0,height:0,frame:t.frame||0,quad:t.quad||new f(0,0,1,1),animSpeed:t.animSpeed??1,flipX:t.flipX??!1,flipY:t.flipY??!1,get sprite(){return e.toString()},set sprite(e){let t=Pn(e);t&&t.onLoad((e=>a(this,e)))},get animFrame(){if(!n||!s||null===r)return this.frame;let e=n.anims[s.name];return"number"==typeof e?e:void 0===e.from||void 0===e.to?s.frameIndex:this.frame-Math.min(e.from,e.to)},draw(){if(!n)return;let e=n.frames[this.frame??0];if(!e)throw new Error(`Frame not found: ${this.frame??0}`);if(n.slice9){let{left:s,right:r,top:i,bottom:a}=n.slice9,o=n.tex.width*e.w,l=n.tex.height*e.h,h=this.width-s-r,u=this.height-i-a,d=s/o,c=r/o,f=1-d-c,g=i/l,m=a/l,w=1-g-m,y=[p(0,0,d,g),p(d,0,f,g),p(d+f,0,c,g),p(0,g,d,w),p(d,g,f,w),p(d+f,g,c,w),p(0,g+w,d,m),p(d,g+w,f,m),p(d+f,g+w,c,m),p(0,0,s,i),p(s,0,h,i),p(s+h,0,r,i),p(0,i,s,u),p(s,i,h,u),p(s+h,i,r,u),p(0,i+u,s,a),p(s,i+u,h,a),p(s+h,i+u,r,a)];for(let s=0;s<9;s++){let r=y[s],i=y[s+9];Bs(Object.assign(Ts(this),{pos:i.pos(),tex:n.tex,quad:e.scale(r),flipX:this.flipX,flipY:this.flipY,tiled:t.tiled,width:i.w,height:i.h}))}}else Bs(Object.assign(Ts(this),{tex:n.tex,quad:e.scale(this.quad??new f(0,0,1,1)),flipX:this.flipX,flipY:this.flipY,tiled:t.tiled,width:this.width,height:this.height}))},add(){let t=Pn(e);t?t.onLoad((e=>a(this,e))):mr((()=>a(this,Pn(e).data)))},update(){if(!n||!s||null===r)return;let e=n.anims[s.name];if("number"!=typeof e){if(0===e.speed)throw new Error("Sprite anim speed cannot be 0");if(s.timer+=Pt()*this.animSpeed,s.timer>=1/s.speed){s.timer=0,s.frameIndex+=r;let t=e.frames;if(s.frameIndex>=t.length)if(s.pingpong&&!e.pingpong)r=-1,s.frameIndex=t.length-2;else{if(!s.loop)return this.frame=t.at(-1),s.onEnd(),void this.stop();s.frameIndex=0}else if(s.frameIndex<0)if(s.pingpong&&s.loop)r=1,s.frameIndex=1;else{if(!s.loop)return this.frame=t[0],s.onEnd(),void this.stop();s.frameIndex=t.length-1}this.frame=t[s.frameIndex]}}else this.frame=e},play(e,t={}){if(!n)return void i.add((()=>this.play(e,t)));let a=n.anims[e];if(void 0===a)throw new Error(`Anim not found: ${e}`);s&&this.stop(),s="number"==typeof a?{name:e,timer:0,loop:!1,pingpong:!1,speed:0,frameIndex:0,onEnd:()=>{}}:{name:e,timer:0,loop:t.loop??a.loop??!1,pingpong:t.pingpong??a.pingpong??!1,speed:t.speed??a.speed??10,frameIndex:0,onEnd:t.onEnd??(()=>{})},r="number"==typeof a?null:1,this.frame="number"==typeof a?a:a.frames[0],this.trigger("animStart",e)},stop(){if(!s)return;let e=s.name;s=null,this.trigger("animEnd",e)},numFrames:()=>n?.frames.length??0,getCurAnim:()=>s,curAnim:()=>s?.name,getAnim:e=>n?.anims[e]??null,hasAnim(e){return!!this.getAnim(e)},onAnimEnd(e){return this.on("animEnd",e)},onAnimStart(e){return this.on("animStart",e)},renderArea(){return new _(c(0),this.width,this.height)},inspect:()=>"string"==typeof e?`sprite: "${e}"`:null}}function ii(e,t={}){function n(e){let n=ws(Object.assign(Ts(e),{text:e.text+"",size:e.textSize,font:e.font,width:t.width&&e.width,align:e.align,letterSpacing:e.letterSpacing,lineSpacing:e.lineSpacing,transform:e.textTransform,styles:e.textStyles,indentAll:t.indentAll}));return t.width||(e.width=n.width/(e.scale?.x||1)),e.height=n.height/(e.scale?.y||1),n}let s={id:"text",set text(t){e=t,n(this),this.renderedText=ms(e).text},get text(){return e},textSize:t.size??36,font:t.font,width:t.width??0,height:0,align:t.align,lineSpacing:t.lineSpacing,letterSpacing:t.letterSpacing,textTransform:t.transform,textStyles:t.styles,renderedText:e?ms(e).text:"",add(){mr((()=>n(this)))},draw(){As(n(this))},renderArea(){return new _(c(0),this.width,this.height)}};return n(s),s}function ai(e,t){return{id:"rect",width:e,height:t,draw(){ys(Object.assign(Ts(this),{width:this.width,height:this.height}))},renderArea(){return new _(c(0),this.width,this.height)},inspect(){return`uvquad: (${Math.ceil(this.width)}w, ${Math.ceil(this.height)})h`}}}function oi(e={}){let t=null,n=null,s=null,r=null;return{id:"agent",require:["pos","tile"],agentSpeed:e.speed??100,allowDiagonals:e.allowDiagonals??!0,getDistanceToTarget(){return t?this.pos.dist(t):0},getNextLocation:()=>n&&s?n[s]:null,getPath:()=>n?n.slice():null,getTarget:()=>t,isNavigationFinished:()=>!n||null===s,isTargetReachable:()=>null!==n,isTargetReached(){return!t||this.pos.eq(t)},setTarget(e){t=e,n=this.getLevel().getPath(this.pos,t,{allowDiagonals:this.allowDiagonals}),s=n?0:null,n&&null!==s?(r||(r=this.getLevel().onNavigationMapChanged((()=>{t&&n&&null!==s&&(n=this.getLevel().getPath(this.pos,t,{allowDiagonals:this.allowDiagonals}),n?(s=0,this.trigger("navigationNext",this,n[s])):(s=null,this.trigger("navigationEnded",this)))})),this.onDestroy((()=>r?.cancel()))),this.trigger("navigationStarted",this),this.trigger("navigationNext",this,n[s])):this.trigger("navigationEnded",this)},update(){if(t&&n&&null!==s){if(this.pos.sdist(n[s])<2){if(s===n.length-1)return this.pos=t.clone(),s=null,this.trigger("navigationEnded",this),void this.trigger("targetReached",this);s++,this.trigger("navigationNext",this,n[s])}this.moveTo(n[s],this.agentSpeed)}},onNavigationStarted(e){return this.on("navigationStarted",e)},onNavigationNext(e){return this.on("navigationNext",e)},onNavigationEnded(e){return this.on("navigationEnded",e)},onTargetReached(e){return this.on("targetReached",e)},inspect:()=>"agent: "+JSON.stringify({target:JSON.stringify(t),path:JSON.stringify(n)})}}function li(e){let t=e.graph;return{id:"pathfinder",require:["pos"],navigateTo(t){return this.graph?.getWaypointPath(this.pos,t,e.navigationOpt)},get graph(){if(t)return t;let e=this.parent;for(;e;){if(e.has("pathfinderMap"))return e.graph;e=e.parent}},set graph(e){t=e}}}function hi(e={}){let t=e.waypoints,n=e.speed||100,s=e.endBehavior||"stop",r=0,i=null!=t;return{id:"patrol",require:["pos"],get patrolSpeed(){return n},set patrolSpeed(e){n=e},get waypoints(){return t},set waypoints(e){t=e,r=0,i=!1},get nextLocation(){return t?t[r]:void 0},update(){let e=this.nextLocation;if(t&&e&&!i&&(this.moveTo(e,n),this.pos.sdist(e)<9))switch(s){case"loop":r=(r+1)%t.length;break;case"ping-pong":r+=1,r==t.length&&(t.reverse(),r=0);break;case"stop":r<t.length-1?r+=1:i||(i=!0,this.trigger("patrolFinished",this))}},onPatrolFinished(e){return this.on("patrolFinished",e)}}}function ui(e,t={}){let n="function"==typeof e?e:()=>zi.game.root.query(e),s=t.checkFrequency||1,r="number"==typeof t.direction?d.fromAngle(t.direction):t.direction,i=0;return{id:"sentry",require:["pos"],direction:"number"==typeof t.direction?d.fromAngle(t.direction):t.direction,spotted:[],set directionAngle(e){this.direction=void 0!==e?d.fromAngle(e):void 0},get directionAngle(){return this.direction?this.direction.angle():void 0},fieldOfView:t.fieldOfView||200,isWithinFieldOfView(e,n,s){let i=("number"==typeof n?d.fromAngle(n):n)||r,a=s||t.fieldOfView;if(!i||!a||a>=360)return!0;let o=a/2;return e.pos&&i.angleBetween(e.pos.sub(this.pos))<=o},hasLineOfSight(e){let n=Vs(this.pos,e.pos.sub(this.pos),t.raycastExclude);return null!=n&&n.object===e},update(){if(i+=Pt(),i>s){i-=s;let e=n();if(e.length&&r&&this.fieldOfView&&this.fieldOfView<360){let t=this.fieldOfView/2;e=e.filter((e=>e.pos&&r.angleBetween(e.pos.sub(this.pos))<=t))}e.length&&t.lineOfSight&&(e=e.filter((e=>e.pos&&this.hasLineOfSight(e)))),e.length>0&&(this.spotted=e,this.trigger("objectSpotted",e))}},onObjectsSpotted(e){return this.on("objectSpotted",e)}}}function di(e={}){let t=c(0),n=e.isObstacle??!1,s=e.cost??0,r=e.edges??[],i=()=>{let e={left:1,top:2,right:4,bottom:8};return r.map((t=>e[t]||0)).reduce(((e,t)=>e|t),0)},a=i();return{id:"tile",tilePosOffset:e.offset??c(0),set tilePos(e){let n=this.getLevel();t=e.clone(),this.pos=c(this.tilePos.x*n.tileWidth(),this.tilePos.y*n.tileHeight()).add(this.tilePosOffset)},get tilePos(){return t},set isObstacle(e){n!==e&&(n=e,this.getLevel().invalidateNavigationMap())},get isObstacle(){return n},set cost(e){s!==e&&(s=e,this.getLevel().invalidateNavigationMap())},get cost(){return s},set edges(e){r=e,a=i(),this.getLevel().invalidateNavigationMap()},get edges(){return r},get edgeMask(){return a},getLevel(){return this.parent},tileMove(e){let t=this.getLevel();t.removeFromSpatialMap(this),this.tilePos=this.tilePos.add(e),t.insertIntoSpatialMap(this),t.trigger("spatialMapChanged")},moveLeft(){this.tileMove(c(-1,0))},moveRight(){this.tileMove(c(1,0))},moveUp(){this.tileMove(c(0,-1))},moveDown(){this.tileMove(c(0,1))}}}var ci=class{name;duration;loops;direction;easing;interpolation;isFinished;timing;easings;relative;constructor(e,t,n){this.name=e,this.duration=t.duration,this.loops=t.loops||0,this.direction=t.direction||"forward",this.easing=t.easing||Zt.linear,this.interpolation=t.interpolation||"linear",this.isFinished=!1,this.timing=t.timing,this.easings=t.easings,this.relative=n}update(e,t){return!0}getLowerKeyIndexAndRelativeTime(e,t,n){let s=t-1,r=e/this.duration;if(0!==this.loops&&r>=this.loops)return[s,0,!0];let i=Math.trunc(r);if(r-=i,("reverse"==this.direction||"ping-pong"==this.direction&&1&i)&&(r=1-r),n){let e=0;for(;void 0!==n[e+1]&&n[e+1]<r;)e++;return e>=s?[s,0,!0]:[e,(r-n[e])/(n[e+1]-n[e]),!1]}{let e=Math.floor((t-1)*r);return[e,(r-e/s)*s,!1]}}setValue(e,t,n){if(this.relative)switch(t){case"pos":e.pos=e.base.pos.add(n);break;case"angle":e.angle=e.base.angle+n;break;case"scale":e.scale=e.base.scale.scale(n);break;case"opacity":e.opacity=e.base.opacity*n;break;default:e[t]=n}else e[t]=n}serialize(){let e={duration:this.duration,keys:[]};return this.loops&&(e.loops=this.loops),"forward"!==this.direction&&(e.direction=this.direction),this.easing!=Zt.linear&&(e.easing=this.easing.name),"linear"!==this.interpolation&&(e.interpolation=this.interpolation),this.timing&&(e.timing=this.timing),this.easings&&(e.easings=this.easings.map((e=>this.easing.name))),e}};function fi(e,t){return t.add(t.sub(e))}var pi=class extends ci{keys;constructor(e,t,n,s){super(e,n,s),this.keys=t}update(e,t){let[n,s,r]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(0==s||"none"===this.interpolation)this.setValue(e,this.name,this.keys[n]);else{let t=this.easings?this.easings[n]:this.easing;this.setValue(e,this.name,l(this.keys[n],this.keys[n+1],t(s)))}return r}serialize(){return Object.assign(super.serialize(),{keys:this.keys})}},gi=class extends ci{keys;curves;dcurves;constructor(e,t,n,s,r){if(super(e,n,s),this.keys=t,"spline"===this.interpolation){this.curves=[],r&&(this.dcurves=[]);for(let e=0;e<this.keys.length-1;e++){let t=this.keys[e],n=e+1,s=this.keys[n],i=e>0?this.keys[e-1]:fi(s,t),a=n<this.keys.length-1?this.keys[n+1]:fi(t,s);this.curves.push(pe(i,t,s,a)),r&&this.dcurves?.push(pe(i,t,s,a,we))}}}update(e,t){let[n,s,r]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(0==s||"none"===this.interpolation)this.setValue(e,this.name,this.keys[n]);else{let t=this.easings?this.easings[n]:this.easing;switch(this.interpolation){case"linear":this.setValue(e,this.name,this.keys[n].lerp(this.keys[n+1],t(s)));break;case"slerp":this.setValue(e,this.name,this.keys[n].slerp(this.keys[n+1],t(s)));break;case"spline":if(this.curves){this.setValue(e,this.name,this.curves[n](t(s))),this.dcurves&&this.setValue(e,"angle",this.dcurves[n](t(s)).angle());break}}}return r}serialize(){return Object.assign(super.serialize(),{keys:this.keys.map((e=>[e.x,e.y]))})}},mi=class extends ci{keys;constructor(e,t,n,s){super(e,n,s),this.keys=t}update(e,t){let[n,s,r]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(0==s||"none"==this.interpolation)this.setValue(e,this.name,this.keys[n]);else{let t=this.easings?this.easings[n]:this.easing;this.setValue(e,this.name,this.keys[n].lerp(this.keys[n+1],t(s)))}return r}serialize(){return Object.assign(super.serialize(),{keys:this.keys})}};function wi(e={}){let n=[],r=0,i=!1;return{id:"animate",require:e.followMotion?["rotate"]:void 0,base:{pos:c(0,0),angle:0,scale:c(1,1),opacity:1},animation:{paused:!1,seek(e){r=t(e,0,this.duration),n.forEach((e=>{e.isFinished=!1})),i=!1},get duration(){return n.reduce(((e,t)=>Math.max(t.duration,e)),0)}},add(){e.relative&&(this.has("pos")&&(this.base.pos=this.pos.clone()),this.has("rotate")&&(this.base.angle=this.angle),this.has("scale")&&(this.base.scale=this.scale),this.has("opacity")&&(this.base.opacity=this.opacity))},update(){if(this.animation.paused)return;let e,t=!0;r+=Pt();for(let s of n)e=s.update(this,r),e&&!s.isFinished&&(s.isFinished=!0,this.trigger("animateChannelFinished",s.name)),t&&=e;t&&!i&&(i=!0,this.trigger("animateFinished"))},animate(t,r,a){i=!1,this.unanimate(t),"number"==typeof r[0]?n.push(new pi(t,r,a,e.relative||!1)):r[0]instanceof d?n.push(new gi(t,r,a,e.relative||!1,"pos"===t&&(e.followMotion||!1))):r[0]instanceof s&&n.push(new mi(t,r,a,e.relative||!1))},unanimate(e){let t=n.findIndex((t=>t.name===e));t>=0&&n.splice(t,1)},unanimateAll(){n.splice(0,n.length)},onAnimateFinished(e){return this.on("animateFinished",e)},onAnimateChannelFinished(e){return this.on("animateChannelFinished",e)},serializeAnimationChannels:()=>n.reduce(((e,t)=>(e[t.name]=t.serialize(),e)),{}),serializeAnimationOptions(){let t={};return e.followMotion&&(t.followMotion=!0),e.relative&&(t.relative=!0),t}}}function yi(e,t){let n={name:e.name};return e.has("animate")&&(n.channels=e.serializeAnimationChannels(),Object.assign(n,e.serializeAnimationOptions())),e.children.length>0&&(n.children=e.children.filter((e=>e.has("named"))).map((e=>yi(e,e.name)))),n}function Ai(e=2,t=1){let n=0;return{require:["scale"],update(){let s=Math.sin(n*e)*t;s<0&&this.destroy(),this.scale=c(s),n+=Pt()}}}function xi(e,t){if(null==e)throw new Error("health() requires the initial amount of hp");return{id:"health",hurt(t=1){this.setHP(e-t),this.trigger("hurt",t)},heal(t=1){let n=e;this.setHP(e+t),this.trigger("heal",e-n)},hp:()=>e,maxHP:()=>t??null,setMaxHP(e){t=e},setHP(n){(e=t?Math.min(t,n):n)<=0&&this.trigger("death")},onHurt(e){return this.on("hurt",e)},onHeal(e){return this.on("heal",e)},onDeath(e){return this.on("death",e)},inspect:()=>`health: ${e}`}}function vi(e,t={}){if(null==e)throw new Error("lifespan() requires time");let n=t.fade??0;return{id:"lifespan",require:["opacity"],add(){zi.game.root.wait(e,(()=>{this.opacity=this.opacity??1,n>0?zi.game.root.tween(this.opacity,0,n,(e=>this.opacity=e),Zt.linear).onEnd((()=>{this.destroy()})):this.destroy()}))}}}function bi(e){return{id:"named",name:e}}function Ei(e,t,n){if(!e)throw new Error("state() requires an initial state");let s={};function r(e){s[e]||(s[e]={enter:new Qe,end:new Qe,update:new Qe,draw:new Qe})}function i(e,t,n){return r(t),s[t][e].add(n)}function a(e,t,...n){r(t),s[t][e].trigger(...n)}let o=!1;return{id:"state",state:e,enterState(e,...s){if(o=!0,t&&!t.includes(e))throw new Error(`State not found: ${e}`);let r=this.state;if(n){if(!n?.[r])return;let t="string"==typeof n[r]?[n[r]]:n[r];if(!t.includes(e))throw new Error(`Cannot transition state from "${r}" to "${e}". Available transitions: ${t.map((e=>`"${e}"`)).join(", ")}`)}a("end",r,...s),this.state=e,a("enter",e,...s),a("enter",`${r} -> ${e}`,...s)},onStateTransition:(e,t,n)=>i("enter",`${e} -> ${t}`,n),onStateEnter:(e,t)=>i("enter",e,t),onStateUpdate:(e,t)=>i("update",e,t),onStateDraw:(e,t)=>i("draw",e,t),onStateEnd:(e,t)=>i("end",e,t),update(){o||(a("enter",e),o=!0),a("update",this.state)},draw(){a("draw",this.state)},inspect(){return`state: ${this.state}`}}}function Mi(e){return{id:"stay",stay:!0,scenesToStay:e}}function Si(e=!0,t){let n,s;return{id:"textInput",hasFocus:e,require:["text"],typedText:"",add(){let e=()=>{this.text=this.typedText.replace(/([\[\\])/g,"\\$1")};n=zi.k.onCharInput((n=>{this.hasFocus&&(!t||this.typedText.length<t)&&(zi.k.isKeyDown("shift")?this.typedText+=n.toUpperCase():this.typedText+=n,e())})),s=zi.k.onKeyPressRepeat("backspace",(()=>{this.hasFocus&&(this.typedText=this.typedText.slice(0,-1)),e()}))},destroy(){n.cancel(),s.cancel()}}}function qi(e=1e3){return{id:"timer",maxLoopsPerFrame:e,loop(e,t,n=1/0,s=!1){let r=s?0:e,i=new Qe,a=this.onUpdate((()=>{r+=zi.app.state.dt;for(let s=0;r>=e&&s<this.maxLoopsPerFrame;s++)if(n--,t(),r-=e,n<=0)return a.cancel(),void i.trigger()}));return{get paused(){return a.paused},set paused(e){a.paused=e},cancel:a.cancel,onEnd(e){i.add(e)},then(e){return i.add(e),this}}},wait(e,t){return this.loop(e,t??(()=>{}),1,!0)},tween(e,t,n,s,r=Zt.linear){let i=0,a=[],o=this.onUpdate((()=>{i+=zi.app.state.dt;let h=Math.min(i/n,1);s(l(e,t,r(h))),1===h&&(o.cancel(),s(t),a.forEach((e=>e())))}));return{get paused(){return o.paused},set paused(e){o.paused=e},onEnd(e){a.push(e)},then(e){return this.onEnd(e),this},cancel(){o.cancel()},finish(){o.cancel(),s(t),a.forEach((e=>e()))}}}}}var ki=0;function Bi(e={}){let t={},n=new Set,s=[];return{id:"area",collisionIgnore:e.collisionIgnore??[],add(){ki++,this.area.cursor&&s.push(this.onHover((()=>zi.app.setCursor(this.area.cursor)))),s.push(this.onCollideUpdate(((e,s)=>{if(!e.id)throw new Error("area() requires the object to have an id");t[e.id]||this.trigger("collide",e,s),s&&(t[e.id]=s,n.add(e.id))})))},destroy(){ki--;for(let e of s)e.cancel()},fixedUpdate(){for(let e in t)n.has(Number(e))||(this.trigger("collideEnd",t[e].target),delete t[e]);n.clear()},drawInspect(){let e=this.localArea();ln(),on(this.area.offset);let t={outline:{width:4/mn(),color:r(0,0,255)},anchor:this.anchor,fill:!1,fixed:Ps(this)};e instanceof _?xs({...t,pos:e.pos,width:e.width*this.area.scale.x,height:e.height*this.area.scale.y}):e instanceof te?ss({...t,pts:e.pts,scale:this.area.scale}):e instanceof $&&is({...t,pos:e.center,radius:e.radius}),cn()},area:{shape:e.shape??null,scale:e.scale?c(e.scale):c(1),offset:e.offset??c(0),cursor:e.cursor??null},isClicked(){return zi.app.isMousePressed()&&this.isHovering()},isHovering(){let e=Ps(this)?zi.k.mousePos():zi.k.toWorld(zi.k.mousePos());return this.hasPoint(e)},checkCollision(e){if(!e.id)throw new Error("checkCollision() requires the object to have an id");return t[e.id]??null},getCollisions:()=>Object.values(t),isColliding(e){if(!e.id)throw new Error("isColliding() requires the object to have an id");return!!t[e.id]},isOverlapping(e){if(!e.id)throw new Error("isOverlapping() requires the object to have an id");let n=t[e.id];return n&&n.hasOverlap()},onClick(e,t="left"){let n=zi.app.onMousePress(t,(()=>{this.isHovering()&&e()}));return s.push(n),n},onHover(e){let t=!1;return this.onUpdate((()=>{t?t=this.isHovering():this.isHovering()&&(t=!0,e())}))},onHoverUpdate(e){return this.onUpdate((()=>{this.isHovering()&&e()}))},onHoverEnd(e){let t=!1;return this.onUpdate((()=>{t?this.isHovering()||(t=!1,e()):t=this.isHovering()}))},onCollide(e,t){if("function"==typeof e&&void 0===t)return this.on("collide",e);if("string"==typeof e)return this.onCollide(((n,s)=>{n.is(e)&&t?.(n,s)}));throw new Error("onCollide() requires either a function or a tag")},onCollideUpdate(e,t){if("function"==typeof e&&void 0===t)return this.on("collideUpdate",e);if("string"==typeof e)return this.on("collideUpdate",((n,s)=>n.is(e)&&t?.(n,s)));throw new Error("onCollideUpdate() requires either a function or a tag")},onCollideEnd(e,t){if("function"==typeof e&&void 0===t)return this.on("collideEnd",e);if("string"==typeof e)return this.on("collideEnd",(n=>n.is(e)&&t?.(n)));throw new Error("onCollideEnd() requires either a function or a tag")},hasPoint(e){return j(this.worldArea(),e)},resolveCollision(e){let t=this.checkCollision(e);t&&!t.resolved&&(this.pos=this.pos.add(t.displacement),t.resolved=!0)},localArea(){return this.area.shape?this.area.shape:this.renderArea()},worldArea(){let e=this.localArea();if(!(e instanceof te||e instanceof _))throw new Error("Only support polygon and rect shapes for now");let t=this.transform.clone().translate(this.area.offset).scale(c(this.area.scale??1));if(e instanceof _){let n=Vt(this.anchor||Te).add(1,1).scale(-.5).scale(e.width,e.height);t.translate(n)}return e.transform(t)},screenArea(){let e=this.worldArea();return Ps(this)?e:e.transform(zi.game.cam.transform)},inspect(){return this.area.scale?.x==this.area.scale?.y?`area: ${this.area.scale?.x?.toFixed(1)}x`:`area: (${this.area.scale?.x?.toFixed(1)}x, ${this.area.scale.y?.toFixed(1)}y)`}}}function Ri(e={}){let t,n=null,s=null,r=!1,i=c(0),a=null,o=null;return{id:"body",require:["pos"],vel:c(0),drag:e.drag??0,jumpForce:e.jumpForce??640,gravityScale:e.gravityScale??1,isStatic:e.isStatic??!1,mass:e.mass??1,add(){if(a=this.pos.clone(),o=this.pos.clone(),t=this.pos.clone(),0===this.mass)throw new Error("Can't set body mass to 0");this.has("area")&&(this.onCollideUpdate(((e,t)=>{if(!t||!e.has("body")||t.resolved)return;this.trigger("beforePhysicsResolve",t);let n=t.reverse();if(e.trigger("beforePhysicsResolve",n),!(t.resolved||n.resolved||this.isStatic&&e.isStatic)){if(this.isStatic||e.isStatic){let n=!this.isStatic&&e.isStatic?t:t.reverse();n.source.pos=n.source.pos.add(n.displacement),n.source.transform=tn(n.source)}else{let n=this.mass+e.mass;this.pos=this.pos.add(t.displacement.scale(e.mass/n)),e.pos=e.pos.add(t.displacement.scale(-this.mass/n)),this.transform=tn(this),e.transform=tn(e)}t.resolved=!0,this.trigger("physicsResolve",t),e.trigger("physicsResolve",t.reverse())}})),this.onPhysicsResolve((e=>{if(zi.game.gravity)if(e.isBottom()&&this.isFalling()){this.vel=this.vel.reject(zi.game.gravity.unit());let t=n;n=e.target,t!=n&&(s=e.target.pos),r?r=!1:t||(this.trigger("ground",n),e.target.trigger("land",this))}else e.isTop()&&this.isJumping()&&(this.vel=this.vel.reject(zi.game.gravity.unit()),this.trigger("headbutt",e.target),e.target.trigger("headbutted",this))})))},update(){n&&this.isColliding(n)&&n.exists()&&n.has("body")&&(s&&!n.pos.eq(s)&&!1!==e.stickToPlatform&&this.moveBy(n.pos.sub(s)),s=n.pos);let r=Ft();r&&(this.pos.x==t.x&&(this.pos.x=l(a.x,o.x,r/Tt()),t.x=this.pos.x),this.pos.y==t.y&&(this.pos.y=l(a.y,o.y,r/Tt()),t.y=this.pos.y))},fixedUpdate(){if(a&&(this.pos.x==t.x&&(this.pos.x=a.x),this.pos.y==t.y&&(this.pos.y=a.y),a=null),zi.game.gravity&&!this.isStatic){r&&(n=null,s=null,this.trigger("fallOff"),r=!1),n&&(!this.isColliding(n)||!n.exists()||!n.has("body"))&&(r=!0);let t=this.vel.clone();this.vel=this.vel.add(zi.game.gravity.scale(this.gravityScale*Pt()));let i=e.maxVelocity??65536;this.vel.slen()>i*i&&(this.vel=this.vel.unit().scale(i)),t.dot(zi.game.gravity)<0&&this.vel.dot(zi.game.gravity)>=0&&this.trigger("fall")}if(this.vel.x+=i.x*Pt(),this.vel.y+=i.y*Pt(),this.vel.x*=1-this.drag*Pt(),this.vel.y*=1-this.drag*Pt(),this.move(this.vel),Ft()){a=this.pos.clone();let e=this.vel.add(i.scale(Pt()));o=this.pos.add(e.scale(Pt())),t=this.pos.clone()}i.x=0,i.y=0},onPhysicsResolve(e){return this.on("physicsResolve",e)},onBeforePhysicsResolve(e){return this.on("beforePhysicsResolve",e)},curPlatform:()=>n,isGrounded:()=>null!==n,isFalling(){return this.vel.dot(Lr())>0},isJumping(){return this.vel.dot(Lr())<0},applyImpulse(e){this.isStatic||(this.vel=this.vel.add(e))},addForce(e){this.isStatic||(i.x+=e.x/this.mass,i.y+=e.y/this.mass)},jump(e){this.isStatic||(n=null,s=null,this.vel=Lr().scale(-e||-this.jumpForce))},onGround(e){return this.on("ground",e)},onFall(e){return this.on("fall",e)},onFallOff(e){return this.on("fallOff",e)},onHeadbutt(e){return this.on("headbutt",e)},onLand(e){return this.on("land",e)},onHeadbutted(e){return this.on("headbutted",e)},inspect(){return`gravityScale: ${this.gravityScale}x`}}}function Ci(e=2){let t=e;return{id:"doubleJump",require:["body"],numJumps:e,add(){this.onGround((()=>{t=this.numJumps}))},doubleJump(e){t<=0||(t<this.numJumps&&this.trigger("doubleJump"),t--,this.jump(e))},onDoubleJump(e){return this.on("doubleJump",e)},inspect:()=>`jumpsLeft: ${t}`}}function Ii(e){return{id:"surfaceEffector",require:["area"],speed:e.speed,speedVariation:e.speedVariation??0,forceScale:e.speedVariation??.9,add(){this.onCollideUpdate("body",((e,t)=>{let n=t?.normal.normal(),s=e.vel.project(n),r=n?.scale(this.speed)?.sub(s);e.addForce(r?.scale(e.mass*this.forceScale))}))}}}function Pi(e){return{id:"areaEffector",require:["area"],useGlobalAngle:e.useGlobalAngle||!1,forceAngle:e.forceAngle,forceMagnitude:e.forceMagnitude,forceVariation:e.forceVariation??0,linearDrag:e.linearDrag??0,add(){this.onCollideUpdate("body",((e,t)=>{if(!e.has("body"))return;let n=d.fromAngle(this.forceAngle).scale(this.forceMagnitude);e.addForce(n),this.linearDrag&&e.addForce(e.vel.scale(-this.linearDrag))}))}}}function Ti(e){return{id:"pointEffector",require:["area","pos"],forceMagnitude:e.forceMagnitude,forceVariation:e.forceVariation??0,distanceScale:e.distanceScale??1,forceMode:e.forceMode||"inverseLinear",linearDrag:e.linearDrag??0,add(){this.onCollideUpdate("body",((e,t)=>{let n=this.pos.sub(e.pos),s=n.len(),r=s*this.distanceScale/10,i="constant"===this.forceMode?1:"inverseLinear"===this.forceMode?1/r:1/r**2,a=n.scale(this.forceMagnitude*i/s);e.addForce(a),this.linearDrag&&e.addForce(e.vel.scale(-this.linearDrag))}))}}}function Fi(e){return{id:"constantForce",require:["body"],force:e.force,update(){this.force&&this.addForce(this.force)}}}function Di(e){return{id:"platformEffector",require:["area","body"],surfaceArc:e.surfaceArc??180,useOneWay:e.useOneWay??!1,add(){this.onBeforePhysicsResolve((e=>{let t=e.target.vel,n=Lr().scale(-1).angleBetween(t);Math.abs(n)>this.surfaceArc/2&&e.preventResolution()}))}}}function Oi(e){return{id:"buoyancyEffector",require:["area"],surfaceLevel:e.surfaceLevel,density:e.density??1,linearDrag:e.linearDrag??1,angularDrag:e.angularDrag??.2,flowAngle:e.flowAngle??0,flowMagnitude:e.flowMagnitude??0,flowVariation:e.flowVariation??0,add(){this.onCollideUpdate("body",((e,t)=>{let n=e,s=n.worldArea(),[r,i]=s.cut(c(-100,this.surfaceLevel),c(100,this.surfaceLevel));r&&(this.applyBuoyancy(n,r),this.applyDrag(n,r)),this.flowMagnitude&&n.addForce(d.fromAngle(this.flowAngle).scale(this.flowMagnitude))}))},applyBuoyancy(e,t){let n=this.density*t.area(),s=c(0,1).scale(-n);e.addForce(s)},applyDrag(e,t){let n=e.vel,s=this.density*this.linearDrag,r=n.scale(-s);e.addForce(r)}}}function Ui(e){if(!e)throw new Error("Please define an anchor");return{id:"anchor",anchor:e,inspect(){return"string"==typeof this.anchor?"anchor: "+this.anchor:"anchor: "+this.anchor.toString()}}}function Li(){return{id:"fixed",fixed:!0}}function Ni(e,t){return{id:"follow",require:["pos"],follow:{obj:e,offset:t??c(0)},add(){e.exists()&&(this.pos=this.follow.obj.pos.add(this.follow.offset))},update(){e.exists()&&(this.pos=this.follow.obj.pos.add(this.follow.offset))}}}function Hi(e){let t=zi.game.layers?.indexOf(e);return{id:"layer",get layerIndex(){return t??null},get layer(){return t?zi.game.layers?.[t]??null:null},set layer(e){if(t=zi.game.layers?.indexOf(e),-1==t)throw Error("Invalid layer name")},inspect(){return`layer: ${this.layer}`}}}function ji(e,t){let n="number"==typeof e?d.fromAngle(e):e.unit();return{id:"move",require:["pos"],update(){this.move(n.scale(t))}}}function Ki(e={}){let t=!1,n=new _(c(0),pn(),gn()),s=new _(c(0),0,0),r=n=>{n.isOffScreen()?(t||(n.trigger("exitView"),t=!0),e.hide&&(n.hidden=!0),e.pause&&(n.paused=!0),e.destroy&&n.destroy()):(t&&(n.trigger("enterView"),t=!1),e.hide&&(n.hidden=!1),e.pause&&(n.paused=!1))};return{id:"offscreen",require:["pos"],offscreenDistance:e.distance??200,isOffScreen(){let e=this.screenPos();if(!e)return!1;if(n.width=pn(),n.height=gn(),!this.offscreenDistance&&this.width&&this.height)return s.width=this.width,s.height=this.height,s.pos=this.pos,s.collides(n);let t=this.offscreenDistance?this.offscreenDistance:200;return!P(n,e)&&n.sdistToPoint(e)>t*t},onExitScreen(e){return this.on("exitView",e)},onEnterScreen(e){return this.on("enterView",e)},add(){e.pause&&e.unpause?Zs((()=>r(this))):this.onUpdate((()=>r(this)))}}}function Gi(...e){return{id:"pos",pos:c(...e),moveBy(...e){this.pos=this.pos.add(c(...e))},move(...e){this.moveBy(c(...e).scale(Pt()))},moveTo(...e){if("number"==typeof e[0]&&"number"==typeof e[1])return this.moveTo(c(e[0],e[1]),e[2]);let t=e[0],n=e[1];if(void 0===n)return void(this.pos=c(t));let s=t.sub(this.pos);s.len()<=n*Pt()?this.pos=c(t):this.move(s.unit().scale(n))},worldPos(e=null){return e?(this.pos=this.pos.add(this.fromWorld(e)),null):this.parent?this.parent.transform.multVec2(this.pos):this.pos},toWorld(e){return this.parent?this.parent.transform.multVec2(this.pos.add(e)):this.pos.add(e)},fromWorld(e){return this.parent?this.parent.transform.invert().multVec2(e).sub(this.pos):e.sub(this.pos)},screenPos(e=null){if(e)return this.pos=this.pos.add(this.fromScreen(e)),null;{let e=this.worldPos();return e?Ps(this)?e:Br(e):null}},toScreen(e){let t=this.toWorld(e);return Ps(this)?t:Br(t)},fromScreen(e){return Ps(this)?this.fromWorld(e):this.fromWorld(Rr(e))},toOther(e,t){return e.fromWorld(this.toWorld(t))},fromOther(e,t){return e.toOther(this,t)},inspect(){return`pos: (${Math.round(this.pos.x)}x, ${Math.round(this.pos.y)}y)`},drawInspect(){is({color:r(255,0,0),radius:4/mn()})}}}function Vi(e){return{id:"rotate",angle:e??0,rotateBy(e){this.angle+=e},rotateTo(e){this.angle=e},inspect(){return`angle: ${Math.round(this.angle)}`}}}function Yi(...e){if(0===e.length)return Yi(1);let t=c(...e);return{id:"scale",set scale(e){if(!(e instanceof d))throw Error("The scale property on scale is a vector. Use scaleTo or scaleBy to set the scale with a number.");t=c(e)},get scale(){return t},scaleTo(...e){t=c(...e)},scaleBy(...e){t=t.scale(c(...e))},inspect:()=>t.x==t.y?`scale: ${t.x.toFixed(1)}x`:`scale: (${t.x.toFixed(1)}x, ${t.y.toFixed(1)}y)`}}function Xi(e){return{id:"z",z:e,inspect(){return`z: ${this.z}`}}}var zi={k:null,globalOpt:null,gfx:null,game:null,app:null,assets:null,fontCacheCanvas:null,fontCacheC2d:null,debug:null,audio:null,pixelDensity:null,canvas:null,gscale:null,kaSprite:null,boomSprite:null},Qi=(e={tagsAsComponents:!0})=>{zi.k&&(console.warn("KAPLAY already initialized, you are calling kaplay() multiple times, it may lead bugs!"),zi.k.quit()),zi.globalOpt=e;let n=e.root??document.body;n===document.body&&(document.body.style.width="100%",document.body.style.height="100%",document.body.style.margin="0px",document.documentElement.style.width="100%",document.documentElement.style.height="100%");let g=e.canvas??n.appendChild(document.createElement("canvas"));zi.canvas=g;let m=e.scale??1;zi.gscale=m;let A=e.width&&e.height&&!e.stretch&&!e.letterbox;A?(g.width=e.width*m,g.height=e.height*m):(g.width=g.parentElement.offsetWidth,g.height=g.parentElement.offsetHeight);let v=["outline: none","cursor: default"];if(A){let e=g.width,t=g.height;v.push(`width: ${e}px`),v.push(`height: ${t}px`)}else v.push("width: 100%"),v.push("height: 100%");e.crisp&&(v.push("image-rendering: pixelated"),v.push("image-rendering: crisp-edges")),g.style.cssText=v.join(";");let T=e.pixelDensity||1;zi.pixelDensity=T,g.width*=T,g.height*=T,g.tabIndex=0;let F=document.createElement("canvas");F.width=256,F.height=256,zi.fontCacheCanvas=F;let U=F.getContext("2d",{willReadFrequently:!0});zi.fontCacheC2d=U;let L=It({canvas:g,touchToMouse:e.touchToMouse,gamepads:e.gamepads,pixelDensity:e.pixelDensity,maxFPS:e.maxFPS,buttons:e.buttons});zi.app=L;let H=[],j=L.canvas.getContext("webgl",{antialias:!0,depth:!0,stencil:!0,alpha:!0,preserveDrawingBuffer:!0});if(!j)throw new Error("WebGL not supported");let K=j,G=function(e,t={}){let n=[],s=null,[r,i]=fs((t=>e.bindTexture(e.TEXTURE_2D,t))),[a,o]=fs((t=>e.bindBuffer(e.ARRAY_BUFFER,t))),[l,h]=fs((t=>e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t))),[u,d]=fs((t=>e.bindFramebuffer(e.FRAMEBUFFER,t))),[c,f]=fs((t=>e.bindRenderbuffer(e.RENDERBUFFER,t))),[p,g]=fs((t=>{if(!t)return;let{x:n,y:s,w:r,h:i}=t;e.viewport(n,s,r,i)})),[m,w]=fs((t=>e.useProgram(t)));return p({x:0,y:0,w:e.drawingBufferWidth,h:e.drawingBufferHeight}),{gl:e,opts:t,onDestroy:function(e){n.push(e)},destroy:function(){n.forEach((e=>e()));let t=e.getExtension("WEBGL_lose_context");t&&t.loseContext()},pushTexture2D:r,popTexture2D:i,pushArrayBuffer:a,popArrayBuffer:o,pushElementArrayBuffer:l,popElementArrayBuffer:h,pushFramebuffer:u,popFramebuffer:d,pushRenderbuffer:c,popRenderbuffer:f,pushViewport:p,popViewport:g,pushProgram:m,popProgram:w,setVertexFormat:function(t){if(it(t,s))return;s=t;let n=t.reduce(((e,t)=>e+t.size),0);t.reduce(((t,s,r)=>(e.vertexAttribPointer(r,s.size,e.FLOAT,!1,4*n,t),e.enableVertexAttribArray(r),t+4*s.size)),0)}}}(K,{texFilter:e.texFilter}),V=((e,t)=>{let n=zn(t,je,Ke),s=e.pixelDensity??1,i=e.scale??1,{gl:a}=t,o=us.fromImage(t,new ImageData(new Uint8ClampedArray([255,255,255,255]),1,1)),l=e.width&&e.height?new ds(t,e.width*s*i,e.height*s*i):new ds(t,a.drawingBufferWidth,a.drawingBufferHeight),h=null,u=1;e.background&&("string"==typeof e.background?h=r(e.background):(h=r(...e.background),u=e.background[3]??1),a.clearColor(h.r/255,h.g/255,h.b/255,u??1)),a.enable(a.BLEND),a.blendFuncSeparate(a.ONE,a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE_MINUS_SRC_ALPHA);let d=new cs(t,Ue,Le,12288),c=us.fromImage(t,new ImageData(new Uint8ClampedArray([128,128,128,255,190,190,190,255,190,190,190,255,128,128,128,255]),2,2),{wrap:"repeat",filter:"nearest"});return{lastDrawCalls:0,ggl:t,defShader:n,defTex:o,frameBuffer:l,postShader:null,postShaderUniform:null,renderer:d,transform:new w,transformStack:[],bgTex:c,bgColor:h,bgAlpha:u,width:e.width??a.drawingBufferWidth/s/i,height:e.height??a.drawingBufferHeight/s/i,viewport:{x:0,y:0,width:a.drawingBufferWidth,height:a.drawingBufferHeight,scale:1},fixed:!1}})(e,G);zi.gfx=V;let Y=(()=>{let e=new(window.AudioContext||window.webkitAudioContext),t=e.createGain();t.connect(e.destination);let n=new Zn(e.createBuffer(1,1,44100));return e.decodeAudioData(Nr.buffer.slice(0)).then((e=>{n.buf=e})).catch((e=>{console.error("Failed to load burp: ",e)})),{ctx:e,masterNode:t,burpSnd:n}})();zi.audio=Y;let X=((e,t)=>({urlPrefix:"",sprites:new vn,fonts:new vn,bitmapFonts:new vn,sounds:new vn,shaders:new vn,custom:new vn,music:{},packer:new yn(e,2048,2048,t),loaded:!1}))(G,e.spriteAtlasPadding??0);zi.assets=X;let z={events:new We,objEvents:new We,root:Fr([]),gravity:null,scenes:{},currentScene:null,layers:null,defaultLayerIndex:0,logs:[],cam:{pos:null,scale:new d(1),angle:0,shake:0,transform:new w}};function Q(){K.clear(K.COLOR_BUFFER_BIT),V.frameBuffer.bind(),K.clear(K.COLOR_BUFFER_BIT),V.bgColor||vs((()=>{ys({width:pn(),height:gn(),quad:new f(0,0,pn()/64,gn()/64),tex:V.bgTex,fixed:!0})})),V.renderer.numDraws=0,V.fixed=!1,V.transformStack.length=0,V.transform=new w}function W(){fn(),V.lastDrawCalls=V.renderer.numDraws,V.frameBuffer.unbind(),K.viewport(0,0,K.drawingBufferWidth,K.drawingBufferHeight);let e=V.width,t=V.height;V.width=K.drawingBufferWidth/T,V.height=K.drawingBufferHeight/T,Bs({flipY:!0,tex:V.frameBuffer.tex,pos:new d(V.viewport.x,V.viewport.y),width:V.viewport.width,height:V.viewport.height,shader:V.postShader,uniform:"function"==typeof V.postShaderUniform?V.postShaderUniform():V.postShaderUniform,fixed:!0}),fn(),V.width=e,V.height=t}zi.game=z,z.root.use(qi());let we=!1,ye={inspect:!1,set timeScale(e){zi.app.state.timeScale=e},get timeScale(){return zi.app.state.timeScale},showLog:!0,fps:()=>L.fps(),numFrames:()=>L.numFrames(),stepFrame:Ge,drawCalls:()=>V.lastDrawCalls,clearLog:()=>z.logs=[],log:(...t)=>{let n=e.logMax??8,s=t.length>1?t.concat(" ").join(" "):t[0];z.logs.unshift({msg:s,time:L.time()}),z.logs.length>n&&(z.logs=z.logs.slice(0,n))},error:e=>ye.log(new Error(e.toString?e.toString():e)),curRecording:null,numObjects:()=>Be("*",{recursive:!0}).length,get paused(){return we},set paused(e){we=e,e?Y.ctx.suspend():Y.ctx.resume()}};function Ae(e,t){window.localStorage[e]=JSON.stringify(t)}function xe(t,...n){let s,r=t(_e);s="function"==typeof r?r(...n)(_e):r;for(let t in s)_e[t]=s[t],!1!==e.global&&(window[t]=s[t]);return _e}zi.debug=ye;let ve=z.root.add.bind(z.root),qe=z.root.readd.bind(z.root),ke=z.root.removeAll.bind(z.root),Be=z.root.get.bind(z.root),Re=z.root.wait.bind(z.root),Te=z.root.loop.bind(z.root),Fe=z.root.query.bind(z.root),Oe=z.root.tween.bind(z.root),Ne=Fn(null,"data:image/png;base64,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"),He=Fn(null,"data:image/png;base64,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");function Ge(){z.root.update()}zi.kaSprite=Ne,zi.boomSprite=He;class Ve{source;target;normal;distance;resolved=!1;constructor(e,t,n,s,r=!1){this.source=e,this.target=t,this.normal=n,this.distance=s,this.resolved=r}get displacement(){return this.normal.scale(this.distance)}reverse(){return new Ve(this.target,this.source,this.normal.scale(-1),this.distance,this.resolved)}hasOverlap(){return!this.displacement.isZero()}isLeft(){return this.displacement.cross(z.gravity||c(0,1))>0}isRight(){return this.displacement.cross(z.gravity||c(0,1))<0}isTop(){return this.displacement.dot(z.gravity||c(0,1))>0}isBottom(){return this.displacement.dot(z.gravity||c(0,1))<0}preventResolution(){this.resolved=!0}}function Xe(){if(!(ki>0))return;let t={},n=e.hashGridSize||64,s=new w,r=[];!function e(i){if(r.push(s.clone()),i.pos&&s.translate(i.pos),i.scale&&s.scale(i.scale),i.angle&&s.rotate(i.angle),i.transform=s.clone(),i.c("area")&&!i.paused){let e=i,s=e.worldArea().bbox(),r=Math.floor(s.pos.x/n),a=Math.floor(s.pos.y/n),o=Math.ceil((s.pos.x+s.width)/n),l=Math.ceil((s.pos.y+s.height)/n),h=new Set;for(let n=r;n<=o;n++)for(let s=a;s<=l;s++)if(t[n])if(t[n][s]){let r=t[n][s];e:for(let t of r){if(t.paused||!t.exists()||h.has(t.id))continue;for(let n of e.collisionIgnore)if(t.is(n))continue e;for(let n of t.collisionIgnore)if(e.is(n))continue e;let n=Se(e.worldArea(),t.worldArea());if(n){let s=new Ve(e,t,n.normal,n.distance);e.trigger("collideUpdate",t,s);let r=s.reverse();r.resolved=s.resolved,t.trigger("collideUpdate",e,r)}h.add(t.id)}r.push(e)}else t[n][s]=[e];else t[n]={},t[n][s]=[e]}i.children.forEach(e),s=r.pop()}(z.root)}function Je(e){console.error(e),Y.ctx.suspend();let t=e.message??String(e)??"Unknown error, check console for more info";L.run((()=>{}),(()=>{Q(),vs((()=>{let n=pn(),s=gn(),i={size:36,width:n-64,letterSpacing:4,lineSpacing:4,font:De,fixed:!0};xs({width:n,height:s,color:r(0,0,255),fixed:!0});let a=ws({...i,text:"Error",pos:c(32),color:r(255,128,0),fixed:!0});As(a),Is({...i,text:t,pos:c(32,32+a.height+16),fixed:!0}),cn(),z.events.trigger("error",e)})),W()}))}let Ze=!0;L.run((()=>{try{X.loaded&&(ye.paused||z.root.fixedUpdate(),Xe())}catch(e){Je(e)}}),((t,n)=>{try{t(),X.loaded||1===kn()&&!Ze&&(X.loaded=!0,Bn().forEach((e=>z.events.trigger("loadError",...e))),z.events.trigger("load")),!X.loaded&&!1!==e.loadingScreen||Ze?(Q(),function(){let e=kn();zi.game.events.numListeners("loading")>0?zi.game.events.trigger("loading",e):vs((()=>{let t=pn()/2,n=c(pn()/2,gn()/2).sub(c(t/2,12));xs({pos:c(0),width:pn(),height:gn(),color:r(0,0,0)}),xs({pos:n,width:t,height:24,fill:!1,outline:{width:4}}),xs({pos:n,width:t*e,height:24})}))}(),W()):(ye.paused||Ge(),Xe(),Q(),function(){let e=zi.game.cam,t=d.fromAngle(E(0,360)).scale(e.shake);e.shake=l(e.shake,0,5*Pt()),e.transform=(new w).translate(wn()).scale(e.scale).rotate(e.angle).translate((e.pos??wn()).scale(-1).add(t)),zi.game.root.draw(),fn()}(),!1!==e.debug&&Ms(),W()),Ze&&(Ze=!1),z.events.trigger("frameEnd"),n()}catch(e){Je(e)}})),Mt(),Xr();let _e={_k:zi,VERSION:"3001.0.18",loadRoot:Mn,loadProgress:kn,loadSprite:Fn,loadSpriteAtlas:ts,loadSound:$n,loadMusic:es,loadBitmapFont:Vn,loadFont:Kn,loadShader:Wn,loadShaderURL:Jn,loadAseprite:Ln,loadPedit:Yn,loadBean:Un,loadJSON:Sn,load:Cn,getSound:_n,getFont:jn,getBitmapFont:Gn,getSprite:Tn,getShader:Qn,getAsset:Rn,Asset:xn,SpriteData:In,SoundData:Zn,width:pn,height:gn,center:wn,dt:Pt,fixedDt:Tt,restDt:Ft,time:L.time,screenshot:L.screenshot,record:function(e){let t=L.canvas.captureStream(e),n=Y.ctx.createMediaStreamDestination();Y.masterNode.connect(n);let s=new MediaRecorder(t),r=[];return s.ondataavailable=e=>{e.data.size>0&&r.push(e.data)},s.onerror=()=>{Y.masterNode.disconnect(n),t.getTracks().forEach((e=>e.stop()))},s.start(),{resume(){s.resume()},pause(){s.pause()},stop:()=>(s.stop(),Y.masterNode.disconnect(n),t.getTracks().forEach((e=>e.stop())),new Promise((e=>{s.onstop=()=>{e(new Blob(r,{type:"video/mp4"}))}}))),download(e="kaboom.mp4"){this.stop().then((t=>st(e,t)))}}},isFocused:function(){return document.activeElement===L.canvas},setCursor:L.setCursor,getCursor:L.getCursor,setCursorLocked:L.setCursorLocked,isCursorLocked:L.isCursorLocked,setFullscreen:L.setFullscreen,isFullscreen:L.isFullscreen,isTouchscreen:L.isTouchscreen,onLoad:mr,onLoadError:wr,onLoading:fr,onResize:pr,onGamepadConnect:L.onGamepadConnect,onGamepadDisconnect:L.onGamepadDisconnect,onError:gr,onCleanup:function(e){H.push(e)},flash:Sr,setCamPos:yr,getCamPos:Ar,setCamRot:br,getCamRot:Er,setCamScale:xr,getCamScale:vr,getCamTransform:Mr,camPos:Cr,camScale:Ir,camFlash:Tr,camRot:Pr,camTransform:qr,shake:kr,toScreen:Br,toWorld:Rr,setGravity:Dr,getGravity:Or,setGravityDirection:Ur,getGravityDirection:Lr,setBackground:rn,getBackground:an,getGamepads:L.getGamepads,getTreeRoot:$r,add:ve,make:Fr,destroy:_r,destroyAll:ke,get:Be,query:Fe,readd:qe,pos:Gi,scale:Yi,rotate:Vi,color:Ds,opacity:Ns,anchor:Ui,area:Bi,sprite:ri,text:ii,polygon:Gs,rect:Ys,circle:Fs,uvquad:ai,outline:Hs,particles:Ks,body:Ri,platformEffector:Di,surfaceEffector:Ii,areaEffector:Pi,pointEffector:Ti,buoyancyEffector:Oi,constantForce:Fi,doubleJump:Ci,shader:Xs,textInput:Si,timer:qi,fixed:Li,stay:Mi,health:xi,lifespan:vi,named:bi,state:Ei,z:Xi,layer:Hi,move:ji,offscreen:Ki,follow:Ni,fadeIn:Us,mask:Ls,drawon:Os,raycast:Vs,tile:di,animate:wi,serializeAnimation:yi,agent:oi,sentry:ui,patrol:hi,pathfinder:li,trigger:Ws,on:Qs,onFixedUpdate:Js,onUpdate:Zs,onDraw:_s,onAdd:$s,onDestroy:er,onTag:sr,onUntag:rr,onUse:tr,onUnuse:nr,onClick:hr,onCollide:ir,onCollideUpdate:ar,onCollideEnd:or,onHover:ur,onHoverUpdate:dr,onHoverEnd:cr,onKeyDown:L.onKeyDown,onKeyPress:L.onKeyPress,onKeyPressRepeat:L.onKeyPressRepeat,onKeyRelease:L.onKeyRelease,onMouseDown:L.onMouseDown,onMousePress:L.onMousePress,onMouseRelease:L.onMouseRelease,onMouseMove:L.onMouseMove,onCharInput:L.onCharInput,onTouchStart:L.onTouchStart,onTouchMove:L.onTouchMove,onTouchEnd:L.onTouchEnd,onScroll:L.onScroll,onHide:L.onHide,onShow:L.onShow,onGamepadButtonDown:L.onGamepadButtonDown,onGamepadButtonPress:L.onGamepadButtonPress,onGamepadButtonRelease:L.onGamepadButtonRelease,onGamepadStick:L.onGamepadStick,onButtonPress:L.onButtonPress,onButtonDown:L.onButtonDown,onButtonRelease:L.onButtonRelease,mousePos:L.mousePos,mouseDeltaPos:L.mouseDeltaPos,isKeyDown:L.isKeyDown,isKeyPressed:L.isKeyPressed,isKeyPressedRepeat:L.isKeyPressedRepeat,isKeyReleased:L.isKeyReleased,isMouseDown:L.isMouseDown,isMousePressed:L.isMousePressed,isMouseReleased:L.isMouseReleased,isMouseMoved:L.isMouseMoved,isGamepadButtonPressed:L.isGamepadButtonPressed,isGamepadButtonDown:L.isGamepadButtonDown,isGamepadButtonReleased:L.isGamepadButtonReleased,getGamepadStick:L.getGamepadStick,isButtonPressed:L.isButtonPressed,isButtonDown:L.isButtonDown,isButtonReleased:L.isButtonReleased,setButton:L.setButton,getButton:L.getButton,pressButton:L.pressButton,releaseButton:L.releaseButton,getLastInputDeviceType:L.getLastInputDeviceType,charInputted:L.charInputted,loop:Te,wait:Re,play:jr,setVolume:Gr,getVolume:Vr,volume:Yr,burp:Kr,audioCtx:Y.ctx,Line:Z,Rect:_,Circle:$,Ellipse:ee,Point:J,Polygon:te,Vec2:d,Color:s,Mat4:w,Quad:f,RNG:x,rand:E,randi:M,randSeed:b,vec2:c,rgb:r,hsl2rgb:i,quad:p,choose:B,chooseMultiple:k,shuffle:q,chance:S,lerp:l,tween:Oe,easings:Zt,map:h,mapc:u,wave:y,deg2rad:a,rad2deg:o,clamp:t,evaluateQuadratic:ne,evaluateQuadraticFirstDerivative:se,evaluateQuadraticSecondDerivative:re,evaluateBezier:ie,evaluateBezierFirstDerivative:ae,evaluateBezierSecondDerivative:oe,evaluateCatmullRom:le,evaluateCatmullRomFirstDerivative:he,curveLengthApproximation:de,normalizedCurve:ue,hermite:ce,cardinal:fe,catmullRom:pe,bezier:ge,kochanekBartels:me,easingSteps:Me,easingLinear:be,easingCubicBezier:Ee,testLineLine:C,testRectRect:R,testRectLine:I,testRectPoint:P,testCirclePolygon:N,testLinePoint:D,testLineCircle:O,isConvex:Ie,triangulate:Ce,NavMesh:en,drawSprite:Rs,drawText:Is,formatText:ws,drawRect:xs,drawLine:as,drawLines:os,drawTriangle:Es,drawCircle:is,drawEllipse:rs,drawUVQuad:ys,drawPolygon:ss,drawCurve:ls,drawBezier:hs,drawFormattedText:As,drawMasked:ks,drawSubtracted:Cs,pushTransform:ln,popTransform:cn,pushTranslate:on,pushScale:un,pushRotate:dn,pushMatrix:hn,usePostEffect:function(e,t){V.postShader=e,V.postShaderUniform=t??null},makeCanvas:function(e,t){let n=new ds(G,e,t);return{clear:()=>n.clear(),free:()=>n.free(),toDataURL:()=>n.toDataURL(),toImageData:()=>n.toImageData(),width:n.width,height:n.height,draw:e=>{fn(),n.bind(),e(),fn(),n.unbind()},get fb(){return n}}},debug:ye,scene:ei,getSceneName:si,go:ti,onSceneLeave:ni,layers:Zr,getLayers:Wr,setLayers:Qr,getDefaultLayer:Jr,addLevel:zs,getData:function(e,t){try{return JSON.parse(window.localStorage[e])}catch{return t?(Ae(e,t),t):null}},setData:Ae,download:et,downloadJSON:nt,downloadText:tt,downloadBlob:st,plug:xe,ASCII_CHARS:Pe,canvas:L.canvas,addKaboom:zr,LEFT:d.LEFT,RIGHT:d.RIGHT,UP:d.UP,DOWN:d.DOWN,RED:s.RED,GREEN:s.GREEN,BLUE:s.BLUE,YELLOW:s.YELLOW,MAGENTA:s.MAGENTA,CYAN:s.CYAN,WHITE:s.WHITE,BLACK:s.BLACK,quit:function(){z.events.onOnce("frameEnd",(()=>{L.quit(),K.clear(K.COLOR_BUFFER_BIT|K.DEPTH_BUFFER_BIT|K.STENCIL_BUFFER_BIT);let e=K.getParameter(K.MAX_TEXTURE_IMAGE_UNITS);for(let t=0;t<e;t++)K.activeTexture(K.TEXTURE0+t),K.bindTexture(K.TEXTURE_2D,null),K.bindTexture(K.TEXTURE_CUBE_MAP,null);K.bindBuffer(K.ARRAY_BUFFER,null),K.bindBuffer(K.ELEMENT_ARRAY_BUFFER,null),K.bindRenderbuffer(K.RENDERBUFFER,null),K.bindFramebuffer(K.FRAMEBUFFER,null),G.destroy(),H.forEach((e=>e()))}))},KEvent:Qe,KEventHandler:We,KEventController:ze,cancel:()=>Ye};zi.k=_e;let $e=e.plugins;if($e&&$e.forEach(xe),!1!==e.global)for(let e in _e)window[e]=_e[e];return!1!==e.focus&&L.canvas.focus(),_e},Wi=n(72),Ji=n.n(Wi),Zi=n(825),_i=n.n(Zi),$i=n(659),ea=n.n($i),ta=n(56),na=n.n(ta),sa=n(540),ra=n.n(sa),ia=n(113),aa=n.n(ia),oa=n(365),la={};la.styleTagTransform=aa(),la.setAttributes=na(),la.insert=ea().bind(null,"head"),la.domAPI=_i(),la.insertStyleElement=ra();Ji()(oa.A,la);oa.A&&oa.A.locals&&oa.A.locals;let ha=0;class ua{constructor(){this.instanceId="sillytavern-kaplaycanvas-".concat(Math.random().toString(36).substring(2)),this.kaplayRootElement=null,this.k=null}async launch(){ha++;const e=SillyTavern.getContext();let t,n;e.sendSystemMessage("generic",this.instanceId);const s=()=>{var e;const s=document.getElementById("chat");if(!s)return!1;const r=s.querySelector(".last_mes");if(r&&null!==(e=r.querySelector(".mes_text"))&&void 0!==e&&e.textContent.includes(this.instanceId))return t=r,n=t.querySelector(".mes_text"),!0;const i=Array.from(s.querySelectorAll(".mes_text")).find((e=>e.textContent.includes(this.instanceId)));return!!i&&(n=i,t=i.closest(".mes"),!0)};if(!s()&&(await new Promise((e=>setTimeout(e,100))),!s())){console.error("KaplayCanvas: Could not find the chat message for instanceId:",this.instanceId);const t=e.chat.findIndex((e=>e.mes===this.instanceId));return void(-1!==t&&(e.chat.splice(t,1),e.saveChat()))}if(e.chat&&Array.isArray(e.chat)){const t=e.chat.findIndex((e=>e.mes===this.instanceId));-1!==t&&(e.chat[t].mes="[Kaplay Canvas Initialized]")}t.classList.remove("last_mes"),n.innerHTML="",this.kaplayRootElement=document.createElement("div"),this.kaplayRootElement.id="kaplay-root-".concat(this.instanceId),this.kaplayRootElement.style.width="100%",this.kaplayRootElement.style.height="250px",this.kaplayRootElement.style.backgroundColor="#333",n.appendChild(this.kaplayRootElement),n.style.padding="0",n.style.overflow="hidden",setTimeout((()=>{if(!this.kaplayRootElement)return;this.k=Qi({root:this.kaplayRootElement,width:this.kaplayRootElement.clientWidth,height:this.kaplayRootElement.clientHeight,background:[0,0,0,1],crisp:!0}),this.k.loadSprite("backgroundImage","sprites/CAPTURA.PNG");this.k.add([this.k.sprite("backgroundImage"),this.k.pos(0,0),this.k.anchor("topleft"),this.k.z(-1)]);const s=200,r=this.k.add([this.k.rect(32,32),this.k.pos(this.k.width()/2,this.k.height()/2),this.k.anchor("center"),this.k.color(255,0,0),this.k.area(),"player"]);this.k.onKeyDown("left",(()=>{r.move(-200,0)})),this.k.onKeyDown("right",(()=>{r.move(s,0)})),this.k.onKeyDown("up",(()=>{r.move(0,-200)})),this.k.onKeyDown("down",(()=>{r.move(0,s)})),this.k.onUpdate((()=>{this.k.camPos(r.pos)}));this.k.add([this.k.rect(80,30,{radius:5}),this.k.pos(this.k.width()-10,10),this.k.anchor("topright"),this.k.color(200,50,50),this.k.area(),this.k.z(100),"close_kaplay_button"]).add([this.k.text("Close",{size:16}),this.k.anchor("center"),this.k.color(255,255,255)]),this.k.onClick("close_kaplay_button",(()=>{this.destroy(),n.innerHTML="[Kaplay Canvas Closed]",n.style.padding="",t.style.order="";const s=e.chat.findIndex((e=>"[Kaplay Canvas Initialized]"===e.mes||e.mes===this.instanceId));-1!==s&&(e.chat[s].mes="[Kaplay Canvas Closed by user]",e.forceUpdateChat())}))}),50);const r=(2e4+ha).toFixed(0);t.style.order=r;const i=document.getElementById("chat");i&&(i.scrollTop=i.scrollHeight)}destroy(){this.k&&(this.k.quit(),this.k=null),this.kaplayRootElement&&this.kaplayRootElement.parentElement&&this.kaplayRootElement.parentElement.removeChild(this.kaplayRootElement),this.kaplayRootElement=null}}async function da(){return(new ua).launch()}function ca(){const e=document.createElement("div");e.id="kaplay-canvas-launch",e.classList.add("list-group-item","flex-container","flexGap5","interactable"),e.tabIndex=0,e.title="Launch Kaplay Canvas Demo";const t=document.createElement("i");t.classList.add("fa-solid","fa-cubes"),e.appendChild(t);const n=document.createElement("span");n.textContent="Kaplay Canvas",e.appendChild(n);const s=document.getElementById("extensionsMenu");if(!s)return void console.error("KaplayCanvas: Could not find the extensions menu");const r=document.getElementById("chess_wand_container")||s;r.classList.add("interactable"),r.tabIndex=0,r.appendChild(e),e.addEventListener("click",da)}!function(){"complete"===document.readyState||"interactive"===document.readyState?ca():document.addEventListener("DOMContentLoaded",ca);const{eventSource:e,event_types:t}=SillyTavern.getContext();e.makeLast(t.CHAT_CHANGED,(()=>{const{chatMetadata:e}=SillyTavern.getContext();for(const t in e)/sillytavern-kaplaycanvas-[a-z0-9]+$/.test(t)&&(console.log("KaplayCanvas: Removing stuck inject/metadata for",t),delete e[t])}))}()})()})();